<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>ë§µ ì—ë””í„° (ë§ˆì»¤+ì„ )</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
  /* --- ë””ìì¸ ë° í…Œë§ˆ ë³€ìˆ˜ --- */
  :root {
    --bg: #f8fafc; --panel-bg: #ffffff; --text: #0f172a;
    --bd: #e2e8f0; --primary: #0ea5e9; --danger: #ef4444; --success: #10b981;
  }
  * { box-sizing: border-box; }
  body { margin: 0; display: flex; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

  /* ë ˆì´ì•„ì›ƒ */
  .editor-panel { width: 380px; display: flex; flex-direction: column; background: var(--panel-bg); border-right: 1px solid var(--bd); z-index: 20; box-shadow: 4px 0 24px rgba(0,0,0,0.05); }
  .panel-header { padding: 20px; border-bottom: 1px solid var(--bd); font-weight: 800; font-size: 18px; display: flex; align-items: center; gap: 8px; background: #f1f5f9; }
  .panel-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
  .map-container { flex: 1; position: relative; z-index: 10; }
  #map { width: 100%; height: 100%; background: #ddd; cursor: crosshair; }

  /* íƒ­ ë²„íŠ¼ */
  .mode-tabs { display: flex; gap: 8px; margin-bottom: 10px; }
  .tab-btn { flex: 1; padding: 10px; border: 1px solid var(--bd); background: #fff; border-radius: 8px; cursor: pointer; font-weight: 600; color: #64748b; transition: .2s; }
  .tab-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

  /* í¼ ìš”ì†Œ */
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  label { font-size: 13px; font-weight: 600; color: #64748b; }
  input, select { padding: 10px; border: 1px solid var(--bd); border-radius: 8px; font-size: 14px; background: #fff; outline: none; width: 100%; }
  input:focus, select:focus { border-color: var(--primary); }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* ë²„íŠ¼ */
  .btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; width: 100%; transition: .2s; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-success { background: var(--success); color: white; margin-top: auto; }
  .btn-danger { background: #fee2e2; color: var(--danger); }
  .btn-outline { background: #fff; border: 1px solid var(--bd); color: var(--text); }
  .btn:hover { filter: brightness(0.95); }

  /* íŒŒì¼ ë°•ìŠ¤ */
  .file-box { background: #e0f2fe; padding: 12px; border-radius: 8px; border: 1px dashed var(--primary); text-align: center; }

  /* ë¦¬ìŠ¤íŠ¸ */
  .item-list { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; }
  .list-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: white; border: 1px solid var(--bd); border-radius: 8px; }
  .list-info { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
  .tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #555; }

  /* ê·¸ë¦¬ê¸° ìƒíƒœì°½ */
  .drawing-status { display: none; background: #fff7ed; border: 1px solid #fdba74; padding: 10px; border-radius: 8px; font-size: 13px; color: #c2410c; line-height: 1.4; }
  .drawing-status.show { display: block; }

  /* í† ìŠ¤íŠ¸ */
  #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.9); color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 14px; opacity: 0; pointer-events: none; transition: .3s; z-index: 2000; font-weight: 600; }
  #toast.show { opacity: 1; bottom: 50px; }
</style>
</head>
<body>

  <aside class="editor-panel">
    <div class="panel-header">
      <i class="ph-fill ph-pencil-circle" style="font-size:24px; color:var(--primary)"></i> ë§µ ì—ë””í„°
    </div>
    
    <div class="panel-body">
      <div class="file-box">
        <div style="font-size:13px; font-weight:700; color:var(--primary); margin-bottom:4px;">ğŸ“‚ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</div>
        <input type="file" id="fileInput" accept=".json" onchange="loadFile(this)" style="font-size:12px;">
      </div>

      <hr style="border:0; border-top:1px solid var(--bd); margin:0;">

      <div>
        <label style="display:block; margin-bottom:8px;">ì‘ì—… ëª¨ë“œ</label>
        <div class="mode-tabs">
          <button class="tab-btn active" onclick="setMode('marker')" id="tabMarker"><i class="ph-bold ph-map-pin"></i> ë§ˆì»¤(ì )</button>
          <button class="tab-btn" onclick="setMode('line')" id="tabLine"><i class="ph-bold ph-bezier-curve"></i> ì„ (Line)</button>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>ì´ë¦„ (Name)</label>
          <input type="text" id="inpName" placeholder="ì§€ì ëª… ì…ë ¥">
        </div>
        <div class="form-group">
          <label>ìœ í˜• (Type) - ìƒ‰ìƒ ìë™ ì§€ì •</label>
          <select id="inpType">
            <option value="station">station (ì¸¡ì •ì†Œ)</option>
            <option value="small">small (ì†Œê·œëª¨)</option>
            <option value="stream">stream (í•˜ì²œ/ë¬¼ê¸¸)</option>
            <option value="default">ê¸°íƒ€</option>
          </select>
        </div>
      </div>

      <div id="markerInputs" class="row">
        <div class="form-group">
          <label>ìœ„ë„</label>
          <input type="number" id="inpLat" placeholder="ì§€ë„ í´ë¦­" step="any">
        </div>
        <div class="form-group">
          <label>ê²½ë„</label>
          <input type="number" id="inpLng" placeholder="ì§€ë„ í´ë¦­" step="any">
        </div>
      </div>

      <div id="lineInputs" style="display:none;">
        <div class="row">
            <div class="form-group" style="flex:1;">
                <label>ì„  ë‘ê»˜ (Weight)</label>
                <input type="number" id="inpWeight" value="4" min="1" max="10">
            </div>
            <div class="form-group" style="flex:1;">
                </div>
        </div>

        <div class="drawing-status show">
          <div>ğŸ“ ì§€ë„ì— ì ì„ ì°ì–´ ì„ ì„ ì—°ê²°í•˜ì„¸ìš”.</div>
          <div style="font-weight:700; margin-top:4px;">í˜„ì¬ ì  ê°œìˆ˜: <span id="pointCount">0</span>ê°œ</div>
        </div>
        <button class="btn btn-outline" style="margin-top:8px;" onclick="undoPoint()">
          <i class="ph-bold ph-arrow-u-up-left"></i> ë§ˆì§€ë§‰ ì  ì·¨ì†Œ
        </button>
      </div>

      <button class="btn btn-primary" onclick="addItem()">
        <i class="ph-bold ph-plus"></i> <span id="addBtnText">ë§ˆì»¤ ì¶”ê°€í•˜ê¸°</span>
      </button>

      <div style="margin-top:auto;">
        <div style="font-size:12px; font-weight:700; color:#64748b; margin-bottom:8px;">í˜„ì¬ ë°ì´í„° (<span id="count">0</span>ê°œ)</div>
        <div id="addedList" class="item-list"></div>
      </div>
    </div>

    <div style="padding:20px; border-top:1px solid var(--bd); background:#f8fafc;">
      <button class="btn btn-success" onclick="downloadJson()">
        <i class="ph-bold ph-download-simple"></i> íŒŒì¼ ë‹¤ìš´ë¡œë“œ (facilities.json)
      </button>
    </div>
  </aside>

  <div class="map-container">
    <div id="map"></div>
  </div>

  <div id="toast">ë©”ì‹œì§€</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* 1. ìƒíƒœ ë³€ìˆ˜ */
    let allData = [];
    let currentMode = 'marker';
    let tempMarker = null;
    let currentPath = [];
    let tempPolyline = null;

    /* 2. ì§€ë„ ì´ˆê¸°í™” */
    const map = L.map('map', { zoomControl: false }).setView([37.5, 127.5], 9);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);
    const layerGroup = L.layerGroup().addTo(map);

    /* 3. ìë™ ìƒ‰ìƒ ë§¤í•‘ */
    const typeColors = {
      'station': '#0033cc',
      'small': '#0ea5e9',
      'stream': '#3399ff',
      'default': '#64748b'
    };

    /* 4. ëª¨ë“œ ì „í™˜ */
    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(mode === 'marker' ? 'tabMarker' : 'tabLine').classList.add('active');
      document.getElementById('markerInputs').style.display = mode === 'marker' ? 'grid' : 'none';
      document.getElementById('lineInputs').style.display = mode === 'line' ? 'block' : 'none';
      document.getElementById('addBtnText').textContent = mode === 'marker' ? 'ë§ˆì»¤ ì¶”ê°€í•˜ê¸°' : 'ì„  ê·¸ë¦¬ê¸° ì™„ë£Œ (ì¶”ê°€)';
      resetTempDrawings();
    }
    setMode('marker');


    function resetTempDrawings() {
      if(tempMarker) map.removeLayer(tempMarker);
      tempMarker = null;
      document.getElementById('inpLat').value = '';
      document.getElementById('inpLng').value = '';

      if(tempPolyline) map.removeLayer(tempPolyline);
      tempPolyline = null;
      currentPath = [];
      updatePointCount();
    }

    /* 5. ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ */
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;

      if (currentMode === 'marker') {
        document.getElementById('inpLat').value = lat.toFixed(6);
        document.getElementById('inpLng').value = lng.toFixed(6);

        if(tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
        
        tempMarker.on('dragend', function(ev) {
          const pos = ev.target.getLatLng();
          document.getElementById('inpLat').value = pos.lat.toFixed(6);
          document.getElementById('inpLng').value = pos.lng.toFixed(6);
        });

      } else {
        currentPath.push([lat, lng]);
        drawTempPolyline();
        updatePointCount();
      }
    });

    function drawTempPolyline() {
      if(tempPolyline) map.removeLayer(tempPolyline);
      if(currentPath.length > 0) {
        tempPolyline = L.polyline(currentPath, { color: '#ef4444', dashArray: '5, 10', weight: 4 }).addTo(map);
      }
    }

    function undoPoint() {
      if(currentPath.length > 0) {
        currentPath.pop();
        drawTempPolyline();
        updatePointCount();
        toast('ë§ˆì§€ë§‰ ì  ì·¨ì†Œë¨');
      }
    }
    
    function updatePointCount() {
      document.getElementById('pointCount').textContent = currentPath.length;
    }

    /* 6. ë°ì´í„° ì¶”ê°€ */
    function addItem() {
      const name = document.getElementById('inpName').value;
      const type = document.getElementById('inpType').value;
      const color = typeColors[type] || typeColors.default;

      if (!name) return toast('âš ï¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

      let newItem = null;

      if (currentMode === 'marker') {
        const lat = parseFloat(document.getElementById('inpLat').value);
        const lng = parseFloat(document.getElementById('inpLng').value);
        if (isNaN(lat) || isNaN(lng)) return toast('âš ï¸ ì§€ë„ ìœ„ì¹˜ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.');
        
        newItem = { name, lat, lng, type, color };

      } else {
        const weight = parseInt(document.getElementById('inpWeight').value) || 4; // ì„  ë‘ê»˜ ì¶”ê°€
        if (currentPath.length < 2) return toast('âš ï¸ ì„ ì€ ìµœì†Œ 2ê°œ ì´ìƒì˜ ì ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        
        newItem = { name, path: [...currentPath], type, color, weight }; // weight ì†ì„± í¬í•¨
      }

      allData.push(newItem);
      
      renderMap();
      renderList();
      resetTempDrawings();
      document.getElementById('inpName').value = '';
      
      toast('âœ… ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    /* 7. ì§€ë„ ë Œë”ë§ (ë§ˆì»¤ + ì„ ) */
    function renderMap() {
      layerGroup.clearLayers();
      
      allData.forEach(d => {
        if (d.path) {
          // [ì„  ë Œë”ë§]: d.weight ì†ì„± ì‚¬ìš©
          L.polyline(d.path, { 
            color: d.color, 
            weight: d.weight || 4, // ì €ì¥ëœ weight ì‚¬ìš©, ì—†ìœ¼ë©´ 4
            opacity: 0.8 
          })
           .bindPopup(`<b>${d.name}</b><br>ì„  (Line)`)
           .addTo(layerGroup);
        } else {
          // [ë§ˆì»¤ ë Œë”ë§]
          L.circleMarker([d.lat, d.lng], {
            radius: 6, color: '#fff', weight: 1, 
            fillColor: d.color || '#999', fillOpacity: 0.8
          }).bindPopup(`<b>${d.name}</b><br>${d.type}`).addTo(layerGroup);
        }
      });
    }

    /* 8. ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ */
    function renderList() {
      const listEl = document.getElementById('addedList');
      document.getElementById('count').textContent = allData.length;
      
      const reversed = [...allData].reverse(); 
      
      listEl.innerHTML = reversed.map((item, idx) => {
        const realIdx = allData.length - 1 - idx;
        const isLine = !!item.path;
        const icon = isLine ? 'ph-bezier-curve' : 'ph-map-pin';
        const weightTxt = isLine ? `(ë‘ê»˜ ${item.weight || 4})` : '';
        const typeTxt = isLine ? `Line (${item.path.length}ì ) ${weightTxt}` : 'Point';
        
        const moveLat = isLine ? item.path[0][0] : item.lat;
        const moveLng = isLine ? item.path[0][1] : item.lng;

        return `
          <div class="list-row">
            <div onclick="flyTo(${moveLat}, ${moveLng})" style="cursor:pointer; flex:1">
              <div class="list-info">
                <i class="ph-fill ${icon}" style="color:${item.color}"></i> ${item.name}
              </div>
              <div class="list-sub" style="margin-top:2px; margin-left:20px;">
                <span class="tag">${typeTxt}</span> ${item.type}
              </div>
            </div>
            <button class="btn btn-danger" style="width:auto; padding:6px 10px; height:30px; font-size:12px;" onclick="removeItem(${realIdx})">ì‚­ì œ</button>
          </div>
        `;
      }).join('');
    }

    function removeItem(index) {
      if(confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        allData.splice(index, 1);
        renderMap();
        renderList();
        toast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }
    }

    /* 9. íŒŒì¼ ì…ì¶œë ¥ (ë¡œë“œ ë° ë‹¤ìš´ë¡œë“œ) */
    function loadFile(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          allData = JSON.parse(e.target.result);
          renderMap();
          renderList();
          toast(`ë°ì´í„° ${allData.length}ê±´ ë¡œë“œ ì™„ë£Œ`);
        } catch (err) { alert('JSON íŒŒì¼ ì˜¤ë¥˜'); }
      };
      reader.readAsText(file);
    }

    function downloadJson() {
      if (allData.length === 0) return toast('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
      const a = document.createElement('a');
      a.href = dataStr;
      a.download = "facilities.json";
      a.click();
      toast('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
    }

    function flyTo(lat, lng) { map.flyTo([lat, lng], 14, { duration: 0.5 }); }

    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg; el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }
    
    // ì´ˆê¸° ë¡œë”© ì‹œ facilities.json ìë™ fetch ì‹œë„ (ë¡œì»¬ ì„œë²„ ì‚¬ìš© ì‹œ)
    fetch('facilities.json').then(r=>r.json()).then(d=>{
        allData = d; renderMap(); renderList();
    }).catch(e=>{ /* íŒŒì¼:// í”„ë¡œí† ì½œì¸ ê²½ìš° ë¬´ì‹œ */ });

  </script>
</body>
</html>