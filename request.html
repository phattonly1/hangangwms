<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>요청 현황</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<style>
:root {
  --bd:#e5e7eb; --muted:#6b7280; --ink:#0b2239;
  --hdrH:60px; --card:#fff; --btn:#2563eb;
}
*{box-sizing:border-box;}
html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Pretendard;}
body{background:#f4f6fb;color:var(--ink);}
header{display:flex;align-items:center;gap:10px;background:#fff;border-bottom:1px solid #ddd;
  padding:10px 16px;position:sticky;top:0;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,.05);}
header img{width:44px;height:44px;object-fit:contain;}
header h1{margin:0;font-size:1.5rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
main{max-width:1100px;margin:0 auto;padding:20px;}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 16px;}
.btn{padding:10px 14px;border-radius:8px;border:0;font-weight:700;cursor:pointer;box-shadow:0 2px 4px rgba(0,0,0,.1);}
.btn.primary{background:var(--btn);color:#fff;}
.btn.ghost{background:#fff;color:var(--btn);border:1px solid #93c5fd;}
.btn.danger{background:#dc2626;color:#fff;}
.table-wrap{background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:auto;box-shadow:0 3px 12px rgba(0,0,0,.06);}
table{width:100%;border-collapse:collapse;font-size:15px;}
th,td{padding:12px;text-align:center;border-bottom:1px solid var(--bd);}
th{background:#eef2ff;font-weight:700;color:#1e3a8a;}
tr:hover{background:#fafafa;}
.status-badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:13px;font-weight:600;}
.status-badge.pending{background:#fff7ed;color:#9a3412;}
.status-badge.prog{background:#eef2ff;color:#3730a3;}
.status-badge.done{background:#ecfdf5;color:#065f46;}
.muted{color:var(--muted);font-size:13px;}
.toast{position:fixed;right:16px;bottom:16px;background:rgba(0,0,0,.85);color:#fff;
  padding:10px 12px;border-radius:10px;opacity:0;pointer-events:none;transition:.25s;z-index:3000;}
.toast.show{opacity:1;}
.saving{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:3000;}
.saving.hidden{display:none;}
.saving .box{background:#fff;padding:18px 20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);font-weight:700;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);align-items:center;justify-content:center;z-index:3000;}
.modal.show{display:flex;}
.modal .panel{background:#fff;padding:20px;border-radius:12px;width:95%;max-width:420px;}
.field{display:flex;flex-direction:column;gap:4px;margin-bottom:10px;}
.actions{display:flex;justify-content:flex-end;gap:10px;}
.pagination{display:flex;justify-content:flex-end;align-items:center;gap:8px;margin:10px 0;}
.page-btn{padding:6px 10px;border:1px solid var(--bd);border-radius:8px;background:#fff;cursor:pointer;}
</style>
</head>
<body>
<header>
  <img src="./assets/gongdan-mark.png" alt="공단 마크" />
  <h1>요청 현황</h1>
</header>

<main>
  <div class="toolbar">
    <button class="btn primary" id="btnOpenAdd">추가하기</button>
    <button class="btn ghost" id="btnReload">새로고침</button>
    <button class="btn ghost" id="btnCSV">CSV 내보내기</button>
    <span class="muted" id="summary">총 0건</span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th data-k="요청일">요청일</th>
          <th data-k="요청자">요청자</th>
          <th data-k="요청물품">요청물품</th>
          <th data-k="개수">개수</th>
          <th data-k="진행사항">진행상태</th>
          <th>빠른변경</th>
          <th>수정</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="8">불러오는 중...</td></tr></tbody>
    </table>
  </div>

  <div class="pagination">
    <button class="page-btn" id="prev">이전</button>
    <span id="pageinfo" class="muted">0 / 0</span>
    <button class="page-btn" id="next">다음</button>
  </div>
</main>

<!-- modal -->
<div class="modal" id="modal">
  <div class="panel">
    <h3 id="modalTitle">요청 추가</h3>
    <form id="postForm" method="POST" target="hidden_iframe">
      <input type="hidden" name="op" value="add">
      <input type="hidden" name="id" value="">
      <div class="field">
        <label>요청일</label><input type="date" name="date" required>
      </div>
      <div class="field">
        <label>요청자</label><input type="text" name="who" required>
      </div>
      <div class="field">
        <label>요청물품</label><input type="text" name="item" required>
      </div>
      <div class="field">
        <label>개수</label><input type="number" name="qty" min="1" required>
      </div>
      <div class="field">
        <label>진행상태</label>
        <select name="status" required>
          <option>요청</option><option>진행중</option><option>완료</option>
        </select>
      </div>
      <div class="actions">
        <button type="button" class="btn ghost" id="btnCancel">취소</button>
        <button type="submit" class="btn primary" id="btnSubmit">저장</button>
      </div>
    </form>
  </div>
</div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>
<div id="savingPopup" class="saving hidden"><div class="box">요청을 저장 중입니다…</div></div>
<div id="toast" class="toast"></div>

<script>
const SHEET_ID="13-0Qp2ImIIURJqv-YbklEVbsNYLPz_akDRwO2lDeEvM";
const GID="0";
const APPS_SCRIPT_EXEC="https://script.google.com/macros/s/AKfycbyxNNfPgvSeL0o9lSwFRlS7YRrKSt3Qv4baQUOy2oV1M5WkvBu-ciyTKQZuf9p6rPmsDg/exec";
let raw=[],view=[];let page=1,pageSize=10,sortKey="요청일",sortDir="desc",isSubmitting=false;
const $=s=>document.querySelector(s);
const toast=t=>{const el=$("#toast");el.textContent=t;el.classList.add("show");setTimeout(()=>el.classList.remove("show"),1500);};
function badge(v){const t=(v||"").trim();if(t==="완료")return'<span class="status-badge done">완료</span>';if(t==="요청")return'<span class="status-badge pending">요청</span>';if(t==="진행중")return'<span class="status-badge prog">진행중</span>';return'';}
function toDateString(d){try{const dt=new Date(d);return isNaN(dt)?"":dt.toISOString().split("T")[0];}catch{return d;}}
function load(){
  const old=document.getElementById("gviz");if(old)old.remove();
  $("#tbody").innerHTML='<tr><td colspan="8">불러오는 중...</td></tr>';
  const s=document.createElement("script");
  s.id="gviz";
  s.src=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json;responseHandler:renderGViz&_=${Date.now()}`;
  document.body.appendChild(s);
}
window.renderGViz=function(resp){
  try{
    const table=resp.table;
    const cols=table.cols.map(c=>c.label);
    const rows=(table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:''));
    const idx={date:cols.indexOf("요청일"),who:cols.indexOf("요청자"),item:cols.indexOf("요청물품"),qty:cols.indexOf("개수"),stat:cols.indexOf("진행사항")};
    raw=rows.map(r=>({
      요청일:toDateString(r[idx.date]),
      요청자:r[idx.who],
      요청물품:r[idx.item],
      개수:r[idx.qty],
      진행사항:r[idx.stat]
    })).filter(r=>r.요청자||r.요청물품);
    applyAndRender();
  }catch(e){toast("표시 실패: "+e.message);}
};
function applyAndRender(){
  view=[...raw];
  view.sort((a,b)=>sortDir==='asc'?(a[sortKey]>b[sortKey]?1:-1):(a[sortKey]<b[sortKey]?1:-1));
  const total=Math.max(1,Math.ceil(view.length/pageSize));if(page>total)page=total;
  const slice=view.slice((page-1)*pageSize,page*pageSize);
  $("#pageinfo").textContent=`${page} / ${total}`;
  $("#summary").textContent=`총 ${view.length}건`;
  const tb=$("#tbody");
  if(!slice.length){tb.innerHTML='<tr><td colspan="8">데이터 없음</td></tr>';return;}
  tb.innerHTML=slice.map(r=>`
    <tr>
      <td>${r.요청일}</td>
      <td>${r.요청자}</td>
      <td>${r.요청물품}</td>
      <td>${r.개수}</td>
      <td>${badge(r.진행사항)}</td>
      <td>
        <select class="select" data-item="${r.요청물품}">
          <option ${r.진행사항==='요청'?'selected':''}>요청</option>
          <option ${r.진행사항==='진행중'?'selected':''}>진행중</option>
          <option ${r.진행사항==='완료'?'selected':''}>완료</option>
        </select>
        <button class="btn ghost" style="padding:6px 10px">변경</button>
      </td>
      <td><button class="btn" style="padding:6px 10px">수정</button></td>
      <td><button class="btn danger" style="padding:6px 10px">삭제</button></td>
    </tr>`).join("");
}
$("#btnOpenAdd").onclick=()=>$("#modal").classList.add("show");
$("#btnCancel").onclick=()=>$("#modal").classList.remove("show");
$("#btnReload").onclick=load;
$("#prev").onclick=()=>{if(page>1){page--;applyAndRender();}};
$("#next").onclick=()=>{page++;applyAndRender();};
load();
</script>
</body>
</html>
