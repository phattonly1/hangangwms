<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>요청 현황</title>
<style>
:root{--ink:#0b2239;--muted:#64748b;--bd:#e5e7eb;--panel:#fff;--accent:#2563eb;--ok:#065f46;--warn:#9a3412;--mid:#3730a3;--ctl-h:38px;--radius:10px}
*{box-sizing:border-box} html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Pretendard; color:var(--ink); background:#f5f7fb}
.appbar{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#fff;border-bottom:1px solid #e6e8ee;position:sticky;top:0;z-index:10}
.appbar h1{margin:0;font-size:1.2rem;font-weight:800}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:0 0 12px}
.btn{appearance:none;border:1px solid var(--bd);border-radius:10px;padding:0 12px;background:#fff;font-weight:800;cursor:pointer;height:var(--ctl-h);display:inline-flex;align-items:center}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.danger{background:#dc2626;color:#fff;border-color:#dc2626}
.select,.input,textarea{border:1px solid var(--bd);border-radius:10px;background:#fff}
.select,.input{height:var(--ctl-h);padding:0 10px}
.input.search{width:280px;max-width:100%}
.chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--bd);background:#fff;font-weight:800;font-size:13px}
.chip .dot{width:8px;height:8px;border-radius:50%}
.chip.req .dot{background:#fb923c}.chip.prog .dot{background:#6366f1}.chip.done .dot{background:#10b981}
.card{background:#fff;border:1px solid var(--bd);border-radius:14px;overflow:auto}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid var(--bd);vertical-align:middle}
th{background:#f1f5ff;color:#1e3a8a;font-weight:800;position:sticky;top:0;z-index:1;text-align:center}
td{text-align:center}
.cell-item{white-space:normal;word-break:keep-all;line-height:1.4;text-align:left}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:13px;font-weight:700}
.badge.done{background:#ecfdf5;color:#065f46}
.badge.req{background:#fff7ed;color:#9a3412}
.badge.prog{background:#eef2ff;color:#3730a3}
.pagination{display:flex;gap:8px;justify-content:flex-end;align-items:center;margin:12px 0}
.page-btn{padding:0 12px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer;height:var(--ctl-h);display:inline-flex;align-items:center}
.toast{position:fixed;right:16px;bottom:16px;background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s;z-index:150}
.toast.show{opacity:1}
.muted{color:#64748b}

/* 아바타: 2배(88x88) */
.avatar{width:88px;height:88px;border-radius:12px;object-fit:cover;background:#eef2f7;border:1px solid var(--bd);cursor:pointer}

/* 작업 액션 */
.actions{display:inline-flex;align-items:center;gap:6px;white-space:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
.icon-btn{appearance:none;border:1px solid var(--bd);background:#fff;cursor:pointer;width:34px;height:34px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center}
.icon-btn.danger{background:#dc2626;border-color:#dc2626}.icon-btn.danger svg{stroke:#fff}
.icon-btn svg{width:18px;height:18px;stroke:#334155;stroke-width:2;fill:none}
.actions .select{height:34px;padding:0 8px}

/* 모달들: hidden 으로 제어 */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.38);display:flex;align-items:center;justify-content:center;z-index:100}
.modal[hidden]{display:none!important}
.sheet{background:#fff;border-radius:16px;width:min(92vw,760px);box-shadow:0 24px 80px rgba(0,0,0,.3);overflow:hidden}
.sheet-head{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--bd);background:linear-gradient(180deg,#f8fbff,#ffffff)}
.sheet-body{padding:16px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
.sheet-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--bd);background:#fafcff}
/* 작은 모달 */
.sheet.small{width:min(92vw,420px)}

/* 이미지 라이트박스 */
.lb-img{max-width:min(92vw,900px);max-height:80vh;border-radius:12px;border:1px solid var(--bd);background:#fff}
</style>
</head>
<body>
  <header class="appbar"><h1>요청 현황</h1></header>

  <main class="wrap">
    <div class="toolbar" role="region" aria-label="필터">
      <input id="q" class="input search" type="search" placeholder="검색: 물품명, 기기, 요청자 (⌘/Ctrl+K)" aria-label="검색" />
      <select id="fStatus" class="select" aria-label="상태 필터">
        <option value="">전체 상태</option><option value="요청">요청</option><option value="진행중">진행중</option><option value="완료">완료</option>
      </select>
      <select id="fDevice" class="select" aria-label="기기 필터"><option value="">전체 기기</option></select>
      <button class="btn" id="btnReload">새로고침</button>
      <button class="btn" id="btnCSV">CSV 내보내기</button>
      <button class="btn primary" id="btnOpenAdd" style="margin-left:auto">리스트 추가</button>
      <!-- ❓ 도움말 아이콘 -->
      <button class="icon-btn" id="btnHelp" aria-label="도움말" title="도움말 열기">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 18v-2m0-2a3 3 0 10-3-3"/><circle cx="12" cy="12" r="9"/></svg>
      </button>
    </div>

    <div class="chips" id="sumChips" style="margin-bottom:10px">
      <span class="chip req"><span class="dot"></span>요청 <b id="cReq">0</b></span>
      <span class="chip prog"><span class="dot"></span>진행중 <b id="cProg">0</b></span>
      <span class="chip done"><span class="dot"></span>완료 <b id="cDone">0</b></span>
      <span class="muted" id="summary">총 0건</span>
    </div>

    <div class="card" role="region" aria-label="요청 현황 표">
      <table>
        <colgroup>
          <col style="width:104px"><!-- 88 + padding -->
          <col style="width:34%">
          <col style="width:20%">
          <col style="width:12%">
          <col style="width:14%">
          <col style="width:20%">
        </colgroup>
        <thead>
          <tr>
            <th>사진</th>
            <th data-k="물품명">물품명</th>
            <th data-k="기기">기기</th>
            <th data-k="재고량">재고량</th>
            <th data-k="요청상태">요청상태</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="6">불러오는 중…</td></tr></tbody>
      </table>
    </div>

    <div class="pagination">
      <button class="page-btn" id="prev">이전</button>
      <span id="pageinfo" class="muted">0 / 0</span>
      <button class="page-btn" id="next">다음</button>
      <select id="pageSize" class="select" title="페이지 크기"><option>10</option><option selected>20</option><option>50</option><option>100</option></select>
    </div>
  </main>

  <!-- 큰 모달: 추가/수정 -->
  <div class="modal" id="modal" aria-modal="true" hidden>
    <div class="sheet">
      <div class="sheet-head"><h3 id="modalTitle" style="margin:0">리스트 추가</h3></div>
      <div class="sheet-body">
        <!-- 사진 미리보기 + 사진 열기/변경 -->
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px">
          <img id="modalPreview" src="" alt="미리보기" style="width:120px;height:120px;border-radius:14px;object-fit:cover;border:1px solid var(--bd);cursor:pointer" />
          <div class="actions">
            <button type="button" class="btn" id="btnPhotoOpen">사진 열기</button>
            <button type="button" class="btn" id="btnPhotoChange">사진 변경</button>
          </div>
        </div>

        <form id="postForm" method="POST" target="hidden_iframe">
          <input type="hidden" name="op" value="add" />
          <input type="hidden" name="id" value="" />
          <div class="form-grid" id="basicFields">
            <div class="field"><label for="f_item">물품명</label><input id="f_item" class="input" name="item" required /></div>
            <div class="field"><label for="f_device">기기</label><input id="f_device" class="input" name="device" required /></div>
            <div class="field"><label for="f_stock">재고량</label><input id="f_stock" class="input" type="number" name="stock" min="0" step="1" required /></div>
            <div class="field"><label for="f_status">요청상태</label>
              <select id="f_status" class="select" name="status"><option>요청</option><option>진행중</option><option>완료</option></select>
            </div>
          </div>
          <div class="form-grid">
            <div class="field"><label for="f_who">요청자</label><input id="f_who" class="input" name="who" placeholder="비워도 저장됩니다" /></div>
            <div class="field"><label for="f_date">요청일</label><input id="f_date" class="input" type="date" name="date" required /></div>
            <div class="field"><label for="f_qty">개수</label><input id="f_qty" class="input" type="number" name="qty" min="0" step="1" value="0" required /></div>
            <div class="field"><label for="f_note">비고</label><textarea id="f_note" class="input" name="note" rows="3" placeholder="예: img:https://.../photo.jpg"></textarea></div>
          </div>
          <div class="sheet-foot">
            <button type="button" class="btn" id="btnCancel">취소</button>
            <button type="submit" class="btn primary" id="btnSubmit">저장</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 작은 모달: 요청자/개수 -->
  <div class="modal" id="miniModal" aria-modal="true" hidden>
    <div class="sheet small">
      <div class="sheet-head"><h3 style="margin:0">요청 정보 입력</h3></div>
      <div class="sheet-body">
        <div class="form-grid" style="grid-template-columns:1fr">
          <div class="field"><label for="m_who">요청자</label><input id="m_who" class="input" placeholder="요청자" /></div>
          <div class="field"><label for="m_qty">개수</label><input id="m_qty" class="input" type="number" min="1" step="1" value="1" /></div>
        </div>
      </div>
      <div class="sheet-foot">
        <button class="btn" id="miniCancel">취소</button>
        <button class="btn primary" id="miniOK">확인</button>
      </div>
    </div>
  </div>

  <!-- 이미지 라이트박스 -->
  <div class="modal" id="imgModal" aria-modal="true" hidden>
    <img id="imgLarge" class="lb-img" alt="확대 이미지" />
  </div>

  <!-- 도움말 모달 -->
  <div class="modal" id="helpModal" aria-modal="true" hidden>
    <div class="sheet small" role="dialog" aria-labelledby="helpTitle">
      <div class="sheet-head">
        <h3 id="helpTitle" style="margin:0">사용법 안내</h3>
      </div>
      <div class="sheet-body" style="font-size:14px; line-height:1.6">
        <ol style="margin:0; padding-left:18px">
          <li style="margin-bottom:8px">
            <b>리스트 추가</b>
            <ol style="margin:6px 0 0 0; padding-left:18px">
              <li>우측 상단 <b>‘리스트 추가’</b> 버튼을 누릅니다.</li>
              <li><b>물품명, 기기, 재고량</b>을 입력하고 <b>저장</b>합니다.<br>
                  <span style="color:#64748b">요청자·개수는 비워도 저장됩니다(나중에 입력 가능).</span></li>
            </ol>
          </li>

          <li style="margin-bottom:8px">
            <b>요청 입력/변경</b>
            <ol style="margin:6px 0 0 0; padding-left:18px">
              <li>목록의 <b>요청상태</b> 드롭다운에서 <b>‘요청’</b>을 선택하면 팝업이 뜹니다.</li>
              <li><b>요청자</b>와 <b>개수</b>를 입력하면 <code>홍길동(2)</code> 형식으로 저장되고,<br>
                  배지에 <b>요청(홍길동)</b>처럼 표시됩니다.</li>
            </ol>
          </li>

          <li style="margin-bottom:8px">
            <b>추가요청(여러 명 누적)</b>
            <ol style="margin:6px 0 0 0; padding-left:18px">
              <li>작업 영역의 <b>➕ 아이콘(추가요청)</b>을 누릅니다.</li>
              <li>새 <b>요청자·개수</b>를 입력하면 기존 뒤에 이어 붙고, <b>개수는 합산</b>됩니다.</li>
            </ol>
          </li>

          <li style="margin-bottom:0">
            <b>사진 보기/변경</b>
            <ol style="margin:6px 0 0 0; padding-left:18px">
              <li>썸네일(88×88)을 클릭하면 <b>확대</b>해서 볼 수 있습니다.</li>
              <li><b>수정</b>을 누르면 모달 상단에서 <b>사진 열기/변경</b>이 가능합니다.</li>
            </ol>
          </li>
        </ol>
      </div>
      <div class="sheet-foot">
        <button class="btn" id="btnHelpClose">닫기</button>
      </div>
    </div>
  </div>

  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>
  <div id="toast" class="toast">처리되었습니다</div>

<script>
/* ===== 설정 ===== */
const APPS_SCRIPT_EXEC = "https://script.google.com/macros/s/AKfycbzookadn2uRywLFtWdy03vCzLQDI3slaMU3ceR-7cozgkMb-bify9-XC6Uw0XEKNFYi/exec";
/* 깃허브 에셋(사진) */
const IMG_BASE = "https://raw.githubusercontent.com/your-org/your-repo/main/assets/requests/"; // ← 경로 수정
const IMG_EXT  = ".jpg";

/* ===== 상태/UI 저장 ===== */
let allRows=[], page=1, pageSize=20, sortKey="물품명", sortDir="asc";
let q="", fStatus="", fDevice="";
const $=s=>document.querySelector(s);
const $$=(s,el=document)=>Array.from((el||document).querySelectorAll(s));
const toast=t=>{const el=$('#toast'); el.textContent=t; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1200);};
const KEY='request.ui.v7';
function saveUI(){ localStorage.setItem(KEY, JSON.stringify({q,fStatus,fDevice,sortKey,sortDir,pageSize})); }
function loadUI(){ try{ const s=JSON.parse(localStorage.getItem(KEY)||"{}"); q=s.q||""; fStatus=s.fStatus||""; fDevice=s.fDevice||""; sortKey=s.sortKey||"물품명"; sortDir=s.sortDir||"asc"; pageSize=+s.pageSize||20; }catch{} }

/* ===== 유틸 ===== */
function todayYMD(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
const FALLBACK_SVG = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="88" height="88" viewBox="0 0 24 24"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#93c5fd"/><stop offset="1" stop-color="#60a5fa"/></linearGradient></defs><rect x="2" y="4" width="20" height="16" rx="3" fill="url(#g)" /><path d="M3 9h18M8 4v5m8-5v5" stroke="#1e3a8a" stroke-width="1.5" fill="none"/></svg>`);
function parseImgFromNote(note){ const t=String(note||''); const m=t.match(/img\s*:\s*(\S+)/i); return m ? m[1] : null; }
function imgUrlForRow(row){ const fromNote=parseImgFromNote(row.비고); if(fromNote) return fromNote; const id=(row.ID||'').toString().trim(); return id? (IMG_BASE+encodeURIComponent(id)+IMG_EXT) : null; }

/* 요청자 파싱/표시/합계 */
function parseWhoList(whoStr){
  const out=[]; const s=String(whoStr||'').trim();
  if(!s) return out;
  s.split(',').map(x=>x.trim()).filter(Boolean).forEach(tok=>{
    const m = tok.match(/^(.+?)\s*\(\s*(\d+)\s*\)$/); // 이름(숫자)
    if(m){ out.push({name:m[1].trim(), qty:parseInt(m[2],10)||0}); }
    else if(tok){ out.push({name:tok, qty:0}); }
  });
  return out;
}
function namesOnly(whoStr){ return parseWhoList(whoStr).map(x=>x.name).filter(Boolean); }
function totalQtyFromWho(whoStr){ return parseWhoList(whoStr).reduce((s,x)=>s+(parseInt(x.qty,10)||0),0); }

/* === 읽기(JSONP) === */
function load(){
  const tbody=$('#tbody'); tbody.innerHTML='<tr><td colspan="6">불러오는 중…</td></tr>';
  const cb='render_'+Date.now();
  window[cb]=(res)=>{ delete window[cb]; if(!res?.ok){ tbody.innerHTML='<tr><td colspan="6">로드 실패(op=read 응답 오류)</td></tr>'; return; }
    allRows=Array.isArray(res.rows)?res.rows:[]; buildDeviceFilter(); applyAndRender(); };
  const s=document.createElement('script'); s.src=APPS_SCRIPT_EXEC+'?op=read&cb='+cb;
  s.onerror=()=>{ tbody.innerHTML='<tr><td colspan="6">읽기 실패(웹앱 URL/권한/헤더 확인)</td></tr>'; };
  document.body.appendChild(s);
}

/* === 필터 === */
function buildDeviceFilter(){
  const set=new Set(allRows.map(r=>String(r.기기||'').trim()).filter(Boolean));
  const cur=$('#fDevice').value || fDevice;
  $('#fDevice').innerHTML='<option value="">전체 기기</option>'+[...set].sort((a,b)=>a.localeCompare(b,'ko')).map(d=>`<option ${d===cur?'selected':''}>${d}</option>`).join('');
}
function matches(r){
  const s=x=>String(x||'').toLowerCase();
  const okQ=!q || [r.물품명,r.기기,r.요청자].some(v=>s(v).includes(q.toLowerCase()));
  const okS=!fStatus || (String(r.요청상태||'')===fStatus);
  const okD=!fDevice || (String(r.기기||'')===fDevice);
  return okQ && okS && okD;
}

/* === 렌더 === */
function badgeWithReq(status, who){
  const t=(status||'').trim();
  if(t==='완료') return '<span class="badge done">완료</span>';
  if(t==='진행중') return '<span class="badge prog">진행중</span>';
  if(t==='요청'){
    const names = namesOnly(who);
    if(names.length>0) return `<span class="badge req">요청(${names.join(', ')})</span>`;
    return '<span class="badge req">요청</span>';
  }
  return t||'';
}

function applyAndRender(){
  const filtered = allRows.filter(matches).sort((a,b)=>{
    let A=(a[sortKey]??'').toString(), B=(b[sortKey]??'').toString();
    if(sortKey==='재고량'){ A=+A||0; B=+B||0; return sortDir==='asc'?(A-B):(B-A); }
    return sortDir==='asc'? A.localeCompare(B,'ko'): B.localeCompare(A,'ko');
  });
  const cReq=filtered.filter(r=>String(r.요청상태)==='요청').length;
  const cProg=filtered.filter(r=>String(r.요청상태)==='진행중').length;
  const cDone=filtered.filter(r=>String(r.요청상태)==='완료').length;
  $('#cReq').textContent=cReq; $('#cProg').textContent=cProg; $('#cDone').textContent=cDone;
  $('#summary').textContent=`총 ${filtered.length}건`;

  const total=Math.max(1,Math.ceil(filtered.length/pageSize)); if(page>total) page=total;
  const slice=filtered.slice((page-1)*pageSize, page*pageSize);
  $('#pageinfo').textContent=`${page} / ${total}`;

  const tbody=$('#tbody');
  if(!slice.length){ tbody.innerHTML='<tr><td colspan="6">조건에 맞는 데이터가 없습니다.</td></tr>'; return; }

  tbody.innerHTML = slice.map(r=>{
    const url = imgUrlForRow(r);
    return `
      <tr data-id="${r.ID??''}">
        <td><img class="avatar" src="${url||FALLBACK_SVG}" alt="" data-zoom="${url||''}" onerror="this.onerror=null;this.src='${FALLBACK_SVG}'"/></td>
        <td class="cell-item">${r.물품명??''}</td>
        <td>${r.기기??''}</td>
        <td>${r.재고량??''}</td>
        <td>${badgeWithReq(r.요청상태, r.요청자)}</td>
        <td style="text-align:left">
          <div class="actions">
            <select class="select" data-prev="${r.요청상태??''}" data-quick="${r.ID??''}" title="상태 선택">
              <option ${r.요청상태==='요청'?'selected':''}>요청</option>
              <option ${r.요청상태==='진행중'?'selected':''}>진행중</option>
              <option ${r.요청상태==='완료'?'selected':''}>완료</option>
            </select>
            <!-- 추가요청: 아이콘 버튼 -->
            <button class="icon-btn" data-addreq="${r.ID??''}" aria-label="추가요청" title="추가요청">
              <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/><circle cx="19" cy="5" r="3"/></svg>
            </button>
            <button class="icon-btn" data-edit="${r.ID??''}" aria-label="수정" title="수정">
              <svg viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4L7 21l-4 1 1-4 12.5-14.5z"/></svg>
            </button>
            <button class="icon-btn danger" data-del="${r.ID??''}" aria-label="삭제" title="삭제">
              <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6v14m8-14v14M10 6l1-2h2l1 2"/></svg>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  // 이미지 확대(라이트박스)
  tbody.querySelectorAll('img.avatar').forEach(img=>{
    img.onclick=()=>{
      const src = img.getAttribute('data-zoom') || img.src;
      if(!src) return;
      $('#imgLarge').src = src;
      $('#imgModal').hidden = false;
    };
  });

  // 상태 드롭박스: 변경 즉시 반영
  tbody.querySelectorAll('select[data-quick]').forEach(sel=>{
    sel.onchange=()=>{
      const id=sel.getAttribute('data-quick');
      const prev=sel.getAttribute('data-prev')||'';
      const val=sel.value;
      if(val==='요청'){ // 요청자(개수)로 설정 (덮어쓰기)
        openMini(id, sel, 'set');
      }else{
        sel.setAttribute('data-prev', val);
        postExec([['op','update'],['id',id],['status',val]]);
        toast('상태 변경 중…');
      }
    };
  });

  // 추가요청
  tbody.querySelectorAll('[data-addreq]').forEach(b=>b.onclick=()=>{
    const id=b.dataset.addreq;
    openMini(id, null, 'append');
  });

  // 수정/삭제
  tbody.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>{
    const id=b.dataset.edit; const row=allRows.find(x=>String(x.ID)===String(id));
    row?openModal('update',row):toast('항목을 찾을 수 없습니다.');
  });
  tbody.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{
    const id=b.dataset.del; if(confirm('삭제할까요?')){ postExec([['op','delete'],['id',id]]); toast('삭제 중…'); }
  });

  saveUI();
}

/* === 라이트박스 닫기 === */
const imgModal = $('#imgModal');
imgModal.addEventListener('click', (e)=>{ if(e.target===imgModal) imgModal.hidden = true; });
window.addEventListener('keydown',(e)=>{ if(!imgModal.hidden && e.key==='Escape') imgModal.hidden=true; });

/* === 큰 모달(추가/수정) === */
const modal=$('#modal'), form=$('#postForm'), btnSubmit=$('#btnSubmit');
const modalPreview = $('#modalPreview');
const btnPhotoOpen = $('#btnPhotoOpen');
const btnPhotoChange = $('#btnPhotoChange');
let currentEditRow = null;

$('#btnCancel').onclick=()=>closeModal();

function openModal(mode,row){
  modal.hidden=false; form.action=APPS_SCRIPT_EXEC; currentEditRow = row || null;

  // 프리뷰 이미지
  const url = row ? (imgUrlForRow(row) || FALLBACK_SVG) : FALLBACK_SVG;
  modalPreview.src = url;
  modalPreview.onclick = ()=>{ $('#imgLarge').src = modalPreview.src; $('#imgModal').hidden = false; };

  // 버튼: 사진 열기/변경
  btnPhotoOpen.onclick = ()=>{ if(modalPreview.src) window.open(modalPreview.src, '_blank'); };
  btnPhotoChange.onclick = ()=>{
    const baseId = (row?.ID||'').toString().trim();
    let input = prompt('이미지 URL 또는 파일명(ID를 그대로 쓰면 자동 매칭)\n예: https://.../foo.jpg  또는  '+(baseId||'FILE'), '');
    if(input==null) return;
    input = input.trim();
    const url = /^https?:\/\//i.test(input) ? input : (IMG_BASE + encodeURIComponent(input || baseId) + IMG_EXT);
    modalPreview.src = url;
    // note에 반영(수정 모드면 즉시 반영, 추가 모드면 f_note에 반영)
    if(mode==='update' && row?.ID){
      const note = mergeImgNote(row.비고, url);
      postExec([['op','update'],['id',row.ID],['note',note]]);
      toast('사진 정보 저장 중…');
    }else{
      const old = $('#f_note').value;
      $('#f_note').value = mergeImgNote(old, url);
    }
  };

  if(mode==='add'){
    $('#modalTitle').textContent='리스트 추가';
    form.op.value='add'; form.id.value='';
    enable('#f_item'); enable('#f_device');
    form.item.value=''; form.device.value='';
    form.stock.value='0'; form.status.value='요청';
    form.who.value=''; form.date.value=todayYMD();
    form.qty.value='0';
    form.note.value='';
  }else{
    $('#modalTitle').textContent='요청 수정';
    form.op.value='update'; form.id.value=row.ID||'';
    disable('#f_item'); disable('#f_device'); // 수정 금지
    form.item.value=row.물품명||''; form.device.value=row.기기||'';
    form.stock.value=Number(row.재고량||0);
    form.status.value=row.요청상태||'요청'; form.who.value=row.요청자||'';
    form.date.value=(row.요청일 && String(row.요청일).slice(0,10)) || todayYMD();
    form.qty.value=Number(row.개수||0); form.note.value=row.비고||'';
  }
}
function closeModal(){ modal.hidden=true; currentEditRow=null; }
function disable(sel){ const el=$(sel); if(el){ el.setAttribute('disabled','disabled'); el.style.opacity=.75; } }
function enable(sel){ const el=$(sel); if(el){ el.removeAttribute('disabled'); el.style.opacity=''; } }
function mergeImgNote(oldNote, url){
  const t=String(oldNote||'');
  if(/img\s*:\s*\S+/i.test(t)) return t.replace(/img\s*:\s*\S+/i, 'img:'+url);
  return (t ? (t+' ') : '') + 'img:'+url;
}

modal.addEventListener('click',(e)=>{ if(e.target===modal) closeModal(); });
window.addEventListener('keydown',(e)=>{ if(!modal.hidden && e.key==='Escape') closeModal(); });
form.addEventListener('submit',()=>{ btnSubmit.disabled=true; btnSubmit.textContent='저장 중…'; });
document.getElementById('hidden_iframe').addEventListener('load',()=>{
  btnSubmit.disabled=false; btnSubmit.textContent='저장';
  closeModal(); toast('처리되었습니다'); load();
});

/* === 작은 모달(요청자/개수) — set/append 모드 지원 === */
const mini=$('#miniModal'); const mWho=$('#m_who'); const mQty=$('#m_qty');
let miniId=null, miniMode='set', miniSelRef=null;
function openMini(id, selectEl, mode){
  miniId=id; miniSelRef=selectEl||null; miniMode=mode||'set';
  mWho.value = ''; mQty.value = '1';
  mini.hidden=false; setTimeout(()=>mWho.focus(),0);
}
function closeMini(){ mini.hidden=true; miniId=null; miniSelRef=null; }
$('#miniCancel').onclick=()=>{
  if(miniSelRef){ const prev=miniSelRef.getAttribute('data-prev')||''; miniSelRef.value=prev; }
  closeMini();
};
$('#miniOK').onclick=()=>{
  const who=mWho.value.trim(); const qty=parseInt(mQty.value,10)||0;
  if(!who){ alert('요청자를 입력하세요.'); mWho.focus(); return; }
  const row=allRows.find(x=>String(x.ID)===String(miniId));
  const prevWho = row?.요청자 || '';
  let newWho = '';
  if(miniMode==='append' && prevWho){
    newWho = prevWho + ', ' + `${who}(${qty})`;
  }else{ // set
    newWho = `${who}(${qty})`;
  }
  const total = totalQtyFromWho(newWho);
  const pairs = [['op','update'],['id',miniId],['who',newWho],['qty', total]];
  if (miniMode==='set'){ pairs.push(['status','요청']); }
  postExec(pairs);
  if(miniSelRef){ miniSelRef.setAttribute('data-prev','요청'); miniSelRef.value='요청'; }
  closeMini(); toast('요청 정보 반영 중…');
};
mini.addEventListener('click',(e)=>{ if(e.target===mini) $('#miniCancel').click(); });
window.addEventListener('keydown',(e)=>{ if(!mini.hidden && e.key==='Escape') $('#miniCancel').click(); });

/* === 도움말 열기/닫기 === */
const helpModal = document.getElementById('helpModal');
document.getElementById('btnHelp').onclick = () => { helpModal.hidden = false; };
document.getElementById('btnHelpClose').onclick = () => { helpModal.hidden = true; };
helpModal.addEventListener('click', (e)=>{ if(e.target === helpModal) helpModal.hidden = true; });
window.addEventListener('keydown', (e)=>{ if(!helpModal.hidden && e.key === 'Escape') helpModal.hidden = true; });

/* === POST helper === */
function postExec(pairs){
  const f=document.createElement('form'); f.method='POST'; f.action=APPS_SCRIPT_EXEC; f.target='hidden_iframe';
  pairs.forEach(([k,v])=>{ const i=document.createElement('input'); i.type='hidden'; i.name=k; i.value=v; f.appendChild(i); });
  document.body.appendChild(f); f.submit();
}

/* === 페이지/정렬/검색/CSV === */
$('#prev').onclick=()=>{ if(page>1){ page--; applyAndRender(); } };
$('#next').onclick=()=>{ page++; applyAndRender(); };
$('#pageSize').onchange=(e)=>{ pageSize=+e.target.value||20; page=1; applyAndRender(); };
$$('th[data-k]').forEach(th=>{
  th.style.cursor='pointer';
  th.onclick=()=>{ const k=th.dataset.k; if(sortKey===k) sortDir=(sortDir==='asc'?'desc':'asc'); else {sortKey=k; sortDir='asc';} applyAndRender(); };
});
$('#btnReload').onclick=load;
$('#btnCSV').onclick=()=>{
  const header=['ID','물품명','기기','재고량','요청상태','요청자','요청일','개수','비고'];
  const rows=(allRows||[]).map(r=>[r.ID,r.물품명,r.기기,r.재고량,r.요청상태,r.요청자,r.요청일,r.개수,r.비고]);
  const csv=[header].concat(rows).map(a=>a.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`requests_${todayYMD()}.csv`; a.click(); URL.revokeObjectURL(url);
};
function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); }; }
const onSearch = debounce(()=>{ q=$('#q').value.trim(); page=1; applyAndRender(); }, 200);
$('#q').addEventListener('input', onSearch);
$('#fStatus').onchange=(e)=>{ fStatus=e.target.value; page=1; applyAndRender(); };
$('#fDevice').onchange=(e)=>{ fDevice=e.target.value; page=1; applyAndRender(); };
window.addEventListener('keydown',(e)=>{ if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); $('#q').focus(); } });

/* === “리스트 추가” 버튼 안전 바인딩 === */
function _bindAddButton(){
  const addBtn = document.getElementById('btnOpenAdd');
  if (addBtn) addBtn.onclick = ()=> openModal('add');
}
_bindAddButton();
document.addEventListener('click', (e)=>{
  const t = e.target.closest && e.target.closest('#btnOpenAdd');
  if (t) { e.preventDefault(); openModal('add'); }
});

/* 초기화 */
loadUI();
window.addEventListener('DOMContentLoaded',()=>{
  $('#q').value=q; $('#fStatus').value=fStatus; $('#pageSize').value=String(pageSize);
  load();
});
</script>
</body>
</html>
