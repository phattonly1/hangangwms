<!-- v3.0 -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>요청 현황</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<!-- (이전 버전과 동일한 스타일, 기능 유지) -->
<script>
/* === 설정 === */
const SHEET_ID = "13-0Qp2ImIIURJqv-YbklEVbsNYLPz_akDRwO2lDeEvM";
const GID = "0";
const APPS_SCRIPT_EXEC =
  "https://script.google.com/macros/s/AKfycbyxNNfPgvSeL0o9lSwFRlS7YRrKSt3Qv4baQUOy2oV1M5WkvBu-ciyTKQZuf9p6rPmsDg/exec";

/* === 상태/유틸 === */
let raw = [],
  view = [],
  page = 1,
  pageSize = 10,
  sortKey = "ID",
  sortDir = "desc",
  isSubmitting = false;

const $ = (s) => document.querySelector(s);
const toast = (t) => {
  const el = $("#toast");
  el.textContent = t;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), 1600);
};
const normDate = (v) => {
  if (!v) return "";
  if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  return String(v)
    .replace(/[.\s]/g, "-")
    .replace(/-$/g, "")
    .replace(/--/g, "-");
};
const toNum = (v) => (v === "" || v == null || isNaN(Number(v)) ? 0 : Number(v));
const sel = (cur, val) => (String(cur || "").trim() === val ? "selected" : "");
function statusBadge(v) {
  const t = (v || "").trim();
  if (t === "완료") return '<span class="status-badge done">완료</span>';
  if (t === "요청") return '<span class="status-badge pending">요청</span>';
  if (t) return `<span class="status-badge">${t}</span>`;
  return "";
}

/* === 데이터 로드 === */
function load() {
  const old = document.getElementById("gviz");
  if (old) old.remove();
  $("#tbody").innerHTML = '<tr><td colspan="9">불러오는 중...</td></tr>';
  const s = document.createElement("script");
  s.id = "gviz";
  s.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json;responseHandler:renderGViz&_=${Date.now()}`;
  s.onerror = () => toast("시트 로드 실패: 권한을 확인하세요.");
  document.body.appendChild(s);
}

window.renderGViz = function (resp) {
  try {
    if (!resp || resp.status === "error" || !resp.table) {
      toast("표시 실패: 시트 구조 확인 필요");
      return;
    }
    const table = resp.table;
    const cols = table.cols.map((c) => c?.label || "");
    const rows = (table.rows || []).map((r) => (r?.c || []).map((c) => (c ? c.v : "")));
    const idx = {
      id: cols.indexOf("ID"),
      date: cols.indexOf("요청일"),
      who: cols.indexOf("요청자"),
      item: cols.indexOf("요청물품"),
      qty: cols.indexOf("개수"),
      stat: cols.indexOf("진행사항"),
    };
    raw = rows
      .map((r) => ({
        ID: r[idx.id],
        요청일: r[idx.date],
        요청자: r[idx.who],
        요청물품: r[idx.item],
        개수: r[idx.qty],
        진행사항: r[idx.stat],
      }))
      .filter((r) => r.ID !== "" && r.ID != null);
    applyAndRender();
  } catch (e) {
    toast("표시 실패: " + e.message);
  }
};

/* === 렌더 === */
function applyAndRender() {
  const tbody = $("#tbody");
  if (!raw.length) {
    tbody.innerHTML = '<tr><td colspan="9">데이터가 없습니다.</td></tr>';
    return;
  }
  tbody.innerHTML = raw
    .map(
      (r) => `
    <tr>
      <td>${r.ID}</td>
      <td>${r["요청일"]}</td>
      <td>${r["요청자"]}</td>
      <td>${r["요청물품"]}</td>
      <td>${r["개수"]}</td>
      <td>${statusBadge(r["진행사항"])}</td>
      <td><button onclick="quickDelete('${r.ID}')" class="btn danger" style="padding:4px 10px;">삭제</button></td>
    </tr>`
    )
    .join("");
}

/* === 삭제 === */
function quickDelete(id) {
  if (!confirm(`ID ${id} 항목을 삭제할까요?`)) return;
  const f = document.createElement("form");
  f.method = "POST";
  f.action = APPS_SCRIPT_EXEC;
  f.target = "hidden_iframe";
  [["op", "delete"], ["id", id]].forEach(([k, v]) => {
    const i = document.createElement("input");
    i.type = "hidden";
    i.name = k;
    i.value = v;
    f.appendChild(i);
  });
  document.body.appendChild(f);
  f.submit();
  toast("삭제 중...");
}

/* === 초기화 === */
window.onload = load;
</script>
<style>
/* 최소 디자인 요약 */
body {
  font-family: system-ui, sans-serif;
  margin: 0;
  background: #f5f7fb;
}
.appbar {
  background: white;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #ddd;
}
.logo-img {
  width: 44px;
  height: 44px;
}
h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 700;
}
.table-wrap {
  max-width: 1200px;
  margin: 20px auto;
  background: white;
  border-radius: 12px;
  overflow: auto;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}
table {
  width: 100%;
  border-collapse: collapse;
}
th,
td {
  padding: 10px;
  border-bottom: 1px solid #eee;
}
th {
  background: #f0f4ff;
}
.btn {
  background: #2563eb;
  color: white;
  border: 0;
  border-radius: 6px;
  padding: 6px 10px;
  cursor: pointer;
}
.btn.danger {
  background: #dc2626;
}
.toast {
  position: fixed;
  right: 16px;
  bottom: 16px;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 10px 12px;
  border-radius: 10px;
  opacity: 0;
  pointer-events: none;
  transition: 0.25s;
  z-index: 3000;
}
.toast.show {
  opacity: 1;
}
</style>
</head>
<body>
  <header class="appbar">
    <img src="./assets/gongdan-mark.png" alt="공단 마크" class="logo-img" />
    <h1>요청 현황</h1>
  </header>

  <main class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>요청일</th>
          <th>요청자</th>
          <th>요청물품</th>
          <th>개수</th>
          <th>진행상태</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7">불러오는 중...</td></tr>
      </tbody>
    </table>
  </main>

  <iframe name="hidden_iframe" style="display:none;"></iframe>
  <div id="toast" class="toast"></div>
</body>
</html>
