<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>요청 현황</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<style>
:root {
  --ink:#0b2239; --muted:#64748b; --bd:#e5e7eb; --panel:#ffffff; --accent:#2563eb;
  --ok:#065f46; --warn:#9a3412; --mid:#3730a3;
  --ctl-h: 38px;                 /* ✅ 공통 컨트롤(버튼/셀렉트) 높이 */
  --radius: 10px;                /* 둥글기 */
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Pretendard; color:var(--ink); background:#f4f6fb;}
/* 헤더 */
.appbar{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#fff;border-bottom:1px solid #e6e8ee;position:sticky;top:0;z-index:10;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.appbar img{width:44px;height:44px;object-fit:contain}
.appbar h1{margin:0;font-size:1.5rem;font-weight:800;letter-spacing:-.01em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
/* 레이아웃/툴바 */
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:0 0 14px}
.btn{appearance:none;border:0;border-radius:var(--radius);padding:0 14px;font-weight:800;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.06);height:var(--ctl-h);display:inline-flex;align-items:center;justify-content:center}
.btn.primary{background:var(--accent);color:#fff}
.btn.ghost{background:#fff;color:var(--accent);border:1px solid #93c5fd}
.btn.danger{background:#dc2626;color:#fff}
.input,.select,textarea{border:1px solid var(--bd);border-radius:var(--radius);background:#fff}
.input,.select{height:var(--ctl-h);padding:0 12px}
.muted{color:var(--muted);font-size:13px}
/* 카드형 테이블 컨테이너 */
.card{background:var(--panel);border:1px solid var(--bd);border-radius:14px;overflow:auto;box-shadow:0 10px 30px rgba(16,24,40,.06)}
table{width:100%;border-collapse:collapse;font-size:16px}
th,td{padding:14px 12px;border-bottom:1px solid var(--bd);text-align:center;vertical-align:middle}
th{background:#f1f5ff;color:#1e3a8a;font-weight:800;position:sticky;top:0;z-index:1}
tbody tr:nth-child(odd){background:#fcfdff}
tbody tr:hover{background:#f9fbff}
/* 요청물품 셀: 줄바꿈 허용(중앙정렬 유지) */
.cell-item{white-space:normal;word-break:keep-all;line-height:1.4}
/* 빠른변경: 드롭다운+아이콘 높이/정렬 완전 일치 */
.quick-wrap{display:inline-flex;align-items:center;gap:8px}
.quick-wrap .select{min-width:120px}
/* 배지 */
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:13px;font-weight:700}
.badge.done{background:#ecfdf5;color:var(--ok)}
.badge.req{background:#fff7ed;color:var(--warn)}
.badge.prog{background:#eef2ff;color:var(--mid)}
/* 페이지네이션 */
.pagination{display:flex;gap:8px;justify-content:flex-end;align-items:center;margin:12px 0}
.page-btn{padding:0 12px;border:1px solid var(--bd);border-radius:var(--radius);background:#fff;cursor:pointer;height:var(--ctl-h);display:inline-flex;align-items:center}
/* 모달(세련 리디자인) */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.38);align-items:center;justify-content:center;z-index:100}
.modal.show{display:flex}
.sheet{background:#fff;border-radius:16px;width:min(92vw,760px);box-shadow:0 24px 80px rgba(0,0,0,.3);overflow:hidden}
.sheet-head{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--bd);background:linear-gradient(180deg,#f8fbff,#ffffff)}
.sheet-head .tag{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;background:#eaf2ff}
.sheet-head h3{margin:0;font-size:1.2rem;font-weight:900;letter-spacing:-.01em}
.sheet-head p{margin:2px 0 0 0;color:var(--muted);font-size:13px}
.sheet-body{padding:16px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-weight:800}
.hint{color:var(--muted);font-size:12px}
.sheet-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--bd);background:#fafcff}
@media (max-width:640px){ .form-grid{grid-template-columns:1fr} }
/* 저장중 오버레이 + 토스트 */
.saving{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:120}
.saving.hidden{display:none}
.saving .box{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:18px 20px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.2)}
.toast{position:fixed;right:16px;bottom:16px;background:rgba(0,0,0,0.85);color:#fff;padding:10px 12px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s;z-index:150}
.toast.show{opacity:1}
/* 모바일 카드뷰 */
.cards{display:none}
.card-item{background:#fff;border:1px solid var(--bd);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
.card-top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px}
.card-title{font-weight:900}
.card-sub{color:#64748b;font-size:12px}
.card-mid{margin:6px 0 10px;font-size:15px}
.card-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.card-actions .select{min-width:110px}
.card-actions .btn{height:var(--ctl-h);padding:0 10px}
/* 아이콘 버튼 */
.icon-btn{
  appearance:none; border:1px solid var(--bd); cursor:pointer; background:#fff;
  display:inline-flex; align-items:center; justify-content:center;
  width:var(--ctl-h); height:var(--ctl-h); border-radius:var(--radius);
  box-shadow:0 2px 6px rgba(0,0,0,.06);
}
.icon-btn.primary{ background:var(--accent); border-color:var(--accent); }
.icon-btn.primary svg{ stroke:#fff; }
.icon-btn.ghost{ background:#fff; border-color:#93c5fd; }
.icon-btn.danger{ background:#dc2626; border-color:#dc2626; }
.icon-btn.danger svg{ stroke:#fff; }
.icon-btn:hover{ transform:translateY(-1px); }
.icon-btn svg{ width:18px; height:18px; stroke:#334155; stroke-width:2; fill:none; }
.icon-btn .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
/* 모바일에서 더 타이트 + 한 줄 유지 */
@media (max-width:640px){
  .card table{display:none}
  .cards{display:grid;gap:10px}
  .card-actions{ flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; gap:6px; }
  .card-actions .select{ min-width:92px; padding:0 8px; font-size:14px; height:var(--ctl-h); }
  .card-actions .icon-btn{ width:var(--ctl-h); height:var(--ctl-h); }
  .card-actions .badge{ white-space:nowrap; font-size:12px; padding:3px 8px; }
}
</style>
</head>
<body>
  <header class="appbar">
    <img src="./assets/gongdan-mark.png" alt="공단 마크" />
    <h1>요청 현황</h1>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <button class="btn primary" id="btnOpenAdd" title="새 요청 추가">추가하기</button>
      <button class="btn ghost" id="btnReload" title="데이터 새로고침">새로고침</button>
      <button class="btn ghost" id="btnCSV" title="CSV 파일로 내보내기">CSV 내보내기</button>
      <span class="muted" id="summary">총 0건</span>
    </div>

    <div class="card" role="region" aria-label="요청 현황 표">
      <table id="tbl">
        <!-- 열 너비: 요청자 좁게, 요청물품 넓게 -->
        <colgroup>
          <!-- 요청일 / 요청자 / 요청물품 / 개수 / 진행상태 / 빠른변경 / 수정 / 삭제 -->
          <col style="width:12%">
          <col style="width:9%">
          <col style="width:38%">   <!-- 요청물품 크게 -->
          <col style="width:8%">
          <col style="width:10%">
          <col style="width:15%">
          <col style="width:4%">
          <col style="width:4%">
        </colgroup>
        <thead>
          <tr>
            <th data-k="요청일" title="요청일 정렬">요청일</th>
            <th data-k="요청자" title="요청자 정렬">요청자</th>
            <th data-k="요청물품" title="요청물품 정렬">요청물품</th>
            <th data-k="개수" title="개수 정렬">개수</th>
            <th data-k="진행사항" title="진행상태 정렬">진행상태</th>
            <th>빠른변경</th>
            <th>수정</th>
            <th>삭제</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8">불러오는 중...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 모바일 카드 리스트 -->
    <div id="cards" class="cards" aria-live="polite"></div>

    <div class="pagination">
      <button class="page-btn" id="prev" title="이전 페이지">이전</button>
      <span id="pageinfo" class="muted">0 / 0</span>
      <button class="page-btn" id="next" title="다음 페이지">다음</button>
    </div>
  </main>

  <!-- 추가/수정 모달 (세련된 시트 레이아웃) -->
  <div class="modal" id="modal" aria-modal="true" role="dialog" aria-labelledby="modalTitle">
    <div class="sheet">
      <div class="sheet-head">
        <div class="tag" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="22" height="22" style="stroke:#2563eb;fill:none;stroke-width:2;display:block;margin:auto">
            <path d="M4 7h16M4 12h16M4 17h16"/>
          </svg>
        </div>
        <div>
          <h3 id="modalTitle">요청 추가</h3>
          <p id="modalDesc">필요한 정보를 입력하고 저장하세요.</p>
        </div>
        <button type="button" class="icon-btn ghost" id="btnX" aria-label="창 닫기" title="창 닫기" style="margin-left:auto">
          <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6l-12 12"/></svg>
        </button>
      </div>

      <div class="sheet-body">
        <form id="postForm" method="POST" target="hidden_iframe">
          <input type="hidden" name="op" value="add" />
          <input type="hidden" name="id" value="" />

          <div class="form-grid">
            <div class="field">
              <label for="f_date">요청일</label>
              <input id="f_date" class="input" type="date" name="date" required />
              <div class="hint">YYYY-MM-DD 형식</div>
            </div>
            <div class="field">
              <label for="f_who">요청자</label>
              <input id="f_who" class="input" type="text" name="who" placeholder="요청자" required />
            </div>
            <div class="field">
              <label for="f_item">요청물품</label>
              <input id="f_item" class="input" type="text" name="item" placeholder="요청물품" required />
            </div>
            <div class="field">
              <label for="f_qty">개수</label>
              <input id="f_qty" class="input" type="number" name="qty" min="1" step="1" required />
            </div>
            <div class="field">
              <label for="f_status">진행상태</label>
              <select id="f_status" class="select" name="status" required title="상태 선택" aria-label="상태 선택">
                <option>요청</option>
                <option>진행중</option>
                <option>완료</option>
              </select>
            </div>
          </div>

          <div class="sheet-foot">
            <button type="button" class="btn ghost" id="btnCancel" title="창 닫기">취소</button>
            <button type="submit" class="btn primary" id="btnSubmit" title="저장하기">저장</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 숨은 iframe (POST 응답 수신) -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>

  <!-- 저장 중 팝업 & 토스트 -->
  <div id="savingPopup" class="saving hidden"><div class="box">요청을 저장 중입니다…</div></div>
  <div id="toast" class="toast">처리되었습니다</div>

<script>
/* === 설정 === */
const SHEET_ID = "13-0Qp2ImIIURJqv-YbklEVbsNYLPz_akDRwO2lDeEvM";
const GID      = "0";
const APPS_SCRIPT_EXEC = "https://script.google.com/macros/s/AKfycbyxNNfPgvSeL0o9lSwFRlS7YRrKSt3Qv4baQUOy2oV1M5WkvBu-ciyTKQZuf9p6rPmsDg/exec";

/* === 전역 상태 === */
let raw = [];        // { ID, 요청일, 요청자, 요청물품, 개수, 진행사항 }
let view = [];
let page = 1, pageSize = 10;
let sortKey = "요청일", sortDir = "desc";
let isSubmitting = false;

const $ = (s) => document.querySelector(s);
const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"), 1500); };

/* 날짜 포맷터: YYYY-MM-DD */
function ymd(dateLike){
  if (dateLike == null || dateLike === "") return "";
  if (typeof dateLike === "string" && /^\d{4}-\d{2}-\d{2}$/.test(dateLike)) return dateLike;
  try{
    const d = new Date(dateLike);
    if (!isNaN(d)) return d.toISOString().slice(0,10);
  }catch(_){}
  if (typeof dateLike === "string") {
    const s = dateLike.replace(/[./\s]/g, "-");
    const d = new Date(s);
    if (!isNaN(d)) return d.toISOString().slice(0,10);
  }
  return String(dateLike);
}

/* 배지 */
function badge(v){
  const t = (v||"").trim();
  if (t === "완료")   return '<span class="badge done">완료</span>';
  if (t === "요청")   return '<span class="badge req">요청</span>';
  if (t === "진행중") return '<span class="badge prog">진행중</span>';
  return t ? `<span class="badge">${t}</span>` : "";
}

/* === 데이터 로드(GViz JSONP) === */
function load(){
  const old = document.getElementById("gviz"); if (old) old.remove();
  $("#tbody").innerHTML = '<tr><td colspan="8">불러오는 중...</td></tr>';
  $("#cards").innerHTML = '';
  const s = document.createElement("script");
  s.id = "gviz";
  s.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json;responseHandler:renderGViz&_=${Date.now()}`;
  document.body.appendChild(s);
}

/* GViz 핸들러 */
window.renderGViz = function(resp){
  try{
    const table = resp.table;
    // 각 셀: c.f(포맷 문자열) 우선
    const rows = (table.rows||[]).map(r => (r.c||[]).map(c => c ? (c.f ?? c.v) : ""));
    const cols = (table.cols||[]).map(c => c?.label || "");

    const idx = {
      id  : cols.indexOf("ID"),
      date: cols.indexOf("요청일"),
      who : cols.indexOf("요청자"),
      item: cols.indexOf("요청물품"),
      qty : cols.indexOf("개수"),
      stat: cols.indexOf("진행사항"),
    };

    raw = rows.map(cells => ({
      ID       : cells[idx.id],
      요청일   : ymd(cells[idx.date]),
      요청자   : cells[idx.who],
      요청물품 : cells[idx.item],
      개수     : cells[idx.qty],
      진행사항 : cells[idx.stat],
    })).filter(r => (r.요청자 || r.요청물품));

    applyAndRender();
  }catch(e){
    toast("표시 실패: " + e.message);
  }
};

/* === 렌더 === */
function applyAndRender(){
  // 정렬
  view = [...raw].sort((a,b)=>{
    let A=a[sortKey], B=b[sortKey];
    if (sortKey === "요청일") return (sortDir==='asc') ? (A>B?1:-1) : (A<B?1:-1);
    A = (A ?? "").toString(); B = (B ?? "").toString();
    return (sortDir==='asc') ? A.localeCompare(B,'ko') : B.localeCompare(A,'ko');
  });

  // 페이지
  const total = Math.max(1, Math.ceil(view.length / pageSize));
  if (page > total) page = total;
  const slice = view.slice((page-1)*pageSize, page*pageSize);
  $("#pageinfo").textContent = `${page} / ${total}`;
  $("#summary").textContent = `총 ${view.length}건`;

  // 테이블 렌더 (ID는 data-id로 보관)
  const tbody = $("#tbody");
  if (!slice.length){
    tbody.innerHTML = '<tr><td colspan="8">데이터가 없습니다.</td></tr>';
  } else {
    tbody.innerHTML = slice.map(r => `
      <tr data-id="${r.ID ?? ""}">
        <td>${r.요청일 ?? ""}</td>
        <td>${r.요청자 ?? ""}</td>
        <td class="cell-item">${r.요청물품 ?? ""}</td>
        <td>${r.개수 ?? ""}</td>
        <td>${badge(r.진행사항)}</td>
        <td>
          <span class="quick-wrap">
            <select class="select" data-quick="${r.ID ?? ""}" title="상태 선택" aria-label="상태 선택">
              <option ${r.진행사항==='요청'?'selected':''}>요청</option>
              <option ${r.진행사항==='진행중'?'selected':''}>진행중</option>
              <option ${r.진행사항==='완료'?'selected':''}>완료</option>
            </select>
            <button class="icon-btn ghost" aria-label="상태 변경" title="선택한 상태로 변경" data-save="${r.ID ?? ""}">
              <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
              <span class="sr-only">변경</span>
            </button>
          </span>
        </td>
        <td>
          <button class="icon-btn" aria-label="수정" title="내용 수정" data-edit="${r.ID ?? ""}">
            <svg viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4L7 21l-4 1 1-4 12.5-14.5z"/></svg>
            <span class="sr-only">수정</span>
          </button>
        </td>
        <td>
          <button class="icon-btn danger" aria-label="삭제" title="영구 삭제" data-del="${r.ID ?? ""}">
            <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6v14m8-14v14M10 6l1-2h2l1 2"/></svg>
            <span class="sr-only">삭제</span>
          </button>
        </td>
      </tr>
    `).join("");
  }

  // 모바일 카드 렌더
  const cards = document.getElementById('cards');
  if (cards){
    if (!slice.length){
      cards.innerHTML = '<div class="muted">데이터가 없습니다.</div>';
    } else {
      const frag = document.createDocumentFragment();
      slice.forEach(r=>{
        const el = document.createElement('div');
        el.className = 'card-item';
        el.innerHTML = `
          <div class="card-top">
            <div class="card-title">${r.요청물품 ?? ''}</div>
            <div class="card-sub">${r.요청일 ?? ''}</div>
          </div>
          <div class="card-mid">
            <div><b>요청자</b> · ${r.요청자 ?? ''}</div>
            <div><b>개수</b> · ${r.개수 ?? ''}</div>
            <div><b>상태</b> · ${r.진행사항 ?? ''}</div>
          </div>
          <div class="card-actions">
            <span>${badge(r.진행사항)}</span>
            <select class="select" data-quick-m="${r.ID ?? ''}" title="상태 선택" aria-label="상태 선택">
              <option ${r.진행사항==='요청'?'selected':''}>요청</option>
              <option ${r.진행사항==='진행중'?'selected':''}>진행중</option>
              <option ${r.진행사항==='완료'?'selected':''}>완료</option>
            </select>
            <button class="icon-btn ghost" aria-label="상태 변경" title="선택한 상태로 변경" data-save-m="${r.ID ?? ''}">
              <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
              <span class="sr-only">변경</span>
            </button>
            <button class="icon-btn" aria-label="수정" title="내용 수정" data-edit-m="${r.ID ?? ''}">
              <svg viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5l4 4L7 21l-4 1 1-4 12.5-14.5z"/></svg>
              <span class="sr-only">수정</span>
            </button>
            <button class="icon-btn danger" aria-label="삭제" title="영구 삭제" data-del-m="${r.ID ?? ''}">
              <svg viewBox="0 0 24 24"><path d="M3 6h18M8 6v14m8-14v14M10 6l1-2h2l1 2"/></svg>
              <span class="sr-only">삭제</span>
            </button>
          </div>
        `;
        frag.appendChild(el);
      });
      cards.innerHTML = '';
      cards.appendChild(frag);

      // 모바일 카드 이벤트
      cards.querySelectorAll('[data-save-m]').forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute('data-save-m');
          const val = cards.querySelector(`select[data-quick-m="${id}"]`).value;
          if (!id) return toast('ID 누락으로 변경 불가');
          quickUpdate(id, val);
        };
      });
      cards.querySelectorAll('[data-edit-m]').forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute('data-edit-m');
          const full = raw.find(x=>String(x.ID)===String(id));
          if (full) openModal('update', full); else toast('항목을 찾을 수 없습니다.');
        };
      });
      cards.querySelectorAll('[data-del-m]').forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute('data-del-m');
          if (!id) return toast('ID 누락으로 삭제 불가');
          if (confirm('해당 항목을 삭제할까요?')) quickDelete(id);  // ID 문구 제거
        };
      });
    }
  }

  // 테이블 이벤트
  if (slice.length){
    const tbody = $("#tbody");
    tbody.querySelectorAll("[data-save]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-save");
        const sel = tbody.querySelector(`select[data-quick="${id}"]`);
        if (!id) return toast("ID 누락으로 변경할 수 없습니다.");
        quickUpdate(id, sel.value);
      };
    });
    tbody.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-edit");
        const full = raw.find(x => String(x.ID) === String(id));
        if (full) openModal("update", full); else toast("항목을 찾을 수 없습니다.");
      };
    });
    tbody.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute("data-del");
        if (!id) return toast("ID 누락으로 삭제할 수 없습니다.");
        if (confirm('해당 항목을 삭제할까요?')) quickDelete(id);  // ID 문구 제거
      };
    });
  }
}

/* === 모달/폼 === */
const modal = $("#modal");
const form  = $("#postForm");
const btnSubmit = $("#btnSubmit");
const saving = $("#savingPopup");

$("#btnOpenAdd").onclick = ()=> openModal("add");
$("#btnCancel").onclick  = ()=> modal.classList.remove("show");
$("#btnX").onclick       = ()=> modal.classList.remove("show");

function openModal(mode, row){
  modal.classList.add("show");
  form.action = APPS_SCRIPT_EXEC;
  if (mode === "add"){
    $("#modalTitle").textContent = "요청 추가";
    $("#modalDesc").textContent  = "필요한 정보를 입력하고 저장하세요.";
    form.op.value = "add";
    form.id.value = "";
    form.date.value = "";
    form.who.value  = "";
    form.item.value = "";
    form.qty.value  = "";
    form.status.value = "요청";
  } else {
    $("#modalTitle").textContent = "요청 수정";
    $("#modalDesc").textContent  = "내용을 수정한 뒤 저장하세요.";
    form.op.value = "update";
    form.id.value = row.ID ?? "";
    form.date.value = row.요청일 ?? "";
    form.who.value  = row.요청자 ?? "";
    form.item.value = row.요청물품 ?? "";
    form.qty.value  = row.개수 ?? "";
    form.status.value = (row.진행사항 ?? "요청");
  }
}

form.addEventListener("submit", (e)=>{
  if (isSubmitting) { e.preventDefault(); return; }
  isSubmitting = true;
  btnSubmit.disabled = true;
  btnSubmit.textContent = "저장 중…";
  saving.classList.remove("hidden");
});

document.getElementById("hidden_iframe").addEventListener("load", ()=>{
  isSubmitting = false;
  btnSubmit.disabled = false;
  btnSubmit.textContent = "저장";
  saving.classList.add("hidden");
  modal.classList.remove("show");
  toast("처리되었습니다");
  load();
});

/* === 상태 변경/삭제 === */
function quickUpdate(id, status){
  const f = document.createElement("form");
  f.method = "POST"; f.action = APPS_SCRIPT_EXEC; f.target = "hidden_iframe";
  [["op","update"], ["id",id], ["status",status]].forEach(([k,v])=>{
    const i = document.createElement("input"); i.type="hidden"; i.name=k; i.value=v; f.appendChild(i);
  });
  document.body.appendChild(f); f.submit();
  toast("상태 변경 중…");
}
function quickDelete(id){
  const f = document.createElement("form");
  f.method = "POST"; f.action = APPS_SCRIPT_EXEC; f.target = "hidden_iframe";
  [["op","delete"], ["id",id]].forEach(([k,v])=>{
    const i = document.createElement("input"); i.type="hidden"; i.name=k; i.value=v; f.appendChild(i);
  });
  document.body.appendChild(f); f.submit();
  toast("삭제 중…");
}

/* === 페이지네이션/정렬/기타 === */
document.getElementById("prev").onclick=()=>{ if(page>1){ page--; applyAndRender(); } };
document.getElementById("next").onclick=()=>{ page++; applyAndRender(); };
document.querySelectorAll('th[data-k]').forEach(th=>{
  th.style.cursor='pointer';
  th.onclick=()=>{
    const k=th.getAttribute('data-k');
    if (sortKey===k) sortDir = (sortDir==='asc'?'desc':'asc');
    else { sortKey=k; sortDir='asc'; }
    applyAndRender();
  };
});
document.getElementById("btnReload").onclick=load;
document.getElementById("btnCSV").onclick=()=>{
  const header=['요청일','요청자','요청물품','개수','진행상태'];
  const rows=view.map(r=>[r.요청일,r.요청자,r.요청물품,r.개수,r.진행사항]);
  const csv=[header].concat(rows).map(a=>a.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`requests_${new Date().toISOString().slice(0,10)}.csv`;a.click();URL.revokeObjectURL(url);
};

/* 초기 로드 */
load();
</script>
</body>
</html>
