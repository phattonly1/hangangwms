<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>요청 현황</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<style>
  :root{ --HDR-H:64px; --ink:#0b2239; --muted:#6b7280; --ring:rgba(0,119,255,.25); }
  *{ box-sizing:border-box }
  html, body { height:100%; margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,Arial; color:var(--ink); }
  body { background:#f5f7fb; }
  /* 헤더 */
  .appbar{ height:var(--HDR-H); display:flex; align-items:center; gap:14px; padding:0 16px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06); position:sticky; top:0; z-index:1000; }
  .logo-img{ width:44px; height:44px; object-fit:contain; filter:drop-shadow(0 2px 4px rgba(0,0,0,.12)); }
  .title-text{ min-width:0; }
  .title-text h1{ margin:0; font-weight:800; letter-spacing:-0.02em; line-height:1.1; font-size: clamp(18px, 4.2vw, 26px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  /* 본문 */
  .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:8px 0 14px; }
  .btn{ appearance:none; border:0; cursor:pointer; padding:10px 14px; border-radius:10px; font-weight:700; background:#2563eb; color:#fff; box-shadow:0 6px 14px rgba(37,99,235,.2); }
  .btn.ghost{ background:#fff; color:#2563eb; border:1px solid #93c5fd; }
  .muted{ color:var(--muted); font-size:13px; }
  /* 카드 + 테이블 */
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; }
  table{ width:100%; border-collapse:collapse; }
  th, td{ border-bottom:1px solid #e5e7eb; padding:10px; text-align:left; }
  th{ background:#f8fafc; font-weight:700; }
  tbody tr:hover{ background:#fafafa; }
  .right{ text-align:right; }
  .error{ color:#b91c1c; font-size:13px; margin-top:10px; }
  .badge{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3; }
  .badge.pending{ background:#fff7ed; color:#9a3412; }
  .badge.done{ background:#ecfdf5; color:#065f46; }

  /* 모달 */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:2000; }
  .modal.show{ display:flex; }
  .modal .panel{ background:#fff; width:min(540px,92vw); border-radius:12px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,.25); }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .field{ display:flex; flex-direction:column; gap:6px; }
  .field label{ font-size:12px; color:#6b7280; }
  .field input, .field select{ padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; }
  .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
</style>
</head>
<body>
  <!-- 헤더 -->
  <header class="appbar">
    <img class="logo-img" src="./assets/gongdan-mark.png" alt="공단 마크" />
    <div class="title-text"><h1>요청 현황</h1></div>
  </header>

  <!-- 본문 -->
  <main class="wrap">
    <div class="toolbar">
      <button class="btn" id="btnOpenAdd">추가하기</button>
      <button class="btn ghost" id="btnReload">새로고침</button>
      <span class="muted">ID는 자동 관리됩니다. 진행상태를 빠르게 수정할 수 있어요.</span>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:80px">ID</th>
            <th>요청일</th>
            <th>요청자</th>
            <th>요청물품</th>
            <th class="right" style="width:90px">개수</th>
            <th style="width:120px">진행상태</th>
            <th style="width:90px">수정</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7">불러오는 중...</td></tr>
        </tbody>
      </table>
    </div>

    <div id="msg" class="error"></div>
  </main>

  <!-- 추가/수정 모달 -->
  <div class="modal" id="modal">
    <div class="panel">
      <h3 id="modalTitle" style="margin:0 0 10px">요청 추가</h3>
      <form id="postForm" method="POST" target="hidden_iframe">
        <!-- Apps Script /exec 주소는 JS에서 설정 -->
        <input type="hidden" name="op" value="add" />
        <input type="hidden" name="id" value="" />
        <div class="grid">
          <div class="field">
            <label>요청일</label>
            <input type="date" name="date" required />
          </div>
          <div class="field">
            <label>요청자</label>
            <input type="text" name="who" placeholder="차영종" required />
          </div>
          <div class="field">
            <label>요청물품</label>
            <input type="text" name="item" placeholder="TOC연소관" required />
          </div>
          <div class="field">
            <label>개수</label>
            <input type="number" name="qty" min="1" step="1" required />
          </div>
          <div class="field">
            <label>진행상태</label>
            <select name="status" required>
              <option value="요청">요청</option>
              <option value="진행중">진행중</option>
              <option value="완료">완료</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="btn ghost" id="btnCancel">취소</button>
          <button type="submit" class="btn" id="btnSubmit">저장</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 숨은 iframe: 폼 POST 응답 수신 -->
  <iframe name="hidden_iframe" style="display:none"></iframe>

  <script>
    // === 설정 ===
    const SHEET_ID = "13-0Qp2ImIIURJqv-YbklEVbsNYLPz_akDRwO2lDeEvM";
    const GID = "0";
    const APPS_SCRIPT_EXEC = "https://script.google.com/macros/s/AKfycbzsMVRPSrtbERnCK5nj9NiYNqVXxLsZBSQE5YmCJlxGlx4jeuDdrP7IpEcikGpyDlk6/exec";

    // 모달 열기/닫기
    const modal = document.getElementById('modal');
    function openModal(mode, row) {
      modal.classList.add('show');
      const f = document.getElementById('postForm');
      f.action = APPS_SCRIPT_EXEC;

      if (mode === 'add') {
        document.getElementById('modalTitle').textContent = "요청 추가";
        f.op.value = 'add';
        f.id.value = '';
        f.date.value = '';
        f.who.value = '';
        f.item.value = '';
        f.qty.value = '';
        f.status.value = '요청';
      } else {
        document.getElementById('modalTitle').textContent = "요청 수정";
        f.op.value = 'update';
        f.id.value = row.ID;
        f.date.value = normalizeDate(row['요청일']);
        f.who.value = row['요청자'] || '';
        f.item.value = row['요청물품'] || '';
        f.qty.value = row['개수'] || '';
        f.status.value = (row['진행사항'] || '요청');
      }
    }
    function closeModal(){ modal.classList.remove('show'); }

    document.getElementById('btnOpenAdd').onclick = () => openModal('add');
    document.getElementById('btnCancel').onclick  = closeModal;

    // 폼 제출 후(숨은 iframe load) → 모달 닫고 목록 새로고침
    document.querySelector('iframe[name="hidden_iframe"]').addEventListener('load', () => {
      closeModal(); load();
    });

    // 날짜 문자열 보정
    function normalizeDate(v){
      if (!v) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
      return String(v).replace(/[.\s]/g,'-').replace(/-$/,'').replace(/--/g,'-');
    }

    // 상태 뱃지
    function badge(t){
      const v = (t||'').trim();
      if (v==='완료') return '<span class="badge done">완료</span>';
      if (v==='요청') return '<span class="badge pending">요청</span>';
      if (v) return `<span class="badge">${v}</span>`;
      return '';
    }

    // GViz 응답 → 렌더
    function renderGViz(resp){
      try{
        const table = resp.table;
        const cols = table.cols.map(c=>c.label);
        const rows = table.rows.map(r => r.c.map(c => c ? c.v : ""));

        const idx = {
          id:    cols.indexOf("ID"),
          date:  cols.indexOf("요청일"),
          who:   cols.indexOf("요청자"),
          item:  cols.indexOf("요청물품"),
          qty:   cols.indexOf("개수"),
          stat:  cols.indexOf("진행사항")
        };

        const data = rows.map(r => ({
          ID: r[idx.id],
          '요청일': r[idx.date],
          '요청자': r[idx.who],
          '요청물품': r[idx.item],
          '개수': r[idx.qty],
          '진행사항': r[idx.stat]
        }));

        const tbody = document.getElementById('tbody');
        if (!data.length){
          tbody.innerHTML = '<tr><td colspan="7">데이터가 없습니다.</td></tr>'; return;
        }
        const frag = document.createDocumentFragment();
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.ID||''}</td>
            <td>${row['요청일']||''}</td>
            <td>${row['요청자']||''}</td>
            <td>${row['요청물품']||''}</td>
            <td class="right">${row['개수']||''}</td>
            <td>${badge(row['진행사항'])}</td>
            <td><button class="btn" style="padding:6px 10px" data-id="${row.ID}">수정</button></td>
          `;
          frag.appendChild(tr);
        });
        tbody.innerHTML = '';
        tbody.appendChild(frag);

        // 각 행의 수정 버튼
        tbody.querySelectorAll('button[data-id]').forEach(btn=>{
          btn.onclick = () => {
            const id = btn.getAttribute('data-id');
            const row = data.find(d => String(d.ID)===String(id));
            if (row) openModal('update', row);
          };
        });
      }catch(e){
        document.getElementById('msg').textContent = '표시 실패: ' + e.message;
      }
    }

    // GViz 로더 (JSONP, 캐시 우회용 타임스탬프 포함)
    function load(){
      const old = document.getElementById('gviz');
      if (old) old.remove();
      const s = document.createElement('script');
      s.id = 'gviz';
      s.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json;responseHandler:renderGViz&_=${Date.now()}`;
      document.body.appendChild(s);
    }

    // 전역 핸들러
    window.renderGViz = renderGViz;
    document.getElementById('btnReload').onclick = load;

    // 초기 로드
    load();
  </script>
</body>
</html>
