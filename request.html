<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>요청 현황</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<style>
:root {
  --ink:#0b2239; --muted:#64748b; --bd:#e5e7eb; --panel:#ffffff; --accent:#2563eb;
  --ok:#065f46; --warn:#9a3412; --mid:#3730a3;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Pretendard; color:var(--ink); background:#f4f6fb;}
/* 헤더 */
.appbar{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#fff;border-bottom:1px solid #e6e8ee;position:sticky;top:0;z-index:10;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.appbar img{width:44px;height:44px;object-fit:contain}
.appbar h1{margin:0;font-size:1.5rem;font-weight:800;letter-spacing:-.01em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
/* 레이아웃/툴바 */
.wrap{max-width:1200px;margin:0 auto;padding:18px}
.toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:0 0 14px}
.btn{appearance:none;border:0;border-radius:10px;padding:12px 16px;font-weight:800;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.06)}
.btn.primary{background:var(--accent);color:#fff}
.btn.ghost{background:#fff;color:var(--accent);border:1px solid #93c5fd}
.btn.danger{background:#dc2626;color:#fff}
.input,.select{padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff}
.muted{color:var(--muted);font-size:13px}
/* 카드형 테이블 컨테이너 */
.card{background:var(--panel);border:1px solid var(--bd);border-radius:14px;overflow:auto;box-shadow:0 10px 30px rgba(16,24,40,.06)}
table{width:100%;border-collapse:collapse;font-size:16px}
th,td{padding:14px 12px;border-bottom:1px solid var(--bd);text-align:center;vertical-align:middle}
th{background:#f1f5ff;color:#1e3a8a;font-weight:800;position:sticky;top:0;z-index:1}
tbody tr:nth-child(odd){background:#fcfdff}
tbody tr:hover{background:#f9fbff}
/* 배지 */
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:13px;font-weight:700}
.badge.done{background:#ecfdf5;color:var(--ok)}
.badge.req{background:#fff7ed;color:var(--warn)}
.badge.prog{background:#eef2ff;color:var(--mid)}
/* 페이지네이션 */
.pagination{display:flex;gap:8px;justify-content:flex-end;align-items:center;margin:12px 0}
.page-btn{padding:8px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer}
/* 모달 */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);align-items:center;justify-content:center;z-index:100}
.modal.show{display:flex}
.panel{background:#fff;border-radius:14px;padding:16px 16px 12px;min-width:320px;width:min(92vw,460px);box-shadow:0 20px 60px rgba(0,0,0,.25)}
.field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
/* 저장중 오버레이 + 토스트 */
.saving{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:120}
.saving.hidden{display:none}
.saving .box{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:18px 20px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.2)}
.toast{position:fixed;right:16px;bottom:16px;background:rgba(0,0,0,.85);color:#fff;padding:10px 12px;border-radius:12px;opacity:0;pointer-events:none;transition:.25s;z-index:150}
.toast.show{opacity:1}
</style>
</head>
<body>
  <header class="appbar">
    <img src="./assets/gongdan-mark.png" alt="공단 마크" />
    <h1>요청 현황</h1>
  </header>

  <main class="wrap">
    <div class="toolbar">
      <button class="btn primary" id="btnOpenAdd">추가하기</button>
      <button class="btn ghost" id="btnReload">새로고침</button>
      <button class="btn ghost" id="btnCSV">CSV 내보내기</button>
      <span class="muted" id="summary">총 0건</span>
    </div>

    <div class="card" role="region" aria-label="요청 현황 표">
      <table id="tbl">
        <thead>
          <tr>
            <!-- 화면에는 ID 숨김 -->
            <th data-k="요청일">요청일</th>
            <th data-k="요청자">요청자</th>
            <th data-k="요청물품">요청물품</th>
            <th data-k="개수">개수</th>
            <th data-k="진행사항">진행상태</th>
            <th>빠른변경</th>
            <th>수정</th>
            <th>삭제</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8">불러오는 중...</td></tr>
        </tbody>
      </table>
    </div>

    <div class="pagination">
      <button class="page-btn" id="prev">이전</button>
      <span id="pageinfo" class="muted">0 / 0</span>
      <button class="page-btn" id="next">다음</button>
    </div>
  </main>

  <!-- 추가/수정 모달 -->
  <div class="modal" id="modal" aria-modal="true" role="dialog" aria-labelledby="modalTitle">
    <div class="panel">
      <h3 id="modalTitle" style="margin:0 0 8px 0;font-weight:900">요청 추가</h3>
      <form id="postForm" method="POST" target="hidden_iframe">
        <input type="hidden" name="op" value="add" />
        <input type="hidden" name="id" value="" />
        <div class="field">
          <label for="f_date">요청일</label>
          <input id="f_date" type="date" name="date" required />
        </div>
        <div class="field">
          <label for="f_who">요청자</label>
          <input id="f_who" type="text" name="who" placeholder="요청자" required />
        </div>
        <div class="field">
          <label for="f_item">요청물품</label>
          <input id="f_item" type="text" name="item" placeholder="요청물품" required />
        </div>
        <div class="field">
          <label for="f_qty">개수</label>
          <input id="f_qty" type="number" name="qty" min="1" step="1" required />
        </div>
        <div class="field">
          <label for="f_status">진행상태</label>
          <select id="f_status" name="status" required>
            <option>요청</option>
            <option>진행중</option>
            <option>완료</option>
          </select>
        </div>
        <div class="actions">
          <button type="button" class="btn ghost" id="btnCancel">취소</button>
          <button type="submit" class="btn primary" id="btnSubmit">저장</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 숨은 iframe (POST 응답 수신) -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>

  <!-- 저장 중 팝업 & 토스트 -->
  <div id="savingPopup" class="saving hidden"><div class="box">요청을 저장 중입니다…</div></div>
  <div id="toast" class="toast">처리되었습니다</div>

<script>
/* === 설정 === */
const SHEET_ID = "13-0Qp2ImIIURJqv-YbklEVbsNYLPz_akDRwO2lDeEvM";
const GID      = "0";
const APPS_SCRIPT_EXEC = "https://script.google.com/macros/s/AKfycbyxNNfPgvSeL0o9lSwFRlS7YRrKSt3Qv4baQUOy2oV1M5WkvBu-ciyTKQZuf9p6rPmsDg/exec";

/* === 전역 상태 === */
let raw = [];        // { ID, 요청일, 요청자, 요청물품, 개수, 진행사항 }
let view = [];
let page = 1, pageSize = 10;
let sortKey = "요청일", sortDir = "desc";
let isSubmitting = false;

const $ = (s) => document.querySelector(s);
const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"), 1500); };

/* 날짜 포맷터: YYYY-MM-DD */
function ymd(dateLike){
  if (dateLike == null || dateLike === "") return "";
  // 문자열 포맷 값이 이미 yyyy-mm-dd인 경우
  if (typeof dateLike === "string" && /^\d{4}-\d{2}-\d{2}$/.test(dateLike)) return dateLike;
  // Date 생성 시도
  try{
    const d = new Date(dateLike);
    if (!isNaN(d)) return d.toISOString().slice(0,10);
  }catch(_){ }
  // "YYYY.MM.DD" 등 기타 → 하이픈 치환 후 재시도
  if (typeof dateLike === "string") {
    const s = dateLike.replace(/[./\s]/g, "-");
    const d = new Date(s);
    if (!isNaN(d)) return d.toISOString().slice(0,10);
  }
  return String(dateLike);
}

/* 배지 */
function badge(v){
  const t = (v||"").trim();
  if (t === "완료")   return '<span class="badge done">완료</span>';
  if (t === "요청")   return '<span class="badge req">요청</span>';
  if (t === "진행중") return '<span class="badge prog">진행중</span>';
  return t ? `<span class="badge">${t}</span>` : "";
}

/* === 데이터 로드(GViz JSONP) === */
function load(){
  const old = document.getElementById("gviz"); if (old) old.remove();
  $("#tbody").innerHTML = '<tr><td colspan="8">불러오는 중...</td></tr>';
  const s = document.createElement("script");
  s.id = "gviz";
  s.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json;responseHandler:renderGViz&_=${Date.now()}`;
  document.body.appendChild(s);
}

/* GViz 핸들러 */
window.renderGViz = function(resp){
  try{
    const table = resp.table;
    // 각 셀 객체(c)에 대해: c.f(포맷된 문자열)가 있으면 우선 사용
    const rows = (table.rows||[]).map(r => (r.c||[]).map(c => c ? (c.f ?? c.v) : ""));
    const cols = (table.cols||[]).map(c => c?.label || "");

    const idx = {
      id  : cols.indexOf("ID"),
      date: cols.indexOf("요청일"),
      who : cols.indexOf("요청자"),
      item: cols.indexOf("요청물품"),
      qty : cols.indexOf("개수"),
      stat: cols.indexOf("진행사항"),
    };

    raw = rows.map(cells => ({
      ID       : cells[idx.id],
      요청일   : ymd(cells[idx.date]),
      요청자   : cells[idx.who],
      요청물품 : cells[idx.item],
      개수     : cells[idx.qty],
      진행사항 : cells[idx.stat],
    }))
    // 비어있는 행 제거
    .filter(r => (r.요청자 || r.요청물품));

    applyAndRender();
  }catch(e){
    toast("표시 실패: " + e.message);
  }
};

/* === 렌더 === */
function applyAndRender(){
  // 정렬
  view = [...raw].sort((a,b)=>{
    let A=a[sortKey], B=b[sortKey];
    if (sortKey === "요청일"){
      // 문자열 YYYY-MM-DD 기준 비교
      return (sortDir==='asc') ? (A > B ? 1 : -1) : (A < B ? 1 : -1);
    }
    // 문자열 비교
    A = (A ?? "").toString(); B = (B ?? "").toString();
    return (sortDir==='asc') ? A.localeCompare(B,'ko') : B.localeCompare(A,'ko');
  });

  // 페이지
  const total = Math.max(1, Math.ceil(view.length / pageSize));
  if (page > total) page = total;
  const slice = view.slice((page-1)*pageSize, page*pageSize);
  $("#pageinfo").textContent = `${page} / ${total}`;
  $("#summary").textContent = `총 ${view.length}건`;

  // 테이블 렌더 (ID는 data-id로만 보관)
  const tbody = $("#tbody");
  if (!slice.length){
    tbody.innerHTML = '<tr><td colspan="8">데이터가 없습니다.</td></tr>';
    return;
  }

  const rowsHTML = slice.map(r => `
    <tr data-id="${r.ID ?? ""}">
      <td>${r.요청일 ?? ""}</td>
      <td>${r.요청자 ?? ""}</td>
      <td>${r.요청물품 ?? ""}</td>
      <td>${r.개수 ?? ""}</td>
      <td>${badge(r.진행사항)}</td>
      <td>
        <select class="select" data-quick="${r.ID ?? ""}">
          <option ${r.진행사항==='요청'?'selected':''}>요청</option>
          <option ${r.진행사항==='진행중'?'selected':''}>진행중</option>
          <option ${r.진행사항==='완료'?'selected':''}>완료</option>
        </select>
        <button class="btn ghost" style="padding:6px 10px" data-save="${r.ID ?? ""}">변경</button>
      </td>
      <td><button class="btn" style="padding:6px 10px" data-edit="${r.ID ?? ""}">수정</button></td>
      <td><button class="btn danger" style="padding:6px 10px" data-del="${r.ID ?? ""}">삭제</button></td>
    </tr>
  `).join("");

  tbody.innerHTML = rowsHTML;

  // 이벤트 바인딩
  tbody.querySelectorAll("[data-save]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-save");
      const sel = tbody.querySelector(`select[data-quick="${id}"]`);
      if (!id) return toast("ID 누락으로 변경할 수 없습니다.");
      quickUpdate(id, sel.value);
    };
  });
  tbody.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      const full = raw.find(x => String(x.ID) === String(id));
      if (full) openModal("update", full); else toast("항목을 찾을 수 없습니다.");
    };
  });
  tbody.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-del");
      if (!id) return toast("ID 누락으로 삭제할 수 없습니다.");
      if (confirm(`해당 항목을 삭제할까요? (ID: ${id})`)) quickDelete(id);
    };
  });
}

/* === 모달/폼 === */
const modal = $("#modal");
const form  = $("#postForm");
const btnSubmit = $("#btnSubmit");
const saving = $("#savingPopup");

$("#btnOpenAdd").onclick = ()=> openModal("add");
$("#btnCancel").onclick  = ()=> modal.classList.remove("show");

function openModal(mode, row){
  modal.classList.add("show");
  form.action = APPS_SCRIPT_EXEC;
  if (mode === "add"){
    $("#modalTitle").textContent = "요청 추가";
    form.op.value = "add";
    form.id.value = "";
    form.date.value = "";
    form.who.value  = "";
    form.item.value = "";
    form.qty.value  = "";
    form.status.value = "요청";
  } else {
    $("#modalTitle").textContent = "요청 수정";
    form.op.value = "update";
    form.id.value = row.ID ?? "";
    form.date.value = row.요청일 ?? "";
    form.who.value  = row.요청자 ?? "";
    form.item.value = row.요청물품 ?? "";
    form.qty.value  = row.개수 ?? "";
    form.status.value = (row.진행사항 ?? "요청");
  }
}

form.addEventListener("submit", (e)=>{
  if (isSubmitting) { e.preventDefault(); return; }
  isSubmitting = true;
  btnSubmit.disabled = true;
  btnSubmit.textContent = "저장 중…";
  saving.classList.remove("hidden");
});

document.getElementById("hidden_iframe").addEventListener("load", ()=>{
  isSubmitting = false;
  btnSubmit.disabled = false;
  btnSubmit.textContent = "저장";
  saving.classList.add("hidden");
  modal.classList.remove("show");
  toast("처리되었습니다");
  load();
});

/* === 상태 변경/삭제 === */
function quickUpdate(id, status){
  const f = document.createElement("form");
  f.method = "POST"; f.action = APPS_SCRIPT_EXEC; f.target = "hidden_iframe";
  [["op","update"], ["id",id], ["status",status]].forEach(([k,v])=>{
    const i = document.createElement("input"); i.type="hidden"; i.name=k; i.value=v; f.appendChild(i);
  });
  document.body.appendChild(f); f.submit();
  toast("상태 변경 중…");
}
function quickDelete(id){
  const f = document.createElement("form");
  f.method = "POST"; f.action = APPS_SCRIPT_EXEC; f.target = "hidden_iframe";
  [["op","delete"], ["id",id]].forEach(([k,v])=>{
    const i = document.createElement("input"); i.type="hidden"; i.name=k; i.value=v; f.appendChild(i);
  });
  document.body.appendChild(f); f.submit();
  toast("삭제 중…");
}

/* === 페이지네이션/정렬/기타 === */
document.getElementById("prev").onclick = ()=>{ if(page>1){ page--; applyAndRender(); } };
document.getElementById("next").onclick = ()=>{ page++; applyAndRender(); };
document.querySelectorAll('th[data-k]').forEach(th=>{
  th.onclick = ()=>{
    const k = th.getAttribute('data-k');
    if (sortKey === k) sortDir = (sortDir === "asc" ? "desc" : "asc");
    else { sortKey = k; sortDir = "asc"; }
    applyAndRender();
  };
});
document.getElementById("btnReload").onclick = load;
document.getElementById("btnCSV").onclick = ()=>{
  const header = ["요청일","요청자","요청물품","개수","진행상태"];
  const rows = view.map(r => [r.요청일, r.요청자, r.요청물품, r.개수, r.진행사항]);
  const csv = [header].concat(rows).map(a=>a.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `requests_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url);
};

/* 초기 로드 */
load();
</script>
</body>
</html>
