<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>í†µí•© ìì¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
<style>
  :root{
    --ink:#1e293b; --muted:#64748b; --bd:#e2e8f0; --panel:#ffffff; --bg-body:#f1f5f9;
    --accent:#2563eb; --accent-hover:#1d4ed8;
    --danger:#ef4444; --success:#10b981; --warn:#f59e0b;
    --radius:12px; --shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }
  *{box-sizing:border-box; outline:none;}
  html,body{height:100%; margin:0; padding:0; font-family:'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; color:var(--ink); background:var(--bg-body); font-size:15px;}
  
  /* === ë ˆì´ì•„ì›ƒ === */
  .appbar{position:sticky; top:0; z-index:50; background:rgba(255,255,255,0.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--bd); padding:0 20px; height:64px; display:flex; align-items:center; justify-content:space-between;}
  .brand{font-weight:800; font-size:20px; color:var(--accent); display:flex; align-items:center; gap:8px;}
  
  .nav-tabs{display:flex; gap:4px; background:#f1f5f9; padding:4px; border-radius:10px;}
  .nav-tab{border:none; background:transparent; padding:8px 16px; border-radius:8px; font-weight:600; color:var(--muted); cursor:pointer; transition:all .2s; font-size:14px;}
  .nav-tab.active{background:#fff; color:var(--accent); box-shadow:0 1px 3px rgba(0,0,0,0.1);}

  .main-container{max-width:1200px; margin:24px auto; padding:0 20px 80px;}
  .view-section{display:none; animation:fadeIn .3s ease-out;}
  .view-section.active{display:block;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

  /* === íŒ¨ë„ & íˆ´ë°” === */
  .panel{background:var(--panel); border:1px solid var(--bd); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; margin-bottom:24px;}
  .toolbar{display:flex; flex-wrap:wrap; gap:12px; padding:16px; background:#fff; border-bottom:1px solid var(--bd); align-items:center;}
  .spacer{flex:1;}
  
  /* === ë²„íŠ¼ & ì…ë ¥ === */
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:6px; padding:0 16px; height:42px; border:1px solid var(--bd); border-radius:8px; background:#fff; color:var(--ink); font-weight:600; font-size:14px; cursor:pointer; transition:all .2s;}
  .btn:hover{background:#f8fafc; border-color:#cbd5e1;}
  .btn:active{transform:scale(0.98);}
  
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent);}
  .btn.primary:hover{background:var(--accent-hover);}
  .btn.danger{background:#fff; color:var(--danger); border-color:var(--bd);}
  .btn.danger:hover{background:#fef2f2; border-color:var(--danger);}
  
  /* ë¯¸ë‹ˆ ë²„íŠ¼ (ì¬ê³  ì¡°ì ˆìš©) */
  .btn-mini{width:32px; height:32px; border-radius:6px; border:1px solid var(--bd); background:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; color:var(--muted); transition:.2s;}
  .btn-mini:hover{background:#f1f5f9; color:var(--accent); border-color:var(--accent);}

  .input, .select{height:42px; padding:0 14px; border:1px solid var(--bd); border-radius:8px; background:#fff; font-size:14px; transition:.2s;}
  .input:focus, .select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(37,99,235,0.1);}
  .input.search{width:300px;}

  /* === í…Œì´ë¸” ë””ìì¸ ê°œì„  === */
  .table-wrap{overflow-x:auto;}
  table{width:100%; border-collapse:collapse; white-space:nowrap; font-size:15px;}
  
  th{background:#f8fafc; color:#475569; font-weight:700; text-align:left; padding:14px 16px; border-bottom:1px solid var(--bd);}
  td{padding:16px; border-bottom:1px solid var(--bd); vertical-align:middle; color:#334155;}
  tr:hover td{background-color:#f8fafc;} /* í–‰ í˜¸ë²„ íš¨ê³¼ */

  .td-meta{display:flex; flex-direction:column; gap:2px;}
  .td-meta .main{font-weight:600; color:var(--ink);}
  .td-meta .sub{font-size:13px; color:#94a3b8;}

  .avatar{width:48px; height:48px; border-radius:8px; object-fit:cover; background:#f1f5f9; border:1px solid var(--bd); cursor:zoom-in; transition:transform 0.2s;}
  .avatar:hover{transform:scale(1.1); border-color:var(--accent);}
  
  /* ì¬ê³  ì»¨íŠ¸ë¡¤ëŸ¬ */
  .stock-ctrl{display:flex; align-items:center; gap:8px; background:#f8fafc; padding:4px; border-radius:8px; border:1px solid var(--bd); width:fit-content;}
  .stock-val{font-weight:700; min-width:36px; text-align:center; color:var(--ink);}

  /* ë±ƒì§€ */
  .badge{display:inline-flex; padding:4px 10px; border-radius:99px; font-size:12px; font-weight:700; line-height:1;}
  .badge.req{background:#fff7ed; color:#ea580c;}
  .badge.prog{background:#eff6ff; color:#2563eb;}
  .badge.done{background:#f0fdf4; color:#16a34a;}

  /* ëª¨ë°”ì¼ ì¹´ë“œ ë·° */
  .cards{display:none; grid-template-columns:1fr; gap:16px;}
  .card{background:#fff; border:1px solid var(--bd); border-radius:16px; padding:16px; display:flex; gap:16px; align-items:start; box-shadow:var(--shadow);}
  @media (max-width: 768px){
    .table-wrap{display:none;}
    .cards{display:grid;}
    .input.search{width:100%;}
    .stock-ctrl{width:100%; justify-content:center; margin-top:8px;}
  }

  /* ëª¨ë‹¬ */
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:100; backdrop-filter:blur(4px);}
  .modal-backdrop.show{display:flex;}
  .modal-box{width:min(600px, 90vw); background:#fff; border-radius:20px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); overflow:hidden; animation:slideUp .3s cubic-bezier(0.16, 1, 0.3, 1);}
  @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  
  .modal-head{padding:20px; border-bottom:1px solid var(--bd); display:flex; justify-content:space-between; align-items:center; background:#fff;}
  .modal-body{padding:24px; max-height:70vh; overflow-y:auto;}
  .modal-foot{padding:20px; border-top:1px solid var(--bd); display:flex; justify-content:flex-end; gap:12px; background:#f8fafc;}
  
  .grid-form{display:grid; grid-template-columns:1fr 1fr; gap:20px;}
  .field{display:flex; flex-direction:column; gap:8px;}
  .field label{font-size:14px; font-weight:600; color:var(--muted);}

  /* ë¼ì´íŠ¸ë°•ìŠ¤ */
  #lightbox{position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:999; display:none; align-items:center; justify-content:center; cursor:zoom-out;}
  #lightbox.show{display:flex; animation:fadeIn .2s;}
  #lightbox img{max-width:90vw; max-height:90vh; border-radius:8px; box-shadow:0 0 40px rgba(0,0,0,0.5); cursor:default;}

  /* ì¥ë°”êµ¬ë‹ˆ */
  .cart-panel{background:#eff6ff; border:1px solid #bfdbfe; border-radius:16px; padding:20px; margin-top:24px;}
  .cart-item{display:flex; justify-content:space-between; align-items:center; background:#fff; padding:12px 16px; border-radius:10px; margin-bottom:10px; border:1px solid var(--bd); box-shadow:0 1px 2px 0 rgba(0,0,0,0.05);}

  .toast{position:fixed; bottom:24px; right:24px; background:#1e293b; color:#fff; padding:14px 24px; border-radius:12px; font-weight:600; opacity:0; pointer-events:none; transition:.3s; z-index:200; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);}
  .toast.on{opacity:1; transform:translateY(-10px);}
</style>
</head>
<body>

<header class="appbar">
  <div class="brand">ğŸ“¦ í†µí•© ìì¬ ê´€ë¦¬</div>
  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('tab-inventory')">ë¬¼í’ˆ ì‹ ì²­</button>
    <button class="nav-tab" onclick="switchTab('tab-status')">ì‹ ì²­ í˜„í™©</button>
  </nav>
</header>

<main class="main-container">
  <section id="tab-inventory" class="view-section active">
    <div class="panel">
      <div class="toolbar">
        <div style="display:flex; flex-direction:column; gap:2px;">
          <strong style="font-size:16px;">ì¬ê³  ëª©ë¡</strong>
          <span id="invCount" style="font-size:13px; color:var(--muted);">0ê°œ í•­ëª©</span>
        </div>
        <div class="spacer"></div>
        <input type="search" id="invSearch" class="input search" placeholder="ê²€ìƒ‰: ë¬¼í’ˆëª…, ê¸°ê¸°, ê·œê²©...">
        <button class="btn primary" onclick="openItemModal(null)">+ ìƒˆ ë¬¼í’ˆ ë“±ë¡</button>
        </div>
      
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th width="80">ì‚¬ì§„</th>
              <th>ë¬¼í’ˆ ì •ë³´</th>
              <th width="150">ê¸°ê¸° / ìœ„ì¹˜</th>
              <th width="160" style="text-align:center">ì¬ê³  ê´€ë¦¬</th>
              <th width="200">ë¹„ê³ </th>
              <th width="140" style="text-align:right">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="invTbody"></tbody>
        </table>
      </div>
      <div class="cards" id="invCards"></div>
    </div>

    <div class="cart-panel">
      <h3 style="margin:0 0 16px 0; font-size:18px; color:#1e3a8a;">ğŸ›’ ì‹ ì²­ ë°”êµ¬ë‹ˆ</h3>
      <div id="cartList">
        <div style="color:var(--muted); text-align:center; padding:32px; border:2px dashed #bfdbfe; border-radius:12px;">ëª©ë¡ì—ì„œ [ë‹´ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
      </div>
      <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap; padding-top:20px; border-top:1px solid #bfdbfe;">
        <input type="text" id="reqWho" class="input" placeholder="ì‹ ì²­ì ì´ë¦„ (í•„ìˆ˜)" style="width:160px;">
        <input type="text" id="reqNote" class="input" placeholder="ì‹ ì²­ ì‚¬ìœ  / ë¹„ê³ " style="flex:1;">
        <button class="btn primary" id="btnRealSubmit" style="padding:0 24px;">ì‹ ì²­ì„œ ì œì¶œ</button>
      </div>
    </div>
  </section>

  <section id="tab-status" class="view-section">
    <div class="panel">
      <div class="toolbar">
        <strong>ì§„í–‰ í˜„í™©</strong>
        <div class="spacer"></div>
        <button class="btn" onclick="loadStatusData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        <select id="statusFilter" class="select" onchange="renderStatusTable()">
          <option value="">ì „ì²´ ìƒíƒœ</option><option>ìš”ì²­</option><option>ì§„í–‰ì¤‘</option><option>ì™„ë£Œ</option>
        </select>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th width="80">ì‚¬ì§„</th>
              <th>ë¬¼í’ˆ ì •ë³´</th>
              <th>ì‹ ì²­ ì •ë³´</th>
              <th>ìƒíƒœ</th>
              <th width="100" style="text-align:right">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="statusTbody">
            <tr><td colspan="5" style="text-align:center; padding:40px; color:var(--muted);">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="cards" id="statusCards"></div>
    </div>
  </section>
</main>

<div id="itemModal" class="modal-backdrop">
  <div class="modal-box">
    <div class="modal-head">
      <h3 style="margin:0; font-size:18px;">ë¬¼í’ˆ ì •ë³´ ê´€ë¦¬</h3>
      <button class="btn-mini" onclick="closeModal('itemModal')" style="border:none; font-size:20px;">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editId">
      <div class="grid-form">
        <div class="field">
          <label>ë¬¼í’ˆëª…</label>
          <input type="text" id="editName" class="input" placeholder="ì˜ˆ: ë³¼íŠ¸">
        </div>
        <div class="field">
          <label>ì‚¬ìš© ê¸°ê¸°</label>
          <input type="text" id="editDevice" class="input" list="deviceList" placeholder="ì˜ˆ: ê¸°ê³„ A">
          <datalist id="deviceList"></datalist>
        </div>
        <div class="field">
          <label>ê·œê²© (Spec)</label>
          <input type="text" id="editSpec" class="input" placeholder="ì˜ˆ: M5, 20mm">
        </div>
        <div class="field">
          <label>ì´ˆê¸° ì¬ê³ </label>
          <input type="number" id="editQty" class="input" value="0">
        </div>
        <div class="field" style="grid-column: span 2;">
          <label>êµ¬ë§¤ ë§í¬</label>
          <input type="text" id="editLink" class="input" placeholder="https://...">
        </div>
        <div class="field" style="grid-column: span 2;">
          <label>ì‚¬ì§„ (íŒŒì¼ ì„ íƒ ì‹œ ìë™ ì••ì¶•)</label>
          <div style="display:flex; gap:8px;">
            <input type="text" id="editImg" class="input" placeholder="ì´ë¯¸ì§€ ì½”ë“œê°€ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" style="flex:1; color:var(--muted);" readonly>
            <label class="btn primary" style="cursor:pointer;">
              ğŸ“· ì‚¬ì§„ ì„ íƒ <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="compressImage(this)">
            </label>
          </div>
          <div style="font-size:12px; color:var(--danger); margin-top:4px;" id="imgMsg"></div>
        </div>
        <div class="field" style="grid-column: span 2;">
          <label>ë¹„ê³ </label>
          <textarea id="editMemo" class="input" style="height:80px; resize:vertical;"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn danger" onclick="deleteItem()">ì‚­ì œ</button>
      <div class="spacer"></div>
      <button class="btn" onclick="closeModal('itemModal')">ì·¨ì†Œ</button>
      <button class="btn primary" onclick="saveItem()">ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</div>

<div id="lightbox" onclick="this.classList.remove('show')">
  <img id="lightboxImg" src="" onclick="event.stopPropagation()">
</div>

<iframe name="hidden_iframe" style="display:none;"></iframe>
<div id="toast" class="toast">ë©”ì‹œì§€</div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxrdUhrj6CAwWEoVER9VmlEh7YWfw0D12AtNR_lJ8iror7zbE9jKTEkmZwW8IISfTRfNg/exec";

const $ = (s) => document.querySelector(s);
const ls = { get: (k) => JSON.parse(localStorage.getItem(k) || '[]'), set: (k, v) => localStorage.setItem(k, JSON.stringify(v)) };
const uid = () => Math.random().toString(36).slice(2, 9);
function showToast(msg) { const t = $('#toast'); t.textContent = msg; t.classList.add('on'); setTimeout(() => t.classList.remove('on'), 2000); }

function switchTab(tabId) {
  document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
  const btns = document.querySelectorAll('.nav-tab');
  if(tabId === 'tab-inventory') btns[0].classList.add('active');
  if(tabId === 'tab-status') { btns[1].classList.add('active'); loadStatusData(); }
  $('#' + tabId).classList.add('active');
}

function viewImage(src) {
  if(!src) return;
  $('#lightboxImg').src = src;
  $('#lightbox').classList.add('show');
}

function compressImage(input) {
  const file = input.files[0];
  if(!file) return;
  if(file.size > 10 * 1024 * 1024) { alert("íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤."); input.value=""; return; }

  const btn = input.parentElement;
  const orgText = btn.innerHTML;
  btn.textContent = "ë³€í™˜ ì¤‘...";
  btn.style.pointerEvents = "none";

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const MAX = 400; 
      let w = img.width, h = img.height;
      if(w > MAX) { h *= MAX/w; w = MAX; }
      canvas.width = w; canvas.height = h;
      ctx.drawImage(img, 0, 0, w, h);
      
      let data = canvas.toDataURL('image/jpeg', 0.5);
      if(data.length > 50000) data = canvas.toDataURL('image/jpeg', 0.3);

      if(data.length > 50000) {
        $('#imgMsg').textContent = "âŒ ì‚¬ì§„ì´ ë„ˆë¬´ ë³µì¡í•©ë‹ˆë‹¤. ë” ë‹¨ìˆœí•œ ì‚¬ì§„ì„ ì¨ì£¼ì„¸ìš”.";
        $('#editImg').value = "";
      } else {
        $('#editImg').value = data;
        $('#imgMsg').textContent = `âœ… ë³€í™˜ ì™„ë£Œ (${Math.round(data.length/1024)}KB)`;
        $('#imgMsg').style.color = "var(--success)";
      }
      btn.innerHTML = orgText;
      btn.style.pointerEvents = "auto";
    };
  };
  reader.readAsDataURL(file);
}

// === ì¸ë²¤í† ë¦¬ ë¡œì§ ===
let inventory = ls.get('admin_inventory');
let cart = [];

// [ê¸°ëŠ¥] ì¬ê³  ìˆ˜ëŸ‰ ì¦‰ì‹œ ë³€ê²½
function changeStock(id, delta) {
  const item = inventory.find(x => x.id === id);
  if (item) {
    let newQty = Number(item.qty) + delta;
    if (newQty < 0) newQty = 0;
    item.qty = newQty;
    ls.set('admin_inventory', inventory);
    renderInventory(); // í™”ë©´ ê°±ì‹ 
  }
}

function renderInventory() {
  const tbody = $('#invTbody');
  const cards = $('#invCards');
  const q = $('#invSearch').value.toLowerCase();
  const list = inventory.filter(i => 
    (i.name || '').toLowerCase().includes(q) || 
    (i.device || '').toLowerCase().includes(q) || 
    (i.spec || '').toLowerCase().includes(q)
  );
  $('#invCount').textContent = `ì´ ${list.length}ê°œ í•­ëª©`;

  const getImgTag = (src) => `<img src="${src || ''}" class="avatar" loading="lazy" onerror="this.style.background='#f1f5f9'" onclick="viewImage('${src}')">`;

  // í…Œì´ë¸” ë Œë”ë§
  const htmlRows = list.map(item => `
    <tr>
      <td>${getImgTag(item.img)}</td>
      <td>
        <div class="td-meta">
          <span class="main">${item.name}</span>
          <span class="sub">${item.spec || '-'}</span>
        </div>
      </td>
      <td>${item.device}</td>
      <td style="text-align:center">
        <div class="stock-ctrl" style="margin:0 auto">
          <button class="btn-mini" onclick="changeStock('${item.id}', -1)">â–</button>
          <span class="stock-val">${item.qty}</span>
          <button class="btn-mini" onclick="changeStock('${item.id}', 1)">â•</button>
        </div>
      </td>
      <td style="color:var(--muted); font-size:14px;">${item.memo || '-'}</td>
      <td style="text-align:right">
        <button class="btn" style="padding:6px 12px; height:36px;" onclick="openItemModal('${item.id}')">ìˆ˜ì •</button>
        <button class="btn primary" style="padding:6px 12px; height:36px;" onclick="addToCart('${item.id}')">ë‹´ê¸°</button>
      </td>
    </tr>
  `).join('');

  // ì¹´ë“œ ë Œë”ë§ (ëª¨ë°”ì¼)
  const htmlCards = list.map(item => `
    <div class="card">
      ${getImgTag(item.img)}
      <div style="flex:1">
        <div style="font-weight:700; font-size:16px; margin-bottom:4px;">${item.name}</div>
        <div style="font-size:13px; color:var(--muted); margin-bottom:12px;">
          ${item.device} Â· ${item.spec || '-'}
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <div class="stock-ctrl">
            <button class="btn-mini" onclick="changeStock('${item.id}', -1)">â–</button>
            <span class="stock-val">${item.qty}</span>
            <button class="btn-mini" onclick="changeStock('${item.id}', 1)">â•</button>
          </div>
        </div>

        <div style="display:flex; gap:8px;">
          <button class="btn" style="flex:1; height:36px;" onclick="openItemModal('${item.id}')">ìˆ˜ì •</button>
          <button class="btn primary" style="flex:1; height:36px;" onclick="addToCart('${item.id}')">ë‹´ê¸°</button>
        </div>
      </div>
    </div>
  `).join('');

  tbody.innerHTML = htmlRows || '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--muted);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  cards.innerHTML = htmlCards;
}

function openItemModal(id) {
  const modal = $('#itemModal');
  const item = id ? inventory.find(x => x.id === id) : null;
  $('#editId').value = id || '';
  $('#editName').value = item ? item.name : '';
  $('#editDevice').value = item ? item.device : '';
  $('#editSpec').value = item ? item.spec : '';
  $('#editQty').value = item ? item.qty : '0';
  $('#editLink').value = item ? item.link : '';
  $('#editImg').value = item ? item.img : '';
  $('#editMemo').value = item ? item.memo : '';
  $('#fileInput').value = ''; 
  $('#imgMsg').textContent = "";
  modal.classList.add('show');
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function saveItem() {
  const id = $('#editId').value || uid();
  const newItem = { 
    id: id, 
    name: $('#editName').value, 
    device: $('#editDevice').value, 
    spec: $('#editSpec').value,
    qty: Number($('#editQty').value), 
    link: $('#editLink').value,
    img: $('#editImg').value, 
    memo: $('#editMemo').value 
  };
  const idx = inventory.findIndex(x => x.id === newItem.id);
  if(idx >= 0) inventory[idx] = newItem; else inventory.unshift(newItem);
  ls.set('admin_inventory', inventory);
  closeModal('itemModal');
  renderInventory();
  showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function deleteItem() {
  const id = $('#editId').value;
  if(!id || !confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  inventory = inventory.filter(x => x.id !== id);
  ls.set('admin_inventory', inventory);
  closeModal('itemModal');
  renderInventory();
}

function addToCart(id) {
  const item = inventory.find(x => x.id === id);
  const exist = cart.find(x => x.id === id);
  if(exist) exist.count++; else cart.push({ ...item, count: 1 });
  renderCart();
  showToast('ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.');
}

function renderCart() {
  const container = $('#cartList');
  if(cart.length === 0) { container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:32px;border:2px dashed #bfdbfe;border-radius:12px;">ëª©ë¡ì—ì„œ [ë‹´ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>'; return; }
  container.innerHTML = cart.map((c, idx) => `
    <div class="cart-item">
      <div>
        <div style="font-weight:700; color:var(--ink);">${c.name}</div>
        <div style="font-size:13px; color:var(--muted);">${c.spec || c.device}</div>
      </div>
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="btn-mini" onclick="modCart(${idx}, -1)">â–</button>
        <span style="font-weight:700; min-width:24px; text-align:center;">${c.count}</span>
        <button class="btn-mini" onclick="modCart(${idx}, 1)">â•</button>
        <button class="btn danger" style="padding:0; width:32px; height:32px; margin-left:8px;" onclick="modCart(${idx}, -999)">âœ•</button>
      </div>
    </div>
  `).join('');
}

function modCart(idx, diff) {
  if(diff === -999) cart.splice(idx, 1);
  else { cart[idx].count += diff; if(cart[idx].count <= 0) cart.splice(idx, 1); }
  renderCart();
}

$('#btnRealSubmit').onclick = function() {
  if(cart.length === 0) return alert('ì‹ ì²­í•  ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
  const who = $('#reqWho').value.trim();
  if(!who) return alert('ì‹ ì²­ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  
  const btn = this; btn.disabled = true; btn.textContent = 'ì „ì†¡ ì¤‘...';
  const promises = cart.map(item => {
    const formData = new FormData();
    formData.append('op', 'add');
    formData.append('item', item.name);
    formData.append('device', item.device);
    formData.append('spec', item.spec || '');
    formData.append('stock', item.qty);
    formData.append('status', 'ìš”ì²­');
    formData.append('who', who);
    formData.append('date', new Date().toISOString().slice(0,10));
    formData.append('qty', item.count);
    formData.append('img', item.img || ''); 
    formData.append('link', item.link || ''); 
    formData.append('note', $('#reqNote').value);
    return fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
  });

  Promise.all(promises).then(() => {
    alert(`ì„±ê³µì ìœ¼ë¡œ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.`); cart = []; $('#reqNote').value = ''; renderCart(); switchTab('tab-status');
  }).catch(err => { alert('ì¼ë¶€ ì „ì†¡ ì‹¤íŒ¨'); }).finally(() => { btn.disabled = false; btn.textContent = 'ì‹ ì²­ì„œ ì œì¶œ'; });
};

// === í˜„í™© ë¡œì§ ===
let statusData = [];
function loadStatusData() {
  const tbody = $('#statusTbody'); tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--muted);">êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
  const old = document.getElementById('jsonp_loader'); if(old) old.remove();
  window['onStatusLoaded'] = function(res) {
    if(res && res.rows) { statusData = res.rows; renderStatusTable(); } 
    else { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>'; }
  };
  const script = document.createElement('script'); script.id = 'jsonp_loader';
  script.src = `${APPS_SCRIPT_URL}?op=read&cb=onStatusLoaded`; document.body.appendChild(script);
}

function renderStatusTable() {
  const filter = $('#statusFilter').value;
  const tbody = $('#statusTbody');
  const cards = $('#statusCards');
  const list = statusData.filter(row => { if(filter && row.ìš”ì²­ìƒíƒœ !== filter) return false; return true; });

  if(list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--muted);">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    cards.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted);">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  
  const getBadge = (st) => st === 'ìš”ì²­' ? '<span class="badge req">ìš”ì²­</span>' : st === 'ì§„í–‰ì¤‘' ? '<span class="badge prog">ì§„í–‰ì¤‘</span>' : '<span class="badge done">ì™„ë£Œ</span>';
  const getImgTag = (src) => `<img src="${src || ''}" class="avatar" loading="lazy" onerror="this.style.background='#f1f5f9'" onclick="viewImage('${src}')">`;

  tbody.innerHTML = list.map(r => `
    <tr>
      <td>${getImgTag(r.ì‚¬ì§„)}</td>
      <td>
        <div class="td-meta">
          <span class="main">${r.ë¬¼í’ˆëª…}</span>
          <span class="sub">${r.ê·œê²© || '-'}</span>
        </div>
      </td>
      <td>
        <div class="td-meta">
          <span class="main">${r.ìš”ì²­ì}</span>
          <span class="sub">${r.ê°œìˆ˜}ê°œ Â· ${(r.ìš”ì²­ì¼||'').substring(0,10)}</span>
        </div>
      </td>
      <td>${getBadge(r.ìš”ì²­ìƒíƒœ)}</td>
      <td style="text-align:right;">
        <button class="btn" style="padding:6px 12px; height:36px;" onclick="updateStatus('${r.ID}', 'ì™„ë£Œ')">ì™„ë£Œ</button>
      </td>
    </tr>
  `).join('');

  cards.innerHTML = list.map(r => `
    <div class="card">
      ${getImgTag(r.ì‚¬ì§„)}
      <div style="flex:1">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <strong style="font-size:16px;">${r.ë¬¼í’ˆëª…}</strong>
          ${getBadge(r.ìš”ì²­ìƒíƒœ)}
        </div>
        <div style="font-size:13px; color:var(--muted); margin-bottom:16px;">
          ${r.ìš”ì²­ì} Â· ${r.ê°œìˆ˜}ê°œ Â· ${(r.ìš”ì²­ì¼||'').substring(0,10)}<br>
          ${r.ê·œê²© || ''}
        </div>
        <div style="text-align:right;">
          <button class="btn" style="width:100%; height:40px;" onclick="updateStatus('${r.ID}', 'ì™„ë£Œ')">ì™„ë£Œ ì²˜ë¦¬</button>
        </div>
      </div>
    </div>
  `).join('');
}

function updateStatus(id, status) {
  if(!confirm(`'${status}' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  const form = document.createElement('form'); form.method = 'POST'; form.action = APPS_SCRIPT_URL; form.target = 'hidden_iframe';
  [{name:'op',value:'update'},{name:'id',value:id},{name:'status',value:status}].forEach(d=>{
    const i=document.createElement('input'); i.type='hidden'; i.name=d.name; i.value=d.value; form.appendChild(i);
  });
  document.body.appendChild(form); form.submit();
  showToast('ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.'); setTimeout(loadStatusData, 2000);
}

document.addEventListener('DOMContentLoaded', () => { renderInventory(); $('#invSearch').addEventListener('input', renderInventory); });
</script>
</body>
</html>