<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<meta name="robots" content="noindex,nofollow,noarchive" />

<!-- Leaflet & MarkerCluster -->
<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin="">
<link rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  :root{ --HDR-H: 64px; }
  *{ box-sizing:border-box }
  html, body { height:100%; margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,Arial; }
  body { background:#f5f7fb; color:#0b2239; }

  /* ìƒë‹¨ í—¤ë” */
  .appbar{
    height:var(--HDR-H); display:flex; align-items:center; gap:14px;
    padding:0 16px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06);
    position:sticky; top:0; z-index:1000;
  }
  .logo-img{ width:44px; height:44px; object-fit:contain; filter:drop-shadow(0 2px 4px rgba(0,0,0,.12)); }
  .title-text{ min-width:0; }
  .title-text h1{
    margin:0; font-weight:800; letter-spacing:-0.02em; line-height:1.1;
    font-size: clamp(18px, 4.2vw, 26px);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* ì§€ë„ ì˜ì—­ (svh í´ë°± í¬í•¨) */
  .map-wrap{
    position:relative;
    height: calc(100svh - var(--HDR-H));
    height: calc(100vh - var(--HDR-H)); /* í´ë°± */
    min-height: 400px;
  }
  #map{ width:100%; height:100%; min-height:300px; } /* ì•ˆì „ì¥ì¹˜ */

  /* UI íŒ¨ë„/ë²„íŠ¼ */
  .filter-panel{
    position:absolute; left:10px; top:10px; z-index:1000;
    background:rgba(255,255,255,0.96); padding:8px 10px; border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,0.2);
    display:inline-flex; flex-direction:column; gap:6px; font-size:14px;
  }
  .filter-panel h2{
    margin:0 0 6px; font-size:13px; font-weight:700; color:#365b7a;
  }
  label{ display:flex; align-items:center; gap:6px; white-space:nowrap; cursor:pointer; }

  .floating-btn{
    position:absolute; bottom:20px; right:20px; z-index:1200;
    width:52px; height:52px; border-radius:50%; background:#0078ff; color:#fff;
    font-size:26px; font-weight:bold; border:none;
    box-shadow:0 3px 8px rgba(0,0,0,0.3);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; transition:.2s ease;
  }
  .floating-btn:hover{ background:#005fcc; transform:scale(1.05); }

  .toast{
    position:fixed; bottom:90px; right:20px; z-index:2000;
    background:rgba(0,0,0,0.86); color:#fff; padding:10px 14px; border-radius:8px; font-size:14px;
    opacity:0; pointer-events:none; transition:opacity .25s ease;
  }
  .toast.show{ opacity:1; }

  .leaflet-tooltip.station-tooltip{
    font-weight:bold; font-size:14px; color:#222; text-shadow:1px 1px 2px #fff;
  }

  /* ë‚´ ìœ„ì¹˜ ë§ˆì»¤(ë‘¥ê·¼ ì +ë§) */
  .me-dot{
    width:16px; height:16px; border:3px solid #0ea5e9; background:#38bdf8; border-radius:999px;
    box-shadow:0 0 0 4px rgba(56,189,248,.25);
  }

  @media (max-width:420px){
    .logo-img{ width:40px; height:40px; }
    .title-text h1{ font-size: clamp(16px, 5vw, 22px); }
  }
  @media (prefers-reduced-motion: reduce){
    .floating-btn{ transition:none }
    .toast{ transition:none }
  }
</style>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="appbar">
    <img class="logo-img" src="./assets/gongdan-mark.png" alt="ê³µë‹¨ ë§ˆí¬" />
    <div class="title-text"><h1>ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„</h1></div>
  </header>

  <!-- ì§€ë„ -->
  <main class="map-wrap">
    <div class="filter-panel" role="region" aria-label="ìœ í˜• í•„í„°">
      <h2>í‘œì‹œ ìœ í˜•</h2>
      <label><input type="checkbox" id="showSmall" checked> ì†Œê·œëª¨</label>
      <label><input type="checkbox" id="showStream" checked> í•˜ì²œ</label>
      <label><input type="checkbox" id="showStation" checked> ì¸¡ì •ì†Œ</label>
      <button id="fitBtn" style="margin-top:6px;border:1px solid #d0d7e2;background:#f7fbff;border-radius:8px;padding:6px 10px;cursor:pointer">ì§€ë„ ë§ì¶”ê¸°</button>
    </div>

    <div id="map" role="region" aria-label="ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„"></div>

    <button class="floating-btn gps-btn" id="gpsBtn" aria-label="ë‚´ ìœ„ì¹˜ ì¶”ì  ì „í™˜">ğŸ“</button>
    <div class="toast" id="toast" role="status" aria-live="polite">ğŸ“¡ ìœ„ì¹˜ ê¸°ëŠ¥</div>
  </main>

<script>
/* ===== ê¸°ë³¸ ì„¤ì • ===== */
// ì´ˆê¸° ì¤‘ì‹¬
const INITIAL_CENTER = [37.4106329, 127.1255116];
const INITIAL_ZOOM   = 16;

/* ë¯¼ê° ë°ì´í„°ëŠ” JSì— í•˜ë“œì½”ë”©í•˜ì§€ ì•Šê³ , ë³´í˜¸ëœ ê²½ë¡œì—ì„œ ë¶ˆëŸ¬ì˜¨ë‹¤. (_headersë¡œ /data/* ë³´í˜¸) */
const DATA_URL = "/assets/markers.json";

/* URL í•´ì‹œ ê³µìœ (#z/lat/lng) */
function readHash(){
  const m = location.hash.match(/^#(\d+)\/([\d.-]+)\/([\d.-]+)/);
  if(!m) return null;
  return { z: +m[1], lat: +m[2], lng: +m[3] };
}
function writeHash(z, center){
  history.replaceState(null, "", `#${z}/${center.lat.toFixed(5)}/${center.lng.toFixed(5)}`);
}

/* í•„í„° ì €ì¥ í‚¤ */
const LS_KEY = "wms_filters_v1";

/* ===== ì§€ë„ ì´ˆê¸°í™” ===== */
const map = L.map("map", { zoomControl:false, preferCanvas:true });
const initFromHash = readHash();
map.setView(initFromHash ? [initFromHash.lat, initFromHash.lng] : INITIAL_CENTER, initFromHash ? initFromHash.z : INITIAL_ZOOM);

L.control.zoom({position:'topright'}).addTo(map);

/* ë² ì´ìŠ¤ íƒ€ì¼ (add í›„ size ì¬ê³„ì‚° 2íšŒ) */
const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM & CARTO'}).addTo(map);
const osm   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'});
const hot   = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{attribution:'Â© OSM HOT'});
L.control.layers({"Carto":carto,"OSM":osm,"HOT":hot}, null, {position:'topright'}).addTo(map);
setTimeout(()=> map.invalidateSize(), 0);
setTimeout(()=> map.invalidateSize(), 150);

/* í´ëŸ¬ìŠ¤í„° */
const cluster = L.markerClusterGroup({
  maxClusterRadius: 40,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: false,
});

/* ìƒíƒœ */
let facilities=[], items=[];
let meMarker=null, watchId=null, tracking=false;

/* íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ */
const typeStyle = {
  station:{ color:'#ff6600', fill:'#ff6600', radius:8 },
  small:  { color:'#33bbff', fill:'#33bbff', radius:10 },
  stream: { color:'#3399ff', fill:'#3399ff', radius:12 },
  default:{ color:'#666',    fill:'#666',    radius:8 }
};
const isMobile = /Mobi|Android/i.test(navigator.userAgent);
const tooltipOpt = isMobile ? {permanent:false} : {permanent:true,className:'station-tooltip',direction:'top',offset:[0,-10]};

/* ìœ í‹¸ */
const $ = sel => document.querySelector(sel);
const toast = (msg, ms=2200)=>{ const el=$("#toast"); el.textContent=msg; el.classList.add("show"); setTimeout(()=> el.classList.remove("show"), ms); };

/* í•„í„° ë¡œë“œ/ì €ì¥ */
function loadFilters(){
  try{
    const v = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
    if(typeof v.showSmall === "boolean")   $("#showSmall").checked = v.showSmall;
    if(typeof v.showStream === "boolean")  $("#showStream").checked = v.showStream;
    if(typeof v.showStation === "boolean") $("#showStation").checked = v.showStation;
  }catch(e){}
}
function saveFilters(){
  const v = {
    showSmall:   $("#showSmall").checked,
    showStream:  $("#showStream").checked,
    showStation: $("#showStation").checked
  };
  try{ localStorage.setItem(LS_KEY, JSON.stringify(v)); }catch(e){}
}

/* ë§ˆì»¤ ìƒì„± */
function makeMarker(f){
  const t = typeStyle[f.type] || typeStyle.default;
  const m = L.circleMarker([f.lat,f.lng], {
    radius:t.radius, color:'#000', weight:1, fillColor:t.fill, fillOpacity:0.9
  }).bindTooltip(f.name, tooltipOpt);
  if (f.popupHtml){
    m.bindPopup(f.popupHtml, { maxWidth: 260 });
  }else{
    m.bindPopup(`<b>${f.name}</b><br>ID: ${f.id || '-'}<br>ìœ í˜•: ${f.type}`);
  }
  return m;
}

/* ë Œë”ë§ */
function renderAll(){
  cluster.clearLayers();
  const showSmall   = $("#showSmall").checked;
  const showStream  = $("#showStream").checked;
  const showStation = $("#showStation").checked;

  const filtered = items.filter(it =>
    (it.type==='small'   && showSmall) ||
    (it.type==='stream'  && showStream)||
    (it.type==='station' && showStation)
  );

  filtered.forEach(it => cluster.addLayer(it.layer));
  map.addLayer(cluster);

  if (filtered.length){
    const g = L.featureGroup(filtered.map(it=>it.layer));
    try{ map.fitBounds(g.getBounds().pad(0.12), { animate:false }); }catch(e){}
  }
}

/* í•„í„° ì´ë²¤íŠ¸(ë””ë°”ìš´ìŠ¤) */
let filterTimer=null;
function onFilterChange(){
  saveFilters();
  clearTimeout(filterTimer);
  filterTimer = setTimeout(renderAll, 80);
}

/* ë°ì´í„° ë¡œë“œ */
async function loadFacilities(){
  const ctrl = new AbortController();
  const t = setTimeout(()=> ctrl.abort(), 12000); // 12s íƒ€ì„ì•„ì›ƒ
  try{
    const res = await fetch(DATA_URL, { cache:"no-store", signal: ctrl.signal });
    if (res.status === 401 || res.status === 403) throw new Error("ì¸ì¦ í•„ìš” (401/403)");
    if (!res.ok) throw new Error("HTTP "+res.status);
    facilities = await res.json();
    items = facilities.map(f => ({ layer: makeMarker(f), type: f.type || "default" }));
    renderAll();
    toast("ë§ˆì»¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
  } catch(e){
    console.error(e);
    if(String(e).includes("ì¸ì¦ í•„ìš”")) toast("ğŸ”’ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì ‘ì†í•´ ì£¼ì„¸ìš”.");
    else if (String(e).includes("AbortError")) toast("â±ï¸ ë„¤íŠ¸ì›Œí¬ ì§€ì—°ìœ¼ë¡œ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
    else toast("âš ï¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
  } finally{
    clearTimeout(t);
  }
}

/* ë‚´ ìœ„ì¹˜ ì¶”ì  */
function toggleTracking(){
  const btn = $("#gpsBtn");
  if (tracking){
    try{ navigator.geolocation.clearWatch(watchId); }catch(e){}
    tracking=false; btn.textContent="ğŸ“"; btn.style.background="#0078ff";
    if (meMarker){ map.removeLayer(meMarker); meMarker=null; }
    toast("ğŸ›‘ ì‹¤ì‹œê°„ ì¶”ì  ì¢…ë£Œ");
    return;
  }
  if (!navigator.geolocation){ toast("âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
  watchId = navigator.geolocation.watchPosition(
    pos=>{
      const { latitude:lat, longitude:lng } = pos.coords;
      const el = document.createElement('div'); el.className = 'me-dot';
      const divIcon = L.divIcon({ className:'', html: el, iconSize:[16,16], iconAnchor:[8,8] });
      if (meMarker) meMarker.setLatLng([lat,lng]); else meMarker = L.marker([lat,lng], { icon: divIcon }).addTo(map).bindPopup("ğŸ“ ë‚´ ìœ„ì¹˜");
      map.flyTo([lat,lng], Math.max(map.getZoom(), 14), { duration:0.5 });
    },
    err=>{
      console.warn(err);
      toast("âš ï¸ ìœ„ì¹˜ ì ‘ê·¼ ì‹¤íŒ¨(ê¶Œí•œ í™•ì¸)");
      tracking=false; btn.textContent="ğŸ“"; btn.style.background="#0078ff";
    },
    { enableHighAccuracy:true, maximumAge:5000, timeout:10000 }
  );
  tracking=true; btn.textContent="ğŸ”µ"; btn.style.background="#00b894";
  toast("ğŸ“¡ ì‹¤ì‹œê°„ ì¶”ì  ì‹œì‘");
}

/* ì£¼ì†Œ í•´ì‹œ ì—…ë°ì´íŠ¸ */
map.on("moveend zoomend", ()=> writeHash(map.getZoom(), map.getCenter()));

/* ì´ë²¤íŠ¸ ë°”ì¸ë”© */
$("#showSmall").addEventListener("change", onFilterChange);
$("#showStream").addEventListener("change", onFilterChange);
$("#showStation").addEventListener("change", onFilterChange);
$("#fitBtn").addEventListener("click", ()=> {
  const layers = cluster.getLayers();
  if (layers.length){
    const g = L.featureGroup(layers);
    try{ map.fitBounds(g.getBounds().pad(0.12)); }catch(e){}
  } else {
    map.setView(INITIAL_CENTER, INITIAL_ZOOM);
  }
});
$("#gpsBtn").addEventListener("click", toggleTracking);

/* ì´ˆê¸°í™” */
loadFilters();
loadFacilities();

/* ë ˆì´ì•„ì›ƒ ë³´ì •: load ì‹œ ë‘ ë²ˆ */
window.addEventListener('load', ()=>{
  setTimeout(()=> map.invalidateSize(), 0);
  setTimeout(()=> map.invalidateSize(), 200);
});
window.addEventListener('resize', ()=>{ map.invalidateSize(); document.body.offsetHeight; });

</script>
</body>
</html>
