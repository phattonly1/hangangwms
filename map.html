<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„ Â· ìš°í•˜ë‹¨ ë„í‚¹ ìµœì¢…íŒ</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  /* [í†µì¼ëœ í…Œë§ˆ ë³€ìˆ˜] index.html ê¸°ì¤€ */
  :root {
    --hdr: 60px; --gap: 16px; --btn: 56px; --round: 16px;
    --sa-t: env(safe-area-inset-top, 0px);
    --sa-r: env(safe-area-inset-right, 0px);
    --sa-b: env(safe-area-inset-bottom, 0px);
    --sa-l: env(safe-area-inset-left, 0px);
    --leaflet-bottom: 96px;

    /* Light Mode (ê¸°ë³¸) */
    --bg: #e6f4ff; --text: #0b2239; --card-bg: rgba(255, 255, 255, 0.9);
    --bd: rgba(0, 0, 0, 0.08); --shadow: 0 8px 24px rgba(15, 45, 80, 0.1);
    --primary: #0ea5e9; --accent-text: #0284c7;
  }
  
  /* Dark Mode */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0b1622; --text: #e6eef6; --card-bg: rgba(22, 32, 50, 0.9);
      --bd: rgba(255, 255, 255, 0.1); --shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      --primary: #38bdf8; --accent-text: #7dd3fc;
    }
  }

  html,body{height:100%;margin:0;font-family:-apple-system, BlinkMacSystemFont, "Pretendard", system-ui, sans-serif;}
  body{background:var(--bg);color:var(--text); touch-action: manipulation;}
  
  /* í—¤ë” í†µì¼ */
  .appbar {
    position: sticky; top: 0; z-index: 1000; height: var(--hdr);
    padding: var(--sa-t) var(--gap) 0 var(--gap);
    display: flex; align-items: center; gap: 10px;
    background: var(--card-bg); backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--bd); box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .title { font-weight: 800; font-size: 18px; letter-spacing: -0.02em; color: var(--text); }

  /* ì§€ë„ ì»¨í…Œì´ë„ˆ */
  .wrap { position: relative; height: calc(100svh - var(--hdr) - var(--sa-t)); }
  #map { width: 100%; height: 100%; background: #ddd; }

  /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ (ìš°í•˜ë‹¨) */
  .br-dock {
    position: fixed; z-index: 1200;
    right: calc(var(--gap) + var(--sa-r));
    bottom: calc(var(--leaflet-bottom) + 12px + var(--sa-b));
    display: flex; flex-direction: column; gap: 10px;
  }
  .btn {
    width: var(--btn); height: var(--btn);
    display: grid; place-items: center;
    border: 1px solid var(--bd); border-radius: 999px; cursor: pointer;
    background: var(--card-bg); color: var(--text);
    box-shadow: var(--shadow); backdrop-filter: blur(4px);
  }
  .btn:hover { filter: brightness(0.95); }
  @media (prefers-color-scheme: dark) { .btn:hover { filter: brightness(1.2); } }
  .btn--gps { background: var(--primary); color: #fff; border: none; }

  /* íŒ¨ë„ ìŠ¤íƒ€ì¼ í†µì¼ */
  .panel {
    position: fixed; z-index: 1250;
    right: calc(var(--gap) + var(--sa-r));
    bottom: calc(var(--leaflet-bottom) + 12px + var(--sa-b) + var(--btn) + 12px);
    background: var(--card-bg); color: var(--text);
    border: 1px solid var(--bd); border-radius: var(--round);
    padding: 16px; max-width: min(92vw, 420px);
    display: grid; grid-template-columns: 1fr; row-gap: 12px;
    box-shadow: var(--shadow); backdrop-filter: blur(12px);
  }
  .panel.collapsed { display: none; }
  
  .panel select {
    border: 1px solid var(--bd); background: rgba(0,0,0,0.05); color: var(--text);
    border-radius: 8px; padding: 10px; font-size: 16px; width: 100%; appearance: none;
  }
  @media (prefers-color-scheme: dark) { .panel select { background: rgba(255,255,255,0.05); } }

  /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ í•­ëª©ë“¤ */
  .leaflet-control-container .leaflet-bottom.leaflet-right { margin-right: calc(var(--gap) + var(--sa-r)); margin-bottom: calc(var(--gap) + var(--sa-b)); z-index: 1000; }
  .toast { position: fixed; z-index: 1225; left: 50%; transform: translateX(-50%); bottom: 100px; background: rgba(0,0,0,0.8); color: #fff; border-radius: 20px; padding: 10px 20px; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity .2s; }
  .toast.show { opacity: 1; }
  .panel .group.filters { display: grid; grid-template-columns: 1fr; gap: 8px; }
  .panel label { display: flex; align-items: center; gap: 8px; font-size: 15px; font-weight: 500; }
  .panel input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
</style>
</head>
<body>
  <header class="appbar"><div class="title">ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„</div></header>

  <main class="wrap">
    <div id="map" role="region" aria-label="ì§€ë„"></div>

    <!-- ìš°í•˜ë‹¨ ë„í‚¹ ì•„ì´ì½˜ -->
    <div class="br-dock" aria-label="ìš°í•˜ë‹¨ ë„í‚¹ ì»¨íŠ¸ë¡¤">
      <!-- í•„í„°(íŒ¨ë„ í† ê¸€) : ê¹”ë•Œê¸° ì•„ì´ì½˜ -->
      <button class="btn" id="panelToggle" aria-label="í•„í„° ì—´ê¸°/ë‹«ê¸°" aria-expanded="false" title="í•„í„°">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" stroke-width="2" stroke-linejoin="round"></path>
        </svg>
      </button>
      <!-- GPS -->
      <button class="btn btn--gps" id="gpsBtn" aria-label="ë‚´ ìœ„ì¹˜" title="ë‚´ ìœ„ì¹˜">ğŸ“</button>
    </div>

    <!-- íŒ¨ë„(ìš°í•˜ë‹¨ì—ì„œ ìœ„ë¡œ) -->
    <div class="panel collapsed" id="panel">
      <div class="group filters">
        <label><input type="checkbox" id="showSmall" checked>ì†Œê·œëª¨</label>
        <label><input type="checkbox" id="showStream" checked>í•˜ì²œ</label>
        <label><input type="checkbox" id="showStation" checked>ì¸¡ì •ì†Œ</label>
      </div>
      <select id="jumpList" aria-label="ë§ˆì»¤ë¡œ ì´ë™">
        <option value="">ì´ë™â€¦</option>
      </select>
    </div>

    <div class="toast" id="toast">ì•Œë¦¼</div>
  </main>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
  /* ì—ëŸ¬ ë°•ìŠ¤ */
  addEventListener('error', e=>{
    const b=document.createElement('div'); b.className='err';
    b.textContent='JS Error: ' + (e.message||e.error||'unknown');
    document.body.appendChild(b);
  });

  /* ì§€ë„ & ì»¨íŠ¸ë¡¤(ë‘˜ ë‹¤ ìš°í•˜ë‹¨) */
  const map = L.map('map', { zoomControl:false, preferCanvas:true });
  L.control.zoom({position:'bottomright'}).addTo(map);
  const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM & CARTO'}).addTo(map);
  const osm   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'});
  const hot   = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{attribution:'Â© OSM HOT'});
  L.control.layers({"Carto":carto,"OSM":osm,"HOT":hot}, null, {position:'bottomright'}).addTo(map);
  map.setView([37.5665,126.9780], 11);

  /* Leaflet ì»¨íŠ¸ë¡¤ ì‹¤ì œ ë†’ì´ì— ë§ì¶° ë„í‚¹ ì˜¤í”„ì…‹ ìë™ ë³´ì • */
  function updateLeafletBottomOffset(){
    const ctr = document.querySelector('.leaflet-control-container .leaflet-bottom.leaflet-right');
    const h = ctr ? Math.ceil(ctr.getBoundingClientRect().height) : 96;
    document.documentElement.style.setProperty('--leaflet-bottom', h + 'px');
  }
  addEventListener('load', updateLeafletBottomOffset);
  addEventListener('resize', updateLeafletBottomOffset);
  addEventListener('orientationchange', updateLeafletBottomOffset);
  setTimeout(updateLeafletBottomOffset, 200);
  setTimeout(updateLeafletBottomOffset, 600);

  /* í† ìŠ¤íŠ¸ */
  const toast = (m,ms=1500)=>{ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); };

  /* ë°ì´í„° ì†ŒìŠ¤ */
  const GIST = { user:'phattonly1', id:'9309e6ef4dd423e20628a28512edf12b', commit:'7452906127b85ad19f156d19de04141b49885411', file:'facilities.json' };
  const DATA_URLS = [
    `https://gist.githubusercontent.com/${GIST.user}/${GIST.id}/raw/${GIST.commit}/${GIST.file}`,
    `https://gistcdn.githack.com/${GIST.user}/${GIST.id}/raw/${GIST.commit}/${GIST.file}`,
    `https://cdn.statically.io/gist/${GIST.user}/${GIST.id}/${GIST.commit}/${GIST.file}`,
  ];

  /* ìƒíƒœ */
  const panelEl = document.getElementById('panel');
  const panelToggleBtn = document.getElementById('panelToggle');
  const jumpEl = document.getElementById('jumpList');
  const jumpIndex = new Map();
  const typeOn = { small:true, stream:true, station:true };
  const typeStyle = {
    station:{ fill:'#0033cc', radius:8 },
    small:  { fill:'#33bbff', radius:10 },
    stream: { fill:'#3399ff', radius:12 },
    default:{ fill:'#666',    radius:8 }
  };
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);
  const tipOpt = isMobile ? {permanent:false} : {permanent:true,className:'station-tooltip',direction:'top',offset:[0,-10]};
  let items = [];
  const cluster = L.markerClusterGroup({ maxClusterRadius:40, showCoverageOnHover:false });

  /* íŒ¨ë„ í† ê¸€ (ë²„ê·¸ ìˆ˜ì •: ì§„ì§œ í† ê¸€ë˜ë„ë¡) */
  function setPanelCollapsed(collapsed){
    panelEl.classList.toggle('collapsed', collapsed);
    panelToggleBtn.setAttribute('aria-expanded', String(!collapsed));
    map.invalidateSize();
  }
  // ì‹œì‘ì€ ì ‘í˜
  addEventListener('load', ()=> setPanelCollapsed(true));
  panelToggleBtn.addEventListener('click', ()=>{
    const current = panelEl.classList.contains('collapsed');
    setPanelCollapsed(!current); // í˜„ì¬ ì ‘í˜ì´ë©´ í¼ì¹˜ê³ , í¼ì³ì ¸ ìˆìœ¼ë©´ ì ‘ê¸°
  });

  /* ë§ˆì»¤ */
  function mkMarker(f){
    const st = typeStyle[f.type] || typeStyle.default;
    const m = L.circleMarker([+f.lat, +f.lng], {
      radius: st.radius, color:'#000', weight:1,
      fillColor: f.color || st.fill, fillOpacity:.9
    }).bindTooltip(f.name, tipOpt);
    m.bindPopup(`<b>${f.name}</b><br>${f.id?`ID: ${f.id}<br>`:''}ìœ í˜•: ${f.type||'unknown'}`);
    return m;
  }

  function renderAll(){
    cluster.clearLayers();
    const filtered = items.filter(it => (typeOn[it.type] ?? true));
    filtered.forEach(it => cluster.addLayer(it.layer));
    if (!map.hasLayer(cluster)) map.addLayer(cluster);

    // ë¦¬ìŠ¤íŠ¸(ê°€ë‚˜ë‹¤)
    jumpIndex.clear();
    jumpEl.innerHTML = '<option value="">ì´ë™â€¦</option>';
    [...filtered].sort((a,b)=> a.f.name.localeCompare(b.f.name,'ko')).forEach((it,i)=>{
      const o=document.createElement('option');
      o.value = `${it.f.name}__${i}`;
      o.textContent = it.f.name;
      o.dataset.lat = it.f.lat; o.dataset.lng = it.f.lng;
      jumpIndex.set(o.value, it.layer);
      jumpEl.appendChild(o);
    });

    if (filtered.length){
      const fg = L.featureGroup(filtered.map(x=>x.layer));
      try{ map.fitBounds(fg.getBounds().pad(0.15), { animate:false }); }catch(e){}
    }
  }

  ['showSmall','showStream','showStation'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('change', ()=>{
      typeOn.small   = document.getElementById('showSmall').checked;
      typeOn.stream  = document.getElementById('showStream').checked;
      typeOn.station = document.getElementById('showStation').checked;
      renderAll();
    });
  });

  jumpEl.addEventListener('change', e=>{
    const v = e.target.value; if(!v) return;
    const opt = e.target.selectedOptions[0];
    const lat = +opt.dataset.lat, lng = +opt.dataset.lng;
    map.flyTo([lat,lng], Math.max(map.getZoom(), 16), {duration:.45});
    const lyr = jumpIndex.get(v); if(lyr && lyr.openPopup) setTimeout(()=>lyr.openPopup(), 480);
  });

  async function loadFacilities(){
    let lastErr=null;
    for (const url of DATA_URLS){
      try{
        const r = await fetch(url, {cache:'no-store',credentials:'omit'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const text = await r.text();
        let json;
        try{ json = JSON.parse(text); }
        catch{ const s=text.indexOf('['), e=text.lastIndexOf(']'); json = JSON.parse(text.slice(s,e+1)); }
        if(!Array.isArray(json)) throw new Error('bad json');

        items = json.map(f=>({ f, type: f.type||'default', layer: mkMarker(f) }));
        renderAll();
        toast('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
        return;
      }catch(err){ lastErr = err; }
    }
    console.warn(lastErr);
    toast('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
  }

  /* GPS */
  let me=null, watchId=null, tracking=false;
  document.getElementById('gpsBtn').addEventListener('click', ()=>{
    const btn = document.getElementById('gpsBtn');
    if (tracking){
      navigator.geolocation?.clearWatch?.(watchId);
      tracking=false; btn.textContent='ğŸ“';
      if (me){ map.removeLayer(me); me=null; }
      toast('ğŸ›‘ ì¶”ì  ì¢…ë£Œ');
      return;
    }
    if (!navigator.geolocation){ toast('âš ï¸ ìœ„ì¹˜ ë¯¸ì§€ì›'); return; }
    watchId = navigator.geolocation.watchPosition(
      pos=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        const el = document.createElement('div');
        el.style.cssText = 'width:16px;height:16px;border:3px solid #0ea5e9;background:#38bdf8;border-radius:999px;box-shadow:0 0 0 4px rgba(56,189,248,.25)';
        const icon = L.divIcon({className:'',html:el,iconSize:[16,16],iconAnchor:[8,8]});
        if(me) me.setLatLng([lat,lng]); else me = L.marker([lat,lng],{icon}).addTo(map).bindPopup('ğŸ“ ë‚´ ìœ„ì¹˜');
        map.flyTo([lat,lng], Math.max(map.getZoom(), 14), {duration:.4});
      },
      _=>{ toast('âš ï¸ ìœ„ì¹˜ ê¶Œí•œ í™•ì¸'); tracking=false; btn.textContent='ğŸ“'; },
      { enableHighAccuracy:true, maximumAge:5000, timeout:10000 }
    );
    tracking=true; btn.textContent='ğŸ”µ';
    toast('ğŸ“¡ ì¶”ì  ì‹œì‘');
  });

  /* ì´ˆê¸°í™” */
  loadFacilities();
  addEventListener('load', ()=>{
    setTimeout(()=> map.invalidateSize(), 0);
    setTimeout(()=> map.invalidateSize(), 250);
  });
  addEventListener('resize', ()=> map.invalidateSize());
  </script>
</body>
</html>
