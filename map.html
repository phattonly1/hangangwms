<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„</title>
<link rel="icon" href="./assets/gongdan-mark.png" />

<!-- Leaflet & MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
  :root{ --HDR-H: 64px; }
  *{ box-sizing:border-box }
  html, body { height:100%; margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Pretendard,Arial; }
  body { background:#f5f7fb; color:#0b2239; }

  /* ìƒë‹¨ í—¤ë”: ë¡œê³  + ì œëª© í•œ ì¤„ */
  .appbar{
    height:var(--HDR-H); display:flex; align-items:center; gap:14px;
    padding:0 16px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06);
    position:sticky; top:0; z-index:1000;
  }
  .logo-img{ width:44px; height:44px; object-fit:contain; filter:drop-shadow(0 2px 4px rgba(0,0,0,.12)); }
  .title-text{ min-width:0; }
  .title-text h1{
    margin:0; font-weight:800; letter-spacing:-0.02em; line-height:1.1;
    font-size: clamp(18px, 4.2vw, 26px);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* ë³¸ë¬¸ ë ˆì´ì•„ì›ƒ (ëª¨ë°”ì¼ ì•ˆì „ ë†’ì´ svh ì‚¬ìš©) */
  .map-wrap{
    position:relative;
    height:calc(100svh - var(--HDR-H)); /* â† í•µì‹¬: svh */
    min-height:400px;
  }
  #map{ width:100%; height:100%; }

  /* UI íŒ¨ë„/ë²„íŠ¼ */
  .filter-panel{
    position:absolute; left:10px; top:10px; z-index:1000;
    background:rgba(255,255,255,0.95); padding:6px 8px; border-radius:8px;
    box-shadow:0 2px 4px rgba(0,0,0,0.25);
    display:inline-flex; flex-direction:column; gap:3px; font-size:14px;
  }
  label{ display:flex; align-items:center; gap:4px; white-space:nowrap; }

  .floating-btn{
    position:absolute; bottom:20px; right:20px; z-index:1200;
    width:52px; height:52px; border-radius:50%; background:#0078ff; color:#fff;
    font-size:26px; font-weight:bold; border:none;
    box-shadow:0 3px 8px rgba(0,0,0,0.3);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; transition:.2s ease;
  }
  .floating-btn:hover{ background:#005fcc; transform:scale(1.05); }

  .toast{
    position:fixed; bottom:90px; right:20px; z-index:2000;
    background:rgba(0,0,0,0.8); color:#fff; padding:10px 14px; border-radius:6px; font-size:14px;
    opacity:0; pointer-events:none; transition:opacity .3s ease;
  }
  .toast.show{ opacity:1; }

  .leaflet-tooltip.station-tooltip{
    font-weight:bold; font-size:14px; color:#222; text-shadow:1px 1px 2px #fff;
  }

  @media (max-width:420px){
    .logo-img{ width:40px; height:40px; }
    .title-text h1{ font-size: clamp(16px, 5vw, 22px); }
  }
</style>
</head>
<body>
  <!-- í—¤ë” -->
  <header class="appbar">
    <img class="logo-img" src="./assets/gongdan-mark.png" alt="ê³µë‹¨ ë§ˆí¬" />
    <div class="title-text"><h1>ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„</h1></div>
  </header>

  <!-- ì§€ë„ -->
  <main class="map-wrap">
    <div class="filter-panel">
      <label><input type="checkbox" id="showSmall" checked onchange="filterMarkers()"> ì†Œê·œëª¨</label>
      <label><input type="checkbox" id="showStream" checked onchange="filterMarkers()"> í•˜ì²œ</label>
      <label><input type="checkbox" id="showStation" checked onchange="filterMarkers()"> ì¸¡ì •ì†Œ</label>
    </div>

    <div id="map"></div>

    <button class="floating-btn gps-btn" onclick="toggleTracking()">ğŸ“</button>
    <div class="toast" id="toast">ğŸ“¡ ìœ„ì¹˜ ê¸°ëŠ¥</div>
  </main>

<script>
/* ì´ˆê¸° ì¤‘ì‹¬: ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬ ì¥ë¯¸ë¡œ 42 */
const INITIAL_CENTER = [37.4106329, 127.1255116];
const INITIAL_ZOOM   = 16;

const GIST_URL = "https://gist.githubusercontent.com/phattonly1/9309e6ef4dd423e20628a28512edf12b/raw/facilities.json";

const map = L.map("map", { zoomControl:false, preferCanvas:true }).setView(INITIAL_CENTER, INITIAL_ZOOM);
L.control.zoom({position:'topright'}).addTo(map);

const markerClusterGroup = L.markerClusterGroup();
let facilities=[], markers=[];
let myLocationMarker=null, watchId=null, tracking=false;

// íƒ€ì¼
const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM & CARTO'}).addTo(map);
const osm   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'});
const hot   = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{attribution:'&copy; OSM HOT'});
L.control.layers({"Carto":carto,"OSM":osm,"HOT":hot}, null, {position:'topright'}).addTo(map);

const typeConfig = {
  station:{color:'#ff6600',radius:8},
  small:{color:'#33bbff',radius:10},
  stream:{color:'#3399ff',radius:12},
  default:{color:'#666',radius:8}
};
const isMobile = /Mobi|Android/i.test(navigator.userAgent);
const tooltipOption = isMobile ? {permanent:false} : {permanent:true,className:'station-tooltip',direction:'top',offset:[0,-10]};

// ë‚´ ìœ„ì¹˜ ì•„ì´ì½˜
const myIcon = L.icon({
  iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowSize:[41,41]
});

function createMarker(f){
  const c = typeConfig[f.type] || typeConfig.default;
  return L.circleMarker([f.lat,f.lng], {
    radius:c.radius, color:'#000', weight:1, fillColor:c.color, fillOpacity:0.85
  }).bindTooltip(f.name, tooltipOption);
}

function refreshMarkers(){
  markerClusterGroup.clearLayers();
  markers = facilities.map(f => ({ layer:createMarker(f), type:f.type }));
  filterMarkers();
  map.addLayer(markerClusterGroup);
}

function filterMarkers(){
  const showSmall   = document.getElementById("showSmall").checked;
  const showStream  = document.getElementById("showStream").checked;
  const showStation = document.getElementById("showStation").checked;
  markerClusterGroup.clearLayers();
  markers.forEach(m=>{
    if ((m.type==='small'&&showSmall) || (m.type==='stream'&&showStream) || (m.type==='station'&&showStation)) {
      markerClusterGroup.addLayer(m.layer);
    }
  });
}

async function loadFacilities(){
  try{
    const res = await fetch(GIST_URL, { cache:"no-store" });
    if (!res.ok) throw new Error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
    facilities = await res.json();
    refreshMarkers();
    setTimeout(()=>map.invalidateSize(), 0);
  } catch(e){
    console.error(e);
    showToast("âš ï¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
  }
}
loadFacilities();

// GPS ì¶”ì 
function toggleTracking(){
  const gpsBtn = document.querySelector(".gps-btn");
  if (tracking){
    navigator.geolocation.clearWatch(watchId);
    tracking=false;
    gpsBtn.textContent="âšª";
    gpsBtn.style.background="#777";
    showToast("ğŸ›‘ ì‹¤ì‹œê°„ ì¶”ì  ì¢…ë£Œ");
  } else {
    if (!navigator.geolocation){ showToast("âš ï¸ GPS ë¯¸ì§€ì›"); return; }
    watchId = navigator.geolocation.watchPosition(
      pos=>{
        const { latitude:lat, longitude:lng } = pos.coords;
        if (myLocationMarker) map.removeLayer(myLocationMarker);
        myLocationMarker = L.marker([lat,lng], { icon: myIcon })
          .bindPopup("ğŸ“ ë‚´ ìœ„ì¹˜").addTo(map);
        map.flyTo([lat,lng],14);
      },
      err=>{
        showToast("âš ï¸ ìœ„ì¹˜ ì ‘ê·¼ ì‹¤íŒ¨");
        gpsBtn.textContent="âšª"; gpsBtn.style.background="#777";
      },
      { enableHighAccuracy:true, maximumAge:5000, timeout:10000 }
    );
    tracking=true;
    gpsBtn.textContent="ğŸ”µ";
    gpsBtn.style.background="#00b894";
    showToast("ğŸ“¡ ì‹¤ì‹œê°„ ì¶”ì  ì‹œì‘");
  }
}

function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1500);
}

/* ì´ˆê¸°/ë¦¬ì‚¬ì´ì¦ˆ ë³´ì •: ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ì´ìŠˆ ë°©ì§€ */
window.addEventListener('load', ()=> setTimeout(()=>map.invalidateSize(), 0));
window.addEventListener('resize', ()=>{
  map.invalidateSize();
  document.body.offsetHeight; // no-op reflow for iOS
});
</script>
</body>
</html>
