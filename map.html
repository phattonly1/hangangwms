<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„ Â· ìµœì¢… í†µí•©íŒ</title>
<link rel="icon" href="./assets/gongdan-mark.png" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
  :root{
    --hdr:56px; --gap:12px; --ui-sz:56px;
    --sa-t: env(safe-area-inset-top, 0px);
    --sa-r: env(safe-area-inset-right, 0px);
    --sa-b: env(safe-area-inset-bottom, 0px);
    --sa-l: env(safe-area-inset-left, 0px);
  }
  /* í¬ì»¤ìŠ¤ ì‹œ í™•ëŒ€ ë°©ì§€ (Chromium) */
  html{ -webkit-text-size-adjust:100%; }
  input, select, button{ font-size:16px; }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,Apple SD Gothic Neo,Pretendard,Segoe UI,Roboto,Arial}
  body{background:#0b1622;color:#e6eef6; touch-action: manipulation;}

  /* í—¤ë” */
  .appbar{
    position:sticky;top:0;z-index:10;height:var(--hdr);
    padding:0 calc(var(--gap)+var(--sa-r)) 0 calc(var(--gap)+var(--sa-l));
    display:flex;align-items:center;gap:10px;background:#101b2a;border-bottom:1px solid rgba(255,255,255,.08)
  }
  .title{font-weight:800;letter-spacing:-.02em}

  /* ì§€ë„ ì»¨í…Œì´ë„ˆ: ëª¨ë°”ì¼ ê¸°ë³¸ svh, ë°ìŠ¤í¬íƒ‘ì€ ì•„ë˜ ì˜¤ë²„ë¼ì´ë“œì—ì„œ vh */
  .wrap{
    position:relative;
    height: calc(100svh - var(--hdr));
    min-height: 420px;
  }
  #map{width:100%;height:100%}

  /* ===== ëª¨ë°”ì¼ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ (S25 ì›¨ì¼ ìµœì í™”) ===== */
  /* ì¢Œìƒë‹¨ íŒ¨ë„ */
  .panel{
    position:fixed; z-index:1100;
    left: calc(var(--gap) + var(--sa-l));
    top:  calc(var(--gap) + var(--sa-t));
    background:rgba(16,27,42,.96); color:#e6eef6;
    border:1px solid rgba(255,255,255,.1);
    border-radius:14px; padding:8px 10px;
    display:flex; align-items:center; gap:10px;
    max-width: min(92vw, 360px);
  }
  .panel .icon{
    width:36px; height:36px; border:none; border-radius:10px;
    background:transparent; color:#e6eef6; display:grid; place-items:center; cursor:pointer
  }
  .panel .group{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  .panel label{ display:flex; align-items:center; gap:8px; font-size:16px; line-height:1 }
  .panel input[type="checkbox"]{ width:18px; height:18px; accent-color:#4da3ff; }
  .panel select{
    border:1px solid #334155; background:#0f1725; color:#e6eef6;
    border-radius:10px; padding:8px 10px; font-size:16px; max-width:min(60vw,260px)
  }

  /* Leaflet ì»¨íŠ¸ë¡¤: ëª¨ë°”ì¼ì€ ë§ˆì§„ìœ¼ë¡œ safe-area í™•ë³´ */
  .leaflet-control-container .leaflet-top.leaflet-right{
    margin-top: calc(var(--gap) + var(--sa-t));
    margin-right: calc(var(--gap) + var(--sa-r));
  }
  .leaflet-control-container .leaflet-bottom.leaflet-right{
    margin-right: calc(var(--gap) + var(--sa-r));
    margin-bottom: calc(var(--ui-sz) + 28px + var(--sa-b));
  }
  .leaflet-control{box-shadow:0 2px 8px rgba(0,0,0,.4)!important;border-radius:12px!important}
  .leaflet-control a{border-radius:12px!important}

  /* GPS ë²„íŠ¼ (ìš°í•˜ë‹¨) */
  .gps{
    position:fixed; z-index:1200;
    right: calc(var(--gap) + var(--sa-r));
    bottom: calc(20px + var(--sa-b));
    width: var(--ui-sz); height: var(--ui-sz);
    border:none; border-radius:999px; background:#00b894; color:#fff; font-size:24px;
    display:grid; place-items:center; box-shadow:0 6px 14px rgba(0,0,0,.35); cursor:pointer
  }

  /* í† ìŠ¤íŠ¸ (GPS ìœ„) */
  .toast{
    position:fixed; z-index:1200;
    right: calc(var(--gap) + var(--sa-r));
    bottom: calc(var(--ui-sz) + 34px + var(--sa-b));
    background:rgba(0,0,0,.88); color:#fff; border-radius:10px; padding:10px 12px; font-size:14px;
    opacity:0; pointer-events:none; transition:opacity .2s
  }
  .toast.show{opacity:1}

  /* ì—ëŸ¬ ë””ë²„ê·¸ ë°•ìŠ¤ */
  .err{
    position:fixed; left:8px; right:8px; top: calc(8px + var(--sa-t));
    z-index:2000;background:#2b1d1d;color:#ffd7d7;border:1px solid #ff6b6b;border-radius:10px;padding:8px 10px;font-size:12px
  }

  /* ===== ë°ìŠ¤í¬íƒ‘ ì˜¤ë²„ë¼ì´ë“œ (ë§ˆìš°ìŠ¤/íŠ¸ë™íŒ¨ë“œ ë˜ëŠ” 1024px+) ===== */
  @media (min-width:1024px){
    body.is-desktop .wrap{ height: calc(100vh - var(--hdr)); } /* ë°ìŠ¤í¬íƒ‘ì€ vhê°€ ì•ˆì •ì  */

    /* íŒ¨ë„: ì§€ë„ ë‚´ë¶€ ì¢Œìƒë‹¨ */
    body.is-desktop .panel{
      position:absolute; /* mobile: fixed -> desktop: absolute */
      left:16px; top:16px; right:auto; bottom:auto;
      max-width:400px;
    }

    /* ì¤Œ: ìš°ìƒë‹¨ ì—¬ë°± ê°„ë‹¨í™” */
    body.is-desktop .leaflet-control-container .leaflet-top.leaflet-right{
      margin-top:16px; margin-right:16px;
    }

    /* ë ˆì´ì–´: ìš°í•˜ë‹¨ */
    body.is-desktop .leaflet-control-container .leaflet-bottom.leaflet-right{
      margin-right:16px; margin-bottom:16px;
    }

    /* GPS: ì¢Œí•˜ë‹¨ (ì§€ë„ ê¸°ì¤€) */
    body.is-desktop .gps{
      position:absolute; left:16px; right:auto; bottom:16px;
    }

    /* í† ìŠ¤íŠ¸: ì¢Œí•˜ë‹¨ GPS ìœ„ */
    body.is-desktop .toast{
      position:absolute; left:16px; right:auto;
      bottom: calc(16px + var(--ui-sz) + 10px);
    }
  }
</style>
</head>
<body>
<header class="appbar"><div class="title">ìˆ˜ì§ˆì¸¡ì •ë§ ì§€ë„</div></header>

<main class="wrap">
  <!-- ì¢Œìƒë‹¨: íŒ¨ë„ -->
  <div class="panel" id="panel">
    <button class="icon" aria-label="í•„í„° ì•„ì´ì½˜">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path stroke-width="2" stroke-linecap="round" d="M4 6h10M18 6h2M10 6v12M4 12h6M18 12h2M6 12v6M4 18h14M20 18h0M14 18v-8"/></svg>
    </button>
    <div class="group">
      <label><input type="checkbox" id="showSmall" checked>ì†Œê·œëª¨</label>
      <label><input type="checkbox" id="showStream" checked>í•˜ì²œ</label>
      <label><input type="checkbox" id="showStation" checked>ì¸¡ì •ì†Œ</label>
    </div>
    <select id="jumpList" aria-label="ë§ˆì»¤ë¡œ ì´ë™">
      <option value="">ë¦¬ìŠ¤íŠ¸ ì´ë™â€¦</option>
    </select>
  </div>

  <div id="map" role="region" aria-label="ì§€ë„"></div>

  <button class="gps" id="gpsBtn" aria-label="ë‚´ ìœ„ì¹˜">ğŸ“</button>
  <div class="toast" id="toast">ì•Œë¦¼</div>
</main>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
/* ì „ì—­ ì—ëŸ¬ í‘œì‹œ */
addEventListener('error', e=>{
  const b=document.createElement('div'); b.className='err';
  b.textContent='JS Error: ' + (e.message||e.error||'unknown');
  document.body.appendChild(b);
});

/* ì§€ë„ & íƒ€ì¼ */
const map = L.map('map', { zoomControl:false, preferCanvas:true });
L.control.zoom({position:'topright'}).addTo(map);
const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'&copy; OSM & CARTO'}).addTo(map);
const osm   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OSM'});
const hot   = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{attribution:'Â© OSM HOT'});
L.control.layers({"Carto":carto,"OSM":osm,"HOT":hot}, null, {position:'bottomright'}).addTo(map);
map.setView([37.5665,126.9780], 11);

/* ë°ìŠ¤í¬íƒ‘ ëª¨ë“œ ì ìš© */
function applyDesktopMode(){
  const pointerFine = matchMedia('(pointer:fine)').matches;
  const wide = window.innerWidth >= 1024;
  document.body.classList.toggle('is-desktop', pointerFine || wide);
  map.invalidateSize();
}
addEventListener('resize', applyDesktopMode);
addEventListener('load', applyDesktopMode);
setTimeout(applyDesktopMode, 200); // ì´ˆê¸° í˜ì¸íŠ¸ í›„ ë³´ì •

/* í† ìŠ¤íŠ¸ */
const toast = (m,ms=1500)=>{ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); };

/* ë°ì´í„° ì†ŒìŠ¤ */
const GIST = { user:'phattonly1', id:'9309e6ef4dd423e20628a28512edf12b', commit:'7452906127b85ad19f156d19de04141b49885411', file:'facilities.json' };
const DATA_URLS = [
  `https://gist.githubusercontent.com/${GIST.user}/${GIST.id}/raw/${GIST.commit}/${GIST.file}`,
  `https://gistcdn.githack.com/${GIST.user}/${GIST.id}/raw/${GIST.commit}/${GIST.file}`,
  `https://cdn.statically.io/gist/${GIST.user}/${GIST.id}/${GIST.commit}/${GIST.file}`,
];

/* ìƒíƒœ */
const jumpEl = document.getElementById('jumpList');
const jumpIndex = new Map();
const typeOn = { small:true, stream:true, station:true };
const typeStyle = {
  station:{ fill:'#0033cc', radius:8 },
  small:  { fill:'#33bbff', radius:10 },
  stream: { fill:'#3399ff', radius:12 },
  default:{ fill:'#666',    radius:8 }
};
const isMobile = /Mobi|Android/i.test(navigator.userAgent);
const tipOpt = isMobile ? {permanent:false} : {permanent:true,className:'station-tooltip',direction:'top',offset:[0,-10]};

let items = [];
const cluster = L.markerClusterGroup({ maxClusterRadius:40, showCoverageOnHover:false });

function mkMarker(f){
  const st = typeStyle[f.type] || typeStyle.default;
  const m = L.circleMarker([+f.lat, +f.lng], {
    radius: st.radius, color:'#000', weight:1,
    fillColor: f.color || st.fill, fillOpacity:.9
  }).bindTooltip(f.name, tipOpt);
  m.bindPopup(`<b>${f.name}</b><br>${f.id?`ID: ${f.id}<br>`:''}ìœ í˜•: ${f.type||'unknown'}`);
  return m;
}

function renderAll(){
  cluster.clearLayers();
  const filtered = items.filter(it => (typeOn[it.type] ?? true));
  filtered.forEach(it => cluster.addLayer(it.layer));
  if (!map.hasLayer(cluster)) map.addLayer(cluster);

  // ë¦¬ìŠ¤íŠ¸(ê°€ë‚˜ë‹¤)
  jumpIndex.clear();
  jumpEl.innerHTML = '<option value="">ë¦¬ìŠ¤íŠ¸ ì´ë™â€¦</option>';
  [...filtered].sort((a,b)=> a.f.name.localeCompare(b.f.name,'ko')).forEach((it,i)=>{
    const o=document.createElement('option');
    o.value = `${it.f.name}__${i}`;
    o.textContent = it.f.name;
    o.dataset.lat = it.f.lat; o.dataset.lng = it.f.lng;
    jumpIndex.set(o.value, it.layer);
    jumpEl.appendChild(o);
  });

  if (filtered.length){
    const fg = L.featureGroup(filtered.map(x=>x.layer));
    try{ map.fitBounds(fg.getBounds().pad(0.15), { animate:false }); }catch(e){}
  }
}

['showSmall','showStream','showStation'].forEach(id=>{
  document.getElementById(id).addEventListener('change', ()=>{
    typeOn.small   = document.getElementById('showSmall').checked;
    typeOn.stream  = document.getElementById('showStream').checked;
    typeOn.station = document.getElementById('showStation').checked;
    renderAll();
  });
});

jumpEl.addEventListener('change', e=>{
  const v = e.target.value; if(!v) return;
  const opt = e.target.selectedOptions[0];
  const lat = +opt.dataset.lat, lng = +opt.dataset.lng;
  map.flyTo([lat,lng], Math.max(map.getZoom(), 16), {duration:.45});
  const lyr = jumpIndex.get(v); if(lyr && lyr.openPopup) setTimeout(()=>lyr.openPopup(), 480);
});

async function loadFacilities(){
  let lastErr=null;
  for (const url of DATA_URLS){
    try{
      const r = await fetch(url, {cache:'no-store',credentials:'omit'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const text = await r.text();
      let json;
      try{ json = JSON.parse(text); }
      catch{ const s=text.indexOf('['), e=text.lastIndexOf(']'); json = JSON.parse(text.slice(s,e+1)); }
      if(!Array.isArray(json)) throw new Error('bad json');

      items = json.map(f=>({ f, type: f.type||'default', layer: mkMarker(f) }));
      renderAll();
      toast('âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
      return;
    }catch(err){ lastErr = err; }
  }
  console.warn(lastErr);
  toast('âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
}

/* GPS */
let me=null, watchId=null, tracking=false;
document.getElementById('gpsBtn').addEventListener('click', ()=>{
  const btn = document.getElementById('gpsBtn');
  if (tracking){
    navigator.geolocation?.clearWatch?.(watchId);
    tracking=false; btn.textContent='ğŸ“';
    if (me){ map.removeLayer(me); me=null; }
    toast('ğŸ›‘ ì¶”ì  ì¢…ë£Œ');
    return;
  }
  if (!navigator.geolocation){ toast('âš ï¸ ìœ„ì¹˜ ë¯¸ì§€ì›'); return; }
  watchId = navigator.geolocation.watchPosition(
    pos=>{
      const {latitude:lat, longitude:lng} = pos.coords;
      const el = document.createElement('div');
      el.style.cssText = 'width:16px;height:16px;border:3px solid #0ea5e9;background:#38bdf8;border-radius:999px;box-shadow:0 0 0 4px rgba(56,189,248,.25)';
      const icon = L.divIcon({className:'',html:el,iconSize:[16,16],iconAnchor:[8,8]});
      if(me) me.setLatLng([lat,lng]); else me = L.marker([lat,lng],{icon}).addTo(map).bindPopup('ğŸ“ ë‚´ ìœ„ì¹˜');
      map.flyTo([lat,lng], Math.max(map.getZoom(), 14), {duration:.4});
    },
    _=>{ toast('âš ï¸ ìœ„ì¹˜ ê¶Œí•œ í™•ì¸'); tracking=false; btn.textContent='ğŸ“'; },
    { enableHighAccuracy:true, maximumAge:5000, timeout:10000 }
  );
  tracking=true; btn.textContent='ğŸ”µ';
  toast('ğŸ“¡ ì¶”ì  ì‹œì‘');
});

/* ì´ˆê¸°í™” */
loadFacilities();

/* ì£¼ì†Œì°½/ë¦¬ì‚¬ì´ì¦ˆ ë³´ì • */
addEventListener('load', ()=>{
  setTimeout(()=> map.invalidateSize(), 0);
  setTimeout(()=> map.invalidateSize(), 250);
});
addEventListener('resize', ()=> map.invalidateSize());
</script>
</body>
</html>
