<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>ì†Œëª¨í’ˆ ê´€ë¦¬</title>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<style>
  /* [í†µì¼ëœ í…Œë§ˆ ë³€ìˆ˜] */
  :root {
    --hdr: 60px;
    /* Light Mode (ê¸°ë³¸) */
    --bg: #f4fbff; --ink: #0b2239; --muted: #64748b;
    --card-bg: #ffffff; --bd: #e2e8f0; --input-bg: #fff;
    --primary: #2563eb; --danger: #ef4444; --success: #10b981;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    --radius: 16px;
  }
  
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0b1622; --ink: #e6eef6; --muted: #94a3b8;
      --card-bg: #162032; --bd: rgba(255,255,255,0.1); --input-bg: #0d1b2a;
      --primary: #38bdf8; --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  body { margin: 0; background: var(--bg); color: var(--ink); font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; font-size: 15px; display: flex; flex-direction: column; height: 100vh; }
  
  i.ph { font-size: 18px; vertical-align: middle; }
  
  /* í—¤ë” í†µì¼ */
  .appbar { 
    background: var(--card-bg); border-bottom: 1px solid var(--bd); 
    padding: 0 16px; height: var(--hdr); display: flex; align-items: center; 
    justify-content: space-between; flex-shrink: 0; position: sticky; top: 0; z-index: 50; 
  }
  .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
  
  /* íƒ­ë°” í†µì¼ */
  .tab-bar { background: var(--card-bg); border-bottom: 1px solid var(--bd); display: flex; padding: 0 16px; gap: 24px; flex-shrink: 0; overflow-x: auto; }
  .tab { padding: 14px 4px; color: var(--muted); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; transition: .2s; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
  .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

  .main-area { flex: 1; overflow-y: auto; padding: 16px; max-width: 1200px; margin: 0 auto; width: 100%; }
  .view-panel { display: none; animation: fadeIn 0.2s ease-out; }
  .view-panel.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* ì…ë ¥ì°½ ë° ë²„íŠ¼ */
  .toolbar { display: flex; gap: 8px; margin-bottom: 16px; position: sticky; top: 0; z-index: 40; background: var(--bg); padding-bottom: 8px; }
  .input-wrap { position: relative; width: 100%; }
  .input-wrap i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 18px; }
  .input { 
    height: 44px; padding: 0 14px 0 40px; border: 1px solid var(--bd); 
    border-radius: var(--radius); width: 100%; background: var(--input-bg); 
    color: var(--ink); font-size: 15px; transition: border-color 0.2s;
  }
  .input:focus { border-color: var(--primary); }
  
  .btn { height: 44px; padding: 0 18px; border-radius: var(--radius); border: 1px solid var(--bd); background: var(--card-bg); color: var(--ink); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
  
  /* ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ í†µì¼ */
  .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 12px; }
  @media (max-width: 480px) { .grid-container { grid-template-columns: 1fr; } }

  .list-card { 
    background: var(--card-bg); border: 1px solid var(--bd); border-radius: var(--radius); 
    padding: 16px; display: flex; flex-direction: column; gap: 12px; box-shadow: var(--shadow); 
    height: 100%; transition: transform 0.1s;
  }
  .list-card:active { transform: scale(0.99); }
  
  .card-body { display: flex; gap: 14px; align-items: flex-start; flex: 1; }
  .avatar { width: 64px; height: 64px; border-radius: 12px; background: var(--bg); object-fit: cover; flex-shrink: 0; border: 1px solid var(--bd); }
  
  .card-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
  .card-title { font-weight: 700; font-size: 16px; color: var(--ink); line-height: 1.3; }
  .card-meta { font-size: 14px; color: var(--muted); }
  .card-price { font-size: 13px; font-weight: 600; color: var(--primary); background: rgba(37, 99, 235, 0.1); padding: 4px 8px; border-radius: 6px; width: fit-content; margin-top: 4px; }

  /* ì•¡ì…˜ë°” */
  .card-actions { display: flex; align-items: center; gap: 8px; border-top: 1px solid var(--bd); padding-top: 12px; margin-top: auto; }
  .stock-box { display: flex; align-items: center; background: var(--bg); border: 1px solid var(--bd); border-radius: 8px; padding: 2px; }
  .btn-mini { width: 36px; height: 36px; border: none; background: transparent; cursor: pointer; color: var(--muted); font-size: 18px; display:flex; align-items:center; justify-content:center;}
  .val-disp { font-weight: 700; min-width: 36px; text-align: center; font-size: 15px; color: var(--ink); }

  /* ëª¨ë‹¬ í†µì¼ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal-box { width: min(420px, 92vw); background: var(--card-bg); border-radius: 20px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); border: 1px solid var(--bd); }
  .modal-head { padding: 18px 24px; border-bottom: 1px solid var(--bd); font-weight: 700; font-size: 17px; display: flex; justify-content: space-between; align-items: center; color: var(--ink); }
  .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; color: var(--ink); }
  .modal-foot { padding: 16px 24px; background: var(--bg); border-top: 1px solid var(--bd); display: flex; justify-content: flex-end; gap: 10px; }
  
  .form-grid { display: grid; gap: 16px; }
  .field label { display: block; font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 6px; }

  #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 30px; font-weight: 600; opacity: 0; transition: .3s; pointer-events: none; z-index: 200; display: flex; align-items: center; gap: 8px; }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  
  /* Pager */
  .pager { display: flex; justify-content: center; gap: 12px; margin-top: 24px; align-items: center; color: var(--ink); }
  .btn-float { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.4); z-index: 90; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; }
/* --- [ìƒˆë¡œ ì¶”ê°€ëœ ë¼ì´íŠ¸ë°•ìŠ¤ ìŠ¤íƒ€ì¼] --- */
  #lightbox {
    position: fixed; inset: 0; z-index: 2000;
    background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    padding: 20px; /* ëª¨ë°”ì¼ì—ì„œ ê½‰ ì°¨ì§€ ì•Šê²Œ ì—¬ë°± */
  }
  #lightbox.show { opacity: 1; pointer-events: auto; }

  .lightbox-content {
    position: relative;
    max-width: 100%; max-height: 100%;
    transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* ë¿… í•˜ê³  ë‚˜íƒ€ë‚˜ëŠ” íš¨ê³¼ */
    display: flex; justify-content: center; align-items: center;
  }
  #lightbox.show .lightbox-content { transform: scale(1); }

  #lightboxImg {
    max-width: 100%; max-height: 90vh; /* í™”ë©´ ë†’ì´ì˜ 90%ê¹Œì§€ë§Œ */
    object-fit: contain;
    border-radius: 12px; /* ì´ë¯¸ì§€ ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
    box-shadow: 0 20px 40px rgba(0,0,0,0.4); /* ê¹Šì´ê° ìˆëŠ” ê·¸ë¦¼ì */
  }

  .lightbox-close {
    position: absolute; top: -20px; right: -20px;
    width: 44px; height: 44px; border-radius: 50%;
    background: rgba(255,255,255,0.2); color: #fff; border: none;
    font-size: 24px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s; backdrop-filter: blur(4px);
  }
  .lightbox-close:hover { background: rgba(255,255,255,0.4); transform: scale(1.1); }
  /* ëª¨ë°”ì¼ì—ì„œëŠ” ë‹«ê¸° ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
  @media (max-width: 480px) {
    .lightbox-close { top: 10px; right: 10px; background: rgba(0,0,0,0.5); }
  }
  /* ------------------------------------ */
</style>
</head>
<body>

<header class="appbar">
  <div class="brand"><i class="ph-fill ph-package"></i> ì†Œëª¨í’ˆ ê´€ë¦¬</div>
  <button class="btn" style="height:36px; padding:0 12px; border:none; background:#f1f5f9; color:var(--muted);" onclick="forceReload()">
    <i class="ph-bold ph-arrows-clockwise"></i> ë™ê¸°í™”
  </button>
</header>
<nav class="tab-bar">
  <div class="tab active" onclick="goTab('tab-inv')"><i class="ph ph-list-dashes"></i>ì¬ê³  ëª©ë¡</div>
  <div class="tab" onclick="goTab('tab-req')"><i class="ph ph-shopping-cart"></i>êµ¬ë§¤ ìš”ì²­</div>
  <div class="tab" onclick="goTab('tab-out')"><i class="ph ph-export"></i>ë¶ˆì¶œ ë‚´ì—­</div>
</nav>

<main class="main-area">
  <section id="tab-inv" class="view-panel active">
    <div class="toolbar">
      <div class="input-wrap">
        <i class="ph ph-magnifying-glass"></i>
        <input type="search" id="searchBox" class="input" placeholder="ë¬¼í’ˆëª…, ê·œê²© ê²€ìƒ‰..." oninput="renderPage(1)">
      </div>
    </div>
    
    <div id="skeletonLoader" style="display:none; padding:40px; text-align:center; color:var(--muted);">
      <i class="ph ph-spinner-gap ph-spin" style="font-size:32px; margin-bottom:8px;"></i><br>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>
    
    <div id="invList" class="grid-container"></div>
    
    <div class="pager">
      <button class="btn" onclick="movePage(-1)"><i class="ph-bold ph-caret-left"></i></button>
      <span id="pageInfo" style="font-weight:600; color:var(--muted)">1 / 1</span>
      <button class="btn" onclick="movePage(1)"><i class="ph-bold ph-caret-right"></i></button>
    </div>
    <button class="btn-float" onclick="openItemModal()"><i class="ph-bold ph-plus"></i></button>
  </section>

  <section id="tab-req" class="view-panel">
    <div class="toolbar">
      <div style="font-weight:700; font-size:16px; display:flex; align-items:center; gap:6px;">
        <i class="ph-fill ph-shopping-cart"></i> êµ¬ë§¤ ìš”ì²­ í˜„í™©
      </div>
      <div style="flex:1"></div>
      <button class="btn" style="height:36px;" onclick="loadLogs('req', 1)"><i class="ph-bold ph-arrows-clockwise"></i></button>
    </div>
    <div id="reqList" class="grid-container"></div>
    <div class="pager">
      <button class="btn" onclick="moveLogPage('req', -1)"><i class="ph-bold ph-caret-left"></i></button>
      <span id="reqPageInfo" style="font-weight:600;">1 / 1</span>
      <button class="btn" onclick="moveLogPage('req', 1)"><i class="ph-bold ph-caret-right"></i></button>
    </div>
  </section>

  <section id="tab-out" class="view-panel">
    <div class="toolbar">
      <div style="font-weight:700; font-size:16px; display:flex; align-items:center; gap:6px;">
        <i class="ph-fill ph-export"></i> ë¶ˆì¶œ(ì‚¬ìš©) ì´ë ¥
      </div>
      <div style="flex:1"></div>
      <button class="btn" style="height:36px;" onclick="loadLogs('out', 1)"><i class="ph-bold ph-arrows-clockwise"></i></button>
    </div>
    <div id="outList" class="grid-container"></div>
    <div class="pager">
      <button class="btn" onclick="moveLogPage('out', -1)"><i class="ph-bold ph-caret-left"></i></button>
      <span id="outPageInfo" style="font-weight:600;">1 / 1</span>
      <button class="btn" onclick="moveLogPage('out', 1)"><i class="ph-bold ph-caret-right"></i></button>
    </div>
  </section>
</main>

<div id="lightbox">
  <div class="lightbox-content">
    <img id="lightboxImg" src="">
    <button class="lightbox-close" onclick="closeLightbox()"><i class="ph-bold ph-x"></i></button>
  </div>
</div>

<div id="itemModal" class="modal-overlay"><div class="modal-box">
  <div class="modal-head"><span>ë¬¼í’ˆ ì •ë³´</span><button class="btn-mini" onclick="closeModal('itemModal')"><i class="ph-bold ph-x"></i></button></div>
  <div class="modal-body"><input type="hidden" id="editId">
    <div class="form-grid">
      <div class="field"><label>ë¬¼í’ˆëª…</label><input id="editName" class="input"></div>
      <div class="field"><label>ê·œê²© / ê¸°ê¸°</label><div style="display:flex; gap:8px;"><input id="editSpec" class="input" placeholder="ê·œê²©"><input id="editDevice" class="input" placeholder="ê¸°ê¸°"></div></div>
      <div class="field"><label>í˜„ì¬ ì¬ê³ </label><input id="editQty" type="number" class="input"></div>
      <div class="field" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <div><label>ì—…ì²´ ë‹¨ê°€</label><input id="editCostV" class="input" placeholder="0"></div>
        <div><label>ì¸í„°ë„· ë‹¨ê°€</label><input id="editCostI" class="input" placeholder="0"></div>
      </div>
      <div class="field"><label>êµ¬ë§¤ ë§í¬</label><input id="editLink" class="input" placeholder="https://..."></div>
      <div class="field"><label>ì‚¬ì§„</label><div style="display:flex; gap:8px;"><input id="editImg" class="input" readonly placeholder="ì´ë¯¸ì§€ ì½”ë“œ" style="color:#999; font-size:11px;"><label class="btn">ğŸ“·<input type="file" hidden onchange="processImg(this)"></label></div></div>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn danger" id="btnDel" onclick="deleteItem()"><i class="ph-bold ph-trash"></i> ì‚­ì œ</button>
    <div style="flex:1"></div>
    <button class="btn primary" onclick="saveItem()"><i class="ph-bold ph-check"></i> ì €ì¥</button>
  </div>
</div></div>

<div id="outModal" class="modal-overlay"><div class="modal-box">
  <div class="modal-head"><span>ğŸ“‰ ë¶ˆì¶œ ì²˜ë¦¬</span><button class="btn-mini" onclick="closeModal('outModal')"><i class="ph-bold ph-x"></i></button></div>
  <div class="modal-body">
    <h3 id="outName" style="margin:0 0 4px 0;"></h3><div id="outSpec" style="color:var(--muted); font-size:13px; margin-bottom:20px;"></div>
    <div class="form-grid">
      <div class="field"><label>ì‚¬ìš©ì ì´ë¦„</label><input id="outWho" class="input" placeholder="ëˆ„ê°€ ê°€ì ¸ê°€ë‚˜ìš”?"></div>
      <div class="field"><label>ìˆ˜ëŸ‰</label>
        <div class="stock-box" style="justify-content:center; padding:8px; height:44px;">
          <button class="btn-mini minus" onclick="adjVal('outQty',-1)"><i class="ph-bold ph-minus"></i></button>
          <input id="outQty" readonly value="1" style="width:60px; text-align:center; border:none; background:transparent; font-weight:800; font-size:18px;">
          <button class="btn-mini" onclick="adjVal('outQty',1)"><i class="ph-bold ph-plus"></i></button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn danger" onclick="confirmCheckout()" style="width:100%">í™•ì¸</button></div>
</div></div>

<div id="reqModal" class="modal-overlay"><div class="modal-box">
  <div class="modal-head"><span>ğŸ›’ êµ¬ë§¤ ìš”ì²­</span><button class="btn-mini" onclick="closeModal('reqModal')"><i class="ph-bold ph-x"></i></button></div>
  <div class="modal-body">
    <h3 id="reqName" style="margin:0 0 4px 0;"></h3><div id="reqSpec" style="color:var(--muted); font-size:13px; margin-bottom:20px;"></div>
    <div class="form-grid">
      <div class="field"><label>ìš”ì²­ì</label><input id="reqWho" class="input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"></div>
      <div class="field"><label>í•„ìš” ì‚¬ìœ  (ë¹„ê³ )</label><input id="reqNote" class="input" placeholder="ì˜ˆ: ì¬ê³  ë¶€ì¡±, ì˜ˆë¹„í’ˆ"></div>
      <div class="field"><label>ìš”ì²­ ìˆ˜ëŸ‰</label>
        <div class="stock-box" style="justify-content:center; padding:8px; height:44px;">
          <button class="btn-mini minus" onclick="adjVal('reqQty',-1)"><i class="ph-bold ph-minus"></i></button>
          <input id="reqQty" readonly value="1" style="width:60px; text-align:center; border:none; background:transparent; font-weight:800; font-size:18px;">
          <button class="btn-mini" onclick="adjVal('reqQty',1)"><i class="ph-bold ph-plus"></i></button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-foot"><button class="btn primary" onclick="confirmReq()" style="width:100%">ìš”ì²­ ì „ì†¡</button></div>
</div></div>

<div id="toast"><i class="ph-fill ph-check-circle"></i> <span>ë©”ì‹œì§€</span></div>

<script>
// *** ë³¸ì¸ì˜ êµ¬ê¸€ ì›¹ì•± URL ***
const APP_URL = "https://script.google.com/macros/s/AKfycbw0IzxOyswXNl8p7E9mNt8mCKOAXFZfXcjhpse9mBvyLFJ6pkLHJYo_a27M73h8CKWfSA/exec";

// ìƒíƒœ ë³€ìˆ˜
let inventory = JSON.parse(localStorage.getItem('local_inv') || '[]');
let imgCache = JSON.parse(localStorage.getItem('local_img') || '{}');
let curPage = 1, curReqPage = 1, curOutPage = 1;
const ITEMS_PER_PAGE = 12; // ê·¸ë¦¬ë“œ í˜•íƒœë‹ˆê¹Œ í•œ í˜ì´ì§€ì— ë” ë§ì´ ë³´ì—¬ì¤Œ
const $ = s => document.querySelector(s);
const num = n => n ? Number(n).toLocaleString() : '';
const toast = m => { const t = $('#toast'); t.querySelector('span').textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); };
const fmtDate = d => { if(!d) return '-'; const dt = new Date(d); return `${dt.getFullYear()}.${dt.getMonth()+1}.${dt.getDate()}`; };

function init() { renderPage(1); syncData(); }

function syncData() {
  if(inventory.length === 0) $('#skeletonLoader').style.display = 'block';
  jsonp(`${APP_URL}?op=read_text_data`, (res) => {
    $('#skeletonLoader').style.display = 'none';
    if(res.status === 'success') {
      inventory = res.data;
      localStorage.setItem('local_inv', JSON.stringify(inventory));
      renderPage(curPage);
      toast("ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ");
    }
  });
}
function forceReload() { localStorage.removeItem('local_inv'); location.reload(); }

// ì‚¬ì§„ í™•ëŒ€ ê¸°ëŠ¥
// ì‚¬ì§„ í™•ëŒ€ ê¸°ëŠ¥ (ê°œì„ ë¨)
function zoomImg(src) {
  if(!src || src.includes('base64,R0')) return; // ê¸°ë³¸ì´ë¯¸ì§€ ì œì™¸
  const lb = $('#lightbox');
  const img = $('#lightboxImg');
  
  // ì´ë¯¸ì§€ ë¡œë”© ì „ê¹Œì§€ ê¸°ì¡´ ì´ë¯¸ì§€ ìˆ¨ê¹€ (ê¹œë¹¡ì„ ë°©ì§€)
  img.style.opacity = '0';
  img.src = src;
  
  img.onload = () => { img.style.opacity = '1'; };
  lb.classList.add('show');
}

function closeLightbox() {
  $('#lightbox').classList.remove('show');
  // ë‹«ì„ ë•Œ srcë¥¼ ë¹„ì›Œ ë‹¤ìŒ ì—´ ë•Œ ì´ì „ ì´ë¯¸ì§€ê°€ ì ê¹ ë³´ì´ëŠ” ê²ƒ ë°©ì§€
  setTimeout(() => { $('#lightboxImg').src = ''; }, 300);
}

// ë¼ì´íŠ¸ë°•ìŠ¤ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° ì´ë²¤íŠ¸ ë“±ë¡
document.getElementById('lightbox').addEventListener('click', function(e) {
  // ì´ë¯¸ì§€ ìì²´ë‚˜ ë‹«ê¸° ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš°ëŠ” ì œì™¸í•˜ê³  ë°°ê²½ í´ë¦­ë§Œ ê°ì§€
  if (e.target === this || e.target.classList.contains('lightbox-content')) {
    closeLightbox();
  }
});

function renderPage(page) {
  curPage = page;
  const q = $('#searchBox').value.toLowerCase();
  const filtered = inventory.filter(i => (i.name+i.spec+i.device).toLowerCase().includes(q));
  
  const total = filtered.length;
  const maxPage = Math.ceil(total / ITEMS_PER_PAGE) || 1;
  if(curPage > maxPage) curPage = maxPage; if(curPage < 1) curPage = 1;
  
  const start = (curPage-1) * ITEMS_PER_PAGE;
  const pageItems = filtered.slice(start, start + ITEMS_PER_PAGE);
  
  $('#invList').innerHTML = pageItems.map(i => {
    const imgSrc = imgCache[i.id] || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
    return `
    <div class="list-card">
      <div class="card-body">
        <img src="${imgSrc}" class="avatar" onclick="zoomImg('${imgSrc}')">
        <div class="card-info">
          <div class="card-title">${i.name}</div>
          <div class="card-meta"><i class="ph ph-tag"></i> ${i.spec || '-'}</div>
          <div class="card-meta"><i class="ph ph-desktop"></i> ${i.device || '-'}</div>
          ${i.cost_vendor || i.cost_inet ? `<div class="card-price">â‚© ${num(i.cost_vendor || i.cost_inet)}</div>` : ''}
        </div>
      </div>
      
      <div class="card-actions">
        <div class="stock-box">
          <button class="btn-mini minus" onclick="openOut('${i.id}')"><i class="ph-bold ph-minus"></i></button>
          <span class="val-disp">${i.qty}</span>
          <button class="btn-mini" onclick="openItemModal('${i.id}')"><i class="ph-bold ph-pencil-simple"></i></button>
        </div>
        <button class="btn primary" style="flex:1; height:40px; font-size:14px;" onclick="openReq('${i.id}')"><i class="ph-bold ph-shopping-cart"></i> ë‹´ê¸°</button>
      </div>
    </div>`;
  }).join('') || '<div style="grid-column:1/-1; padding:60px; text-align:center; color:var(--muted);">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';

  $('#pageInfo').innerText = `${curPage} / ${maxPage}`;
  loadImages(pageItems);
}

function loadImages(items) {
  const missingIds = items.filter(i => i.hasImg && !imgCache[i.id]).map(i => i.id);
  if(missingIds.length > 0) {
    jsonp(`${APP_URL}?op=get_images_batch&ids=${missingIds.join(',')}`, (res) => {
      if(res.images) {
        Object.assign(imgCache, res.images);
        localStorage.setItem('local_img', JSON.stringify(imgCache));
        for(let id in res.images) { 
          const el = document.querySelector(`[onclick="openOut('${id}')"]`).closest('.list-card').querySelector('.avatar'); 
          if(el) el.src = res.images[id]; 
          el.setAttribute('onclick', `zoomImg('${res.images[id]}')`); // ì¤Œ ì´ë²¤íŠ¸ ê°±ì‹ 
        }
      }
    });
  }
}

function loadLogs(type, page) {
  const list = type === 'req' ? $('#reqList') : $('#outList');
  if(type === 'req') curReqPage = page; else curOutPage = page;
  list.innerHTML = '<div style="grid-column:1/-1; padding:40px; text-align:center; color:var(--muted);"><i class="ph ph-spinner-gap ph-spin" style="font-size:24px;"></i></div>';
  
  jsonp(`${APP_URL}?op=read_logs&type=${type}&page=${page}`, (res) => {
    const logs = res.logs || [];
    const total = res.total || 0;
    const maxPage = Math.ceil(total / 10) || 1;
    
    if(type === 'req') $('#reqPageInfo').innerText = `${page} / ${maxPage}`;
    else $('#outPageInfo').innerText = `${page} / ${maxPage}`;
    
    if(logs.length === 0) { list.innerHTML = '<div style="grid-column:1/-1; padding:40px; text-align:center; color:var(--muted);">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    
    list.innerHTML = logs.map(l => {
      const logId = l[l.length-1];
      if(type === 'req') {
        const isDone = l[6] === 'êµ¬ë§¤ì™„ë£Œ';
        let linkUrl = l[8];
        if (linkUrl && !linkUrl.startsWith('http')) { linkUrl = 'https://' + linkUrl; }
        const linkHtml = linkUrl ? `<a href="${linkUrl}" target="_blank" class="btn link"><i class="ph-bold ph-link"></i> êµ¬ë§¤ë§í¬</a>` : '';
        
        return `
        <div class="list-card">
          <div class="card-body">
            <div class="card-info">
              <div class="card-title">${l[3]} <span style="color:var(--primary);">(${l[5]}ê°œ)</span></div>
              <div class="card-meta"><i class="ph ph-user"></i> ${l[1]} Â· ${fmtDate(l[0])}</div>
              <div class="card-meta" style="color:var(--danger)">${l[7]||''}</div>
              <div style="margin-top:4px;">${linkHtml}</div>
            </div>
          </div>
          <div class="card-actions" style="justify-content:space-between;">
            <span class="badge ${isDone?'done':'req'}" style="cursor:pointer" onclick="toggleReqStatus('${logId}','${l[6]}')">
              <i class="ph-fill ${isDone?'ph-check-circle':'ph-clock'}"></i> ${l[6]}
            </span>
            <button class="btn-mini" onclick="deleteLog('req','${logId}')"><i class="ph ph-trash"></i></button>
          </div>
        </div>`;
      } else {
        return `
        <div class="list-card">
          <div class="card-body">
            <div class="card-info">
              <div class="card-title">${l[3]} <span style="color:var(--danger);">(-${l[5]})</span></div>
              <div class="card-meta"><i class="ph ph-user"></i> ${l[1]} Â· ${fmtDate(l[0])}</div>
            </div>
          </div>
          <div class="card-actions" style="justify-content:space-between;">
             <div class="card-meta">ì”ê³ : ${l[6]}</div>
             <button class="btn-mini" onclick="deleteLog('out','${logId}')"><i class="ph ph-trash"></i></button>
          </div>
        </div>`;
      }
    }).join('');
  });
}

function sendData(fd, msg) {
  fetch(APP_URL, {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
    if(d.result!=='success' && d.result!=='saved' && d.result!=='deleted') alert('ì„œë²„ ì €ì¥ ì‹¤íŒ¨: '+d.msg);
  }).catch(e=>console.error(e));
  if(msg) toast(msg);
}

function saveItem() {
  const id = $('#editId').value || 'ITEM'+Math.random().toString(36).slice(2,8).toUpperCase();
  const newItem = { id, name:$('#editName').value, spec:$('#editSpec').value, device:$('#editDevice').value, qty:Number($('#editQty').value), cost_vendor:$('#editCostV').value, cost_inet:$('#editCostI').value, img:$('#editImg').value, hasImg:!!$('#editImg').value, link:$('#editLink').value };
  
  const idx = inventory.findIndex(x => x.id === id);
  if(idx>=0) inventory[idx] = newItem; else inventory.unshift(newItem);
  if(newItem.img) imgCache[id] = newItem.img;
  localStorage.setItem('local_inv', JSON.stringify(inventory));
  
  closeModal('itemModal'); renderPage(curPage);
  const fd=new FormData(); fd.append('op','save_item'); for(let k in newItem) fd.append(k, newItem[k]);
  sendData(fd, "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");
}

function deleteItem() {
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const id = $('#editId').value;
  inventory = inventory.filter(x => x.id !== id);
  localStorage.setItem('local_inv', JSON.stringify(inventory));
  closeModal('itemModal'); renderPage(curPage);
  const fd=new FormData(); fd.append('op','delete_item'); fd.append('id',id);
  sendData(fd, "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤");
}

function confirmCheckout() {
  const id=$('#outModal').dataset.id, who=$('#outWho').value, qty=Number($('#outQty').value);
  if(!who) return toast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  const item = inventory.find(x => x.id === id);
  item.qty -= qty;
  localStorage.setItem('local_inv', JSON.stringify(inventory));
  closeModal('outModal'); renderPage(curPage);
  const fd=new FormData(); fd.append('op','checkout'); fd.append('id',id); fd.append('qty',qty); fd.append('who',who); fd.append('item',item.name); fd.append('spec',item.spec);
  sendData(fd, "ë¶ˆì¶œ ì²˜ë¦¬ ì™„ë£Œ");
}

function confirmReq() {
  const id=$('#reqModal').dataset.id, who=$('#reqWho').value, qty=Number($('#reqQty').value), note=$('#reqNote').value;
  if(!who) return toast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
  closeModal('reqModal');
  const item = inventory.find(x=>x.id===id);
  const fd=new FormData(); fd.append('op','add_req'); fd.append('id',id); fd.append('who',who); fd.append('item',item.name); fd.append('spec',item.spec); fd.append('qty',qty); fd.append('note',note); fd.append('link', item.link || '');
  sendData(fd, "êµ¬ë§¤ ìš”ì²­ ì „ì†¡ë¨");
}

function deleteLog(type, logId) { if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; const fd=new FormData(); fd.append('op','delete_log'); fd.append('type',type); fd.append('logId',logId); fetch(APP_URL, {method:'POST', body:fd}).then(()=>loadLogs(type, type==='req'?curReqPage:curOutPage)); }
function toggleReqStatus(logId, st) { const nSt = st==='ìš”ì²­'?'êµ¬ë§¤ì™„ë£Œ':'ìš”ì²­'; if(!confirm(`'${nSt}' ìƒíƒœë¡œ ë³€ê²½í• ê¹Œìš”?`)) return; const fd=new FormData(); fd.append('op','update_req_status'); fd.append('logId',logId); fd.append('status',nSt); fetch(APP_URL, {method:'POST', body:fd}).then(()=>loadLogs('req', curReqPage)); }

function goTab(t) { document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.view-panel').forEach(e=>e.classList.remove('active')); event.target.classList.add('active'); $('#'+t).classList.add('active'); if(t!=='tab-inv') loadLogs(t==='tab-req'?'req':'out', 1); }
function openItemModal(id) { const i=id?inventory.find(x=>x.id===id):null; $('#editId').value=id||''; $('#editName').value=i?i.name:''; $('#editSpec').value=i?i.spec:''; $('#editDevice').value=i?i.device:''; $('#editQty').value=i?i.qty:'0'; $('#editCostV').value=i?i.cost_vendor:''; $('#editCostI').value=i?i.cost_inet:''; $('#editImg').value=i&&imgCache[i.id]?imgCache[i.id]:''; $('#editLink').value=i?i.link||'':''; $('#btnDel').style.display=id?'block':'none'; $('#itemModal').classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function openOut(id) { const i=inventory.find(x=>x.id===id); $('#outName').textContent=i.name; $('#outSpec').textContent=i.spec; $('#outModal').dataset.id=id; $('#outQty').value=1; $('#outWho').value=''; $('#outModal').classList.add('open'); }
function openReq(id) { const i=inventory.find(x=>x.id===id); $('#reqName').textContent=i.name; $('#reqSpec').textContent=i.spec; $('#reqModal').dataset.id=id; $('#reqQty').value=1; $('#reqWho').value=''; $('#reqNote').value=''; $('#reqModal').classList.add('open'); }
function adjVal(id, d) { const v=Number($('#'+id).value)+d; if(v>0)$('#'+id).value=v; }
function movePage(d) { renderPage(curPage+d); }
function moveLogPage(t, d) { loadLogs(t, (t==='req'?curReqPage:curOutPage)+d); }
function processImg(input) { const f=input.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{ const c=document.createElement('canvas'); let w=i.width, h=i.height; if(w>300){h*=300/w; w=300;} c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h); $('#editImg').value=c.toDataURL('image/jpeg', 0.5); }}; r.readAsDataURL(f); }
function jsonp(url, cb) { const n='cb'+Math.random().toString(36).slice(2); window[n]=d=>{cb(d);delete window[n];$('#'+n).remove()}; const s=document.createElement('script'); s.id=n; s.src=`${url}&cb=${n}`; document.body.appendChild(s); }

init();
</script>
</body>
</html>