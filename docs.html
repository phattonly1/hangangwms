<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>ìˆ˜ì§ˆìë™ì¸¡ì •ë§ ì˜¨ë¼ì¸ í•¸ë“œë¶</title>
    <style>
    /* [í†µì¼ëœ í…Œë§ˆ ë³€ìˆ˜] */
    :root {
        --hdr: 60px; --search-h: 70px;
        --gap: 16px; --btn: 56px; --round: 16px;
        --sidebar-w: 280px;
        --sa-t: env(safe-area-inset-top, 0px);
        --sa-b: env(safe-area-inset-bottom, 0px);
        
        /* Light Mode (ê¸°ë³¸) */
        --bg: #e6f4ff; --card-bg: #ffffff;
        --text-main: #0b2239; --text-sub: #64748b;
        --bd: rgba(0,0,0,0.08); --highlight: rgba(14, 165, 233, 0.2);
        --accent: #0ea5e9;
        --shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --bg: #0b1622; --card-bg: #162032;
            --text-main: #e6eef6; --text-sub: #94a3b8;
            --bd: rgba(255,255,255,0.1); --highlight: rgba(56, 189, 248, 0.3);
            --accent: #38bdf8;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; }
    body { background-color: var(--bg); color: var(--text-main); -webkit-tap-highlight-color: transparent; }

    /* ì•±ë°” í†µì¼ */
    .appbar {
        position: fixed; top: 0; left: 0; right: 0; z-index: 100;
        height: calc(var(--hdr) + var(--sa-t)); padding: var(--sa-t) var(--gap) 0 var(--gap);
        background: var(--card-bg); backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--bd);
        display: flex; align-items: center; justify-content: space-between;
    }
    .app-left { display: flex; align-items: center; gap: 12px; }
    .menu-btn { background: none; border: none; color: var(--text-main); font-size: 24px; cursor: pointer; padding: 4px; display: flex; align-items: center; }
    .appbar h1 { margin: 0; font-size: 20px; font-weight: 800; color: var(--text-main); }

    /* ê²€ìƒ‰ì°½ ì˜ì—­ */
    .search-wrap {
        position: fixed; top: calc(var(--hdr) + var(--sa-t)); left: 0; right: 0;
        height: var(--search-h); z-index: 90; padding: 10px var(--gap);
        background: var(--bg); border-bottom: 1px solid var(--bd);
    }
    .input-container { position: relative; height: 100%; }
    #searchInput {
        width: 100%; height: 100%; padding: 0 16px; padding-right: 40px;
        border-radius: var(--round); border: 1px solid var(--bd);
        background: var(--card-bg); color: var(--text-main); font-size: 16px;
        box-shadow: var(--shadow);
    }
    #searchInput:focus { outline: none; border-color: var(--accent); }
    .clear-search-btn {
        position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
        width: 30px; height: 30px; border: none; background: transparent;
        color: var(--text-sub); font-size: 16px; cursor: pointer; display: none;
    }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    #listContainer, #searchResultContainer {
        padding: var(--gap);
        padding-top: calc(var(--hdr) + var(--sa-t) + var(--search-h) + 10px);
        padding-bottom: calc(100px + var(--sa-b));
        max-width: 800px; margin: 0 auto;
    }
    #searchResultContainer { display: none; }

    /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
    .sidebar-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
        opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(2px);
    }
    .sidebar-overlay.open { opacity: 1; visibility: visible; }

    .sidebar {
        position: fixed; top: 0; bottom: 0; left: -100%;
        width: var(--sidebar-w); max-width: 80%;
        background: var(--card-bg); z-index: 1001;
        box-shadow: 4px 0 20px rgba(0,0,0,0.2);
        transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column;
        padding-top: calc(var(--sa-t) + 20px);
        border-right: 1px solid var(--bd);
    }
    .sidebar.open { left: 0; }
    
    .sidebar-header { padding: 0 20px 20px 20px; border-bottom: 1px solid var(--bd); display: flex; justify-content: space-between; align-items: center; }
    .sidebar-header h2 { margin: 0; font-size: 18px; color: var(--accent); font-weight: 800; }
    .close-sidebar-btn { background: none; border: none; color: var(--text-sub); font-size: 24px; cursor: pointer; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 10px 0; }
    
    .nav-item {
        display: block; padding: 12px 20px; color: var(--text-main);
        text-decoration: none; font-size: 15px; cursor: pointer;
        border-left: 3px solid transparent; transition: background 0.2s;
    }
    .nav-item:hover { background: rgba(0,0,0,0.03); }
    .nav-item.active { border-left-color: var(--accent); background: var(--highlight); color: var(--accent); font-weight: bold; }
    
    /* ê³„ì¸µêµ¬ì¡° ìŠ¤íƒ€ì¼ */
    .nav-tree ul ul .nav-item { padding-left: 35px; font-size: 14px; color: var(--text-sub); }
    .nav-tree ul ul ul .nav-item { padding-left: 50px; }
    .nav-tree ul { list-style: none; padding-left: 0; margin: 0; }

    /* ë¬¸ì„œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .result-card { 
        background-color: var(--card-bg); border: 1px solid var(--bd); 
        border-radius: var(--round); padding: 16px; margin-bottom: 12px; 
        cursor: pointer; box-shadow: var(--shadow);
    }
    .result-path { font-size: 12px; color: var(--accent); margin-bottom: 6px; font-weight: 600; }
    .result-text { font-size: 15px; line-height: 1.6; color: var(--text-main); }
    .result-text .highlight { background-color: var(--highlight); color: var(--accent); border-radius: 4px; padding: 0 2px; font-weight: bold; }

    /* Details/Summary ìŠ¤íƒ€ì¼ */
    details { background: var(--card-bg); margin-bottom: 12px; border-radius: var(--round); border: 1px solid var(--bd); overflow: hidden; box-shadow: var(--shadow); }
    summary { padding: 16px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); transition: background 0.2s; }
    summary:hover { background: rgba(0,0,0,0.02); }
    summary::after { content: 'â–¼'; font-size: 12px; color: var(--text-sub); transition: transform 0.3s; }
    details[open] > summary::after { transform: rotate(180deg); color: var(--accent); }
    
    .content-box { padding: 20px; background: var(--bg); border-top: 1px solid var(--bd); font-size: 15px; line-height: 1.6; color: var(--text-sub); }
    .sub-list { border-top: 1px solid var(--bd); background: rgba(0,0,0,0.02); padding: 10px 0 10px 16px; }

    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    .content-box table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 14px; border-style: hidden; }
    .content-box th, .content-box td { border: 1px solid var(--bd); padding: 10px 12px; text-align: left; }
    .content-box th { background-color: var(--card-bg); color: var(--accent); font-weight: 700; }
    
    .doc-segment { margin-bottom: 8px; padding: 4px; border-radius: 4px; transition: background 1s; }
    .doc-segment.flash-target { background-color: var(--highlight); }

    #noResult { text-align: center; color: var(--text-sub); margin-top: 50px; display: none; }

    /* FAB ë²„íŠ¼ */
    .br-dock { position: fixed; z-index: 900; right: var(--gap); bottom: calc(var(--gap) + var(--sa-b)); display: flex; flex-direction: column; gap: 12px; }
    .fab { 
        width: var(--btn); height: var(--btn); display: grid; place-items: center; 
        border: 1px solid var(--bd); border-radius: 50%; cursor: pointer; 
        background: var(--card-bg); color: var(--text-main); 
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 20px; 
    }
    .fab--return { background: var(--accent); color: #fff; display: none; border:none; }
</style>
</head>
<body>

    <header class="appbar">
        <div class="app-left">
            <button class="menu-btn" id="menuBtn">â˜°</button>
            <h1>ğŸ“–ì˜¨ë¼ì¸ í•¸ë“œë¶</h1>
        </div>
        <div style="font-size: 14px; color: var(--text-sub);" id="docCount">0ê±´</div>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>ëª©ì°¨</h2>
            <button class="close-sidebar-btn" id="closeSidebarBtn">âœ–</button>
        </div>
        <div class="sidebar-content nav-tree" id="sidebarContent">
            </div>
    </aside>

    <div class="search-wrap">
        <div class="input-container">
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ í•´ë‹¹ ë¶€ë¶„ë§Œ ë³´ì…ë‹ˆë‹¤..." autocomplete="off">
            <button class="clear-search-btn" id="clearBtn">âœ–</button>
        </div>
    </div>

    <main id="listContainer">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</main>

    <div id="searchResultContainer"></div>
    <div id="noResult">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>

    <div class="br-dock">
        <button class="fab fab--return" id="backToSearchBtn" title="ê²€ìƒ‰ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°">â†©</button>
        <button class="fab" id="topBtn" title="ìœ„ë¡œ">â¬†</button>
    </div>

    <script>
        const CHO_SUNG = ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
        function getChosung(str) {
            let result = "";
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i) - 44032;
                if (code > -1 && code < 11172) result += CHO_SUNG[Math.floor(code / 588)];
                else result += str.charAt(i);
            }
            return result;
        }

        let docData = [];
        const listContainer = document.getElementById('listContainer');
        const searchResultContainer = document.getElementById('searchResultContainer');
        const noResult = document.getElementById('noResult');
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearBtn');
        const backToSearchBtn = document.getElementById('backToSearchBtn');
        
        // ì‚¬ì´ë“œë°” ìš”ì†Œ
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const sidebarContent = document.getElementById('sidebarContent');

        let debounceTimer;
        let lastScrollPosition = 0;

        // 1. ë°ì´í„° ë¡œë“œ
        fetch('data.json')
            .then(res => res.json())
            .then(data => {
                assignIds(data);
                docData = data;
                
                // ë©”ì¸ ì»¨í…ì¸  ìƒì„±
                listContainer.innerHTML = buildTreeHTML(docData);
                document.getElementById('docCount').textContent = `ì´ ${countItems(data)}ê±´`;
                
                // ì‚¬ì´ë“œë°” ëª©ì°¨ ìƒì„± (NEW)
                sidebarContent.innerHTML = buildSidebarHTML(docData);
            })
            .catch(err => {
                listContainer.innerHTML = '<div style="text-align:center; padding:20px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            });

        function assignIds(items, prefix = 'node') {
            items.forEach((item, idx) => {
                item.uid = `${prefix}-${idx}`;
                if (item.children) assignIds(item.children, item.uid);
            });
        }
        function countItems(items) {
            let count = 0;
            items.forEach(item => { count++; if(item.children) count += countItems(item.children); });
            return count;
        }

        // 2. HTML ìƒì„± (ë©”ì¸)
        function buildTreeHTML(items) {
            let html = '';
            items.forEach(item => {
                const detailId = `detail-${item.uid}`;
                html += `<details id="${detailId}">`;
                html += `<summary>${item.title}</summary>`;
                if (item.content) {
                    html += `<div class="content-box">`;
                    const parts = splitContent(item.content);
                    parts.forEach((part, pIdx) => {
                        const segmentId = `seg-${item.uid}-${pIdx}`;
                        html += `<div id="${segmentId}" class="doc-segment">${part}</div>`;
                    });
                    html += `</div>`;
                }
                if (item.children) html += `<div class="sub-list">${buildTreeHTML(item.children)}</div>`;
                html += `</details>`;
            });
            return html;
        }

        // 2-1. ì‚¬ì´ë“œë°” ëª©ì°¨ ìƒì„± (NEW)
        function buildSidebarHTML(items) {
            let html = '<ul>';
            items.forEach(item => {
                const targetId = `detail-${item.uid}`;
                html += `<li>`;
                html += `<a class="nav-item" onclick="handleNavClick('${targetId}')">${item.title}</a>`;
                if (item.children) {
                    html += buildSidebarHTML(item.children);
                }
                html += `</li>`;
            });
            html += '</ul>';
            return html;
        }

        function splitContent(content) {
            return content.split(/<p[^>]*>|<\/p>|<div[^>]*>|<\/div>|<br\s*\/?>/i).map(s => s.trim()).filter(s => s.length > 0);
        }

        // 3. ì‚¬ì´ë“œë°” ì œì–´ ë¡œì§ (NEW)
        function toggleSidebar(open) {
            if (open) {
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('open');
            } else {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
            }
        }

        menuBtn.addEventListener('click', () => toggleSidebar(true));
        closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
        sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

        // ì‚¬ì´ë“œë°” í•­ëª© í´ë¦­ ì‹œ ì´ë™
        window.handleNavClick = function(targetId) {
            toggleSidebar(false); // ì‚¬ì´ë“œë°” ë‹«ê¸°
            
            // ê²€ìƒ‰ ì¤‘ì´ì—ˆë‹¤ë©´ ë©”ì¸ ë·°ë¡œ ë³µê·€
            if (searchInput.value.trim().length > 0) {
                 searchInput.value = '';
                 showMainTree();
                 clearBtn.style.display = 'none';
                 backToSearchBtn.style.display = 'none';
            }

            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                // ë¶€ëª¨ë“¤ì´ ë‹«í˜€ìˆë‹¤ë©´ ì—´ê¸°
                let parent = targetEl.parentElement;
                while (parent) {
                    if (parent.tagName === 'DETAILS') parent.open = true;
                    parent = parent.parentElement;
                }
                // íƒ€ê²Ÿ ìì²´ë„ detailsë¼ë©´ ì—´ê¸°
                if (targetEl.tagName === 'DETAILS') targetEl.open = true;

                // ìŠ¤í¬ë¡¤ ì´ë™
                const offset = 140; 
                const elementPosition = targetEl.getBoundingClientRect().top + window.scrollY;
                const offsetPosition = elementPosition - offset;
                
                window.scrollTo({ top: offsetPosition, behavior: 'smooth' });

                // ê°•ì¡° íš¨ê³¼ (summaryì—)
                const summary = targetEl.querySelector('summary');
                if(summary) {
                    summary.style.color = 'var(--accent)';
                    setTimeout(() => summary.style.color = '', 1500);
                }
            }
        };


        // 4. ê²€ìƒ‰ ë¡œì§
        searchInput.addEventListener('input', function() {
            const val = this.value.trim();
            clearBtn.style.display = val.length > 0 ? 'block' : 'none';
            backToSearchBtn.style.display = 'none';

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (val === '') showMainTree();
                else performSearch(val);
            }, 200);
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            searchInput.focus();
            showMainTree();
            clearBtn.style.display = 'none';
            backToSearchBtn.style.display = 'none';
        });

        function showMainTree() {
            listContainer.style.display = 'block';
            searchResultContainer.style.display = 'none';
            noResult.style.display = 'none';
        }

        function performSearch(keyword) {
            const keywords = keyword.split(/\s+/).filter(k => k.length > 0);
            const results = [];

            function traverse(items, pathStr) {
                items.forEach(item => {
                    const currentPath = pathStr ? `${pathStr} > ${item.title}` : item.title;
                    if (item.content) {
                        const parts = splitContent(item.content);
                        parts.forEach((part, pIdx) => {
                            const tempDiv = document.createElement('div'); tempDiv.innerHTML = part;
                            const textOnly = tempDiv.textContent;
                            const chosungOnly = getChosung(textOnly);
                            const isMatch = keywords.every(k => textOnly.toLowerCase().includes(k.toLowerCase()) || chosungOnly.includes(k.toLowerCase()));

                            if (isMatch) {
                                results.push({
                                    path: currentPath,
                                    html: highlightText(part, keywords),
                                    targetId: `seg-${item.uid}-${pIdx}`
                                });
                            }
                        });
                    }
                    if (item.children) traverse(item.children, currentPath);
                });
            }
            traverse(docData, '');
            renderSearchResults(results);
        }

        function renderSearchResults(results) {
            listContainer.style.display = 'none';
            searchResultContainer.style.display = 'block';
            if (results.length === 0) {
                searchResultContainer.innerHTML = '';
                noResult.style.display = 'block';
                return;
            }
            noResult.style.display = 'none';
            let html = '';
            results.forEach(res => {
                html += `
                    <div class="result-card" onclick="jumpTo('${res.targetId}')">
                        <div class="result-path">ğŸ“‚ ${res.path}</div>
                        <div class="result-text">${res.html}</div>
                    </div>
                `;
            });
            searchResultContainer.innerHTML = html;
        }

        // 5. ì í”„ & ë³µê·€
        window.jumpTo = function(targetId) {
            lastScrollPosition = window.scrollY;
            showMainTree();
            backToSearchBtn.style.display = 'grid';

            const targetEl = document.getElementById(targetId);
            if (!targetEl) return;

            let parent = targetEl.parentElement;
            while (parent) {
                if (parent.tagName === 'DETAILS') parent.open = true;
                parent = parent.parentElement;
            }

            const offset = 140;
            const elementPosition = targetEl.getBoundingClientRect().top + window.scrollY;
            const offsetPosition = elementPosition - offset;

            window.scrollTo({ top: offsetPosition, behavior: 'smooth' });

            targetEl.classList.add('flash-target');
            setTimeout(() => targetEl.classList.remove('flash-target'), 2000);
        };

        backToSearchBtn.addEventListener('click', () => {
            listContainer.style.display = 'none';
            searchResultContainer.style.display = 'block';
            backToSearchBtn.style.display = 'none';
            window.scrollTo({ top: lastScrollPosition, behavior: 'auto' });
        });

        function highlightText(html, keywords) {
            let tempHtml = html;
            keywords.forEach(k => {
                const regex = new RegExp(`(${escapeRegExp(k)})`, 'gi');
                tempHtml = tempHtml.replace(regex, '<span class="highlight">$1</span>');
            });
            return tempHtml;
        }
        function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
        
        document.getElementById('topBtn').addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>