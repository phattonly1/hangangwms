<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>ìŠ¤ë§ˆíŠ¸ ë¬¸ì„œí•¨</title>
    <style>
        :root {
            --hdr: 60px; --gap: 16px; --btn: 56px; --round: 12px;
            --bg-color: #0b1622; --card-bg: #101b2a; --text-main: #e6eef6; --text-sub: #94a3b8;
            --accent: #38bdf8; --highlight: #0ea5e9;
            --sa-t: env(safe-area-inset-top, 0px);
            --sa-b: env(safe-area-inset-bottom, 0px);
        }

        * { box-sizing: border-box; }
        html, body { margin: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); -webkit-tap-highlight-color: transparent; }

        /* 1. ì•±ë°” (ìƒë‹¨ ê³ ì •) */
        .appbar {
            position: sticky; top: 0; z-index: 100;
            height: calc(var(--hdr) + var(--sa-t));
            padding: var(--sa-t) var(--gap) 0 var(--gap);
            background: rgba(11, 22, 34, 0.85); /* ë°˜íˆ¬ëª… íš¨ê³¼ */
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between;
        }
        .appbar h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }

        /* 2. ê²€ìƒ‰ì°½ ì˜ì—­ */
        .search-wrap {
            position: sticky; top: calc(var(--hdr) + var(--sa-t)); z-index: 90;
            padding: 10px var(--gap);
            background: var(--bg-color);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        #searchInput {
            width: 100%; padding: 12px 16px;
            border-radius: var(--round); border: 1px solid rgba(255,255,255,0.15);
            background: #1e293b; color: white; font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #searchInput:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); }

        /* 3. ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ */
        #listContainer {
            padding: var(--gap);
            padding-bottom: calc(100px + var(--sa-b)); /* í•˜ë‹¨ ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            max-width: 800px; margin: 0 auto;
        }

        /* 4. í† ê¸€ ìŠ¤íƒ€ì¼ (Dark Mode) */
        details {
            background-color: var(--card-bg);
            margin-bottom: 10px; border-radius: var(--round);
            border: 1px solid rgba(255,255,255,0.08); overflow: hidden;
        }
        summary {
            padding: 14px 16px; cursor: pointer; font-weight: 600;
            list-style: none; display: flex; justify-content: space-between; align-items: center;
            color: var(--text-main); transition: background 0.2s;
        }
        summary:hover { background-color: rgba(255,255,255,0.05); }
        summary::after { content: 'â–¼'; font-size: 12px; color: var(--text-sub); transition: transform 0.3s; }
        details[open] > summary::after { transform: rotate(180deg); color: var(--accent); }
        
        /* ë‚´ìš© ë° í•˜ìœ„ ëª©ë¡ */
        .content-box { padding: 16px; background-color: rgba(0,0,0,0.2); line-height: 1.6; color: #cbd5e1; border-top: 1px solid rgba(255,255,255,0.05); font-size: 15px; white-space: pre-wrap; }
        .sub-list { border-top: 1px solid rgba(255,255,255,0.05); background-color: rgba(255,255,255,0.02); padding: 10px 0 10px 16px; }
        
        /* í•˜ì´ë¼ì´íŠ¸ & ê²°ê³¼ ì—†ìŒ */
        .highlight { background-color: rgba(14, 165, 233, 0.4); color: white; border-radius: 2px; padding: 0 2px; }
        #noResult { text-align: center; color: var(--text-sub); margin-top: 40px; display: none; }

        /* 5. ìš°í•˜ë‹¨ ë„í‚¹ (Floating Action Buttons) */
        .br-dock {
            position: fixed; z-index: 1000;
            right: var(--gap); bottom: calc(var(--gap) + var(--sa-b));
            display: flex; flex-direction: column; gap: 12px;
        }
        .fab {
            width: var(--btn); height: var(--btn);
            display: grid; place-items: center;
            border: none; border-radius: 50%; cursor: pointer;
            background: #1e293b; color: var(--text-main);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            font-size: 20px; transition: transform 0.2s, background 0.2s;
        }
        .fab:active { transform: scale(0.92); }
        .fab--main { background: var(--accent); color: #0f1725; font-weight: bold; }

        /* 6. í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast {
            position: fixed; z-index: 1200;
            left: 50%; bottom: calc(var(--gap) + var(--sa-b) + var(--btn) + 20px);
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #fff;
            border-radius: 20px; padding: 10px 20px; font-size: 14px;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; white-space: nowrap;
        }
        .toast.show { opacity: 1; }
        /* 7. Timeline Style for steps (ê¸°ì¡´ í™”ì‚´í‘œ ìŠ¤íƒ€ì¼) */
        .timeline { list-style: none; padding: 0; margin: 10px 0 0 0; position: relative; }
        .timeline-item {
            position: relative; /* For the ::before line */
            display: flex;
            align-items: flex-start; /* Vertically align top of number and text */
            gap: 12px; /* Space between number and text */
        }
        .timeline-item:not(:last-child) { padding-bottom: 20px; }
        .timeline-item:not(:last-child)::before { content: ''; position: absolute; left: 12px; top: 26px; /* Adjust top position */ width: 2px; height: 100%; background-color: var(--accent); opacity: 0.3; }
        .timeline-number {
            flex-shrink: 0; /* Prevent circle from shrinking */
            width: 26px; height: 26px; border-radius: 50%; background-color: var(--accent); color: var(--bg-color); display: grid; place-items: center; font-size: 14px; font-weight: bold;
        }
        .timeline-text {
            padding-top: 3px; /* Fine-tune vertical alignment */
        }
            ul, li {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            ul, ol {
                padding-left: 1.5rem;
                margin-block-start: 0.5rem;
                margin-block-end: 0.5rem;
            }

            .list-item {
                padding: 8px 12px;
                border-bottom: 1px solid #eee;
                cursor: pointer;
                display: flex;
                align-items: center;
                transition: background-color 0.2s;
            }
        
        /* 8. ìƒˆë¡œ ì¶”ê°€ëœ ìˆœì„œë„(Flowchart) ìŠ¤íƒ€ì¼ */
        /* ìˆœì„œë„ ìŠ¤íƒ€ì¼ ì»¨í…Œì´ë„ˆ */
        .flowchart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            width: 100%;
        }

        .flow-step {
            background-color: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-main);
            border-radius: 8px;
            padding: 12px 20px;
            margin: 15px 0; /* ìœ„ì•„ë˜ ê°„ê²© */
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            min-width: 140px;
            position: relative;
            font-size: 14px;
            font-weight: 600;
        }

        /* ë‹¨ê³„ë³„ í¬ì¸íŠ¸ ì»¬ëŸ¬ */
        .flow-step.start { border-color: var(--accent); color: var(--accent); }
        .flow-step.process { border-color: rgba(255,255,255,0.3); }
        
        /* ë§ˆë¦„ëª¨ (ë¶„ê¸°ì ) ìŠ¤íƒ€ì¼: ë†’ì´ê°€ ë‚®ì€ ë§ˆë¦„ëª¨ (clip-path ì‚¬ìš©) */
        .flow-step.decision {
            border: none; /* ê¸°ì¡´ border ì œê±° */
            background-color: var(--card-bg);
            color: #f59e0b;
            width: 180px;
            min-height: 80px;
            position: relative; 
            z-index: 10; /* ìš°ì„ ìˆœìœ„ í™•ë³´ */
            
            /* ë§ˆë¦„ëª¨ ìƒì„± */
            -webkit-clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            
            /* í…Œë‘ë¦¬ (0 0 0 3px #f59e0b) + ê·¸ë¦¼ì (0 4px 6px rgba(0,0,0,0.3)) ë°˜ì˜ */
            box-shadow: 0 0 0 3px #f59e0b, 0 4px 6px rgba(0,0,0,0.3); 
            
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin-top: 25px; 
            margin-bottom: 25px; 
        }

        /* í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ì€ ë™ì¼ */
        .flow-step.decision > span {
            display: block;
            padding: 10px;
            text-align: center;
            line-height: 1.4;
            max-width: 90%;
            font-weight: 600;
        }

        /* ë¶„ê¸°ì  ì•„ë˜ ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° */
        .flow-step.decision::after {
            display: none;
        }

        /* í™”ì‚´í‘œ ê·¸ë¦¬ê¸° (::after) */
        .flow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -27px; /* í™”ì‚´í‘œ ìœ„ì¹˜ ì¡°ì • (marginê³¼ ì—°ë™) */
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 12px solid var(--text-sub); /* í™”ì‚´í‘œ ìƒ‰ìƒ */
            z-index: 1;
        }
        
        /* ë³‘ë ¬ êµ¬ê°„ ì»¨í…Œì´ë„ˆ */
        .flow-parallel-branches {
            display: flex;
            justify-content: center;
            gap: 40px;
            width: 100%;
            position: relative;
            padding-top: 10px; 
            margin-top: 10px; /* ë§ˆë¦„ëª¨ì™€ ë³‘ë ¬ì„  ì‚¬ì´ ê°„ê²© í™•ë³´ (ì¶•ì†Œ) */
        }

        /* ë³‘ë ¬ ë¶„ê¸° ì—°ê²°ì„  (ìƒë‹¨ ê°€ë¡œì„ ) - ì„ íƒì‚¬í•­ */
        .flow-parallel-branches::before {
            content: '';
            position: absolute;
            top: -30px; /* ë§ˆë¦„ëª¨ì˜ ì•„ë˜ìª½ ëì— ì—°ê²°ë˜ë„ë¡ ë†’ì´ ì¡°ì • */
            left: 50%;
            transform: translateX(-50%);
            height: 20px;
            width: 2px;
            background-color: var(--text-sub);
            opacity: 0.8;
            z-index: 1; 
        }
        /* ì—°ê²°ì„  ì¤‘ì•™ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” ì„  */
        .flow-parallel-branches::after {
            content: '';
            position: absolute;
            top: -10px; 
            left: 20%; 
            right: 20%;
            height: 2px;
            background-color: var(--text-sub);
            opacity: 0.8;
        }

        .flow-branch {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }
        
        /* ë³‘ë ¬ êµ¬ê°„ ë‚´ë¶€ì˜ ë§ˆì§€ë§‰ ìš”ì†Œ í™”ì‚´í‘œ ì œê±° */
        .flow-branch .flow-step:last-child::after {
            display: none;
        }

    </style>
</head>
<body>

    <header class="appbar">
        <h1>ğŸ“‚ ìŠ¤ë§ˆíŠ¸ ë¬¸ì„œí•¨</h1>
        <div style="font-size: 14px; color: var(--text-sub);" id="docCount">0ê±´</div>
    </header>

    <div class="search-wrap">
        <input type="text" id="searchInput" placeholder="ì œëª©, ë‚´ìš© ê²€ìƒ‰..." autocomplete="off">
    </div>

    <main id="listContainer">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</main>
    <div id="noResult">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>

    <div class="br-dock">
        <button class="fab" id="topBtn" title="ìœ„ë¡œ ì´ë™">â¬†</button>
        <button class="fab fab--main" id="toggleAllBtn" title="ëª¨ë‘ í¼ì¹˜ê¸°/ì ‘ê¸°">ğŸ“‚</button>
    </div>

    <div class="toast" id="toast">ì•Œë¦¼</div>

    <script>
        let docData = [];
        let isAllExpanded = false; // ì „ì²´ í¼ì¹¨ ìƒíƒœ í† ê¸€ìš©
        const listContainer = document.getElementById('listContainer');
        const noResult = document.getElementById('noResult');
        const docCount = document.getElementById('docCount');

        // 1. ë°ì´í„° ë¡œë“œ (data.jsonì—ì„œ ë¶ˆëŸ¬ì˜´)
        fetch('data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                docData = data;
                renderTree(); 
                docCount.textContent = `ì´ ${countItems(data)}ê°œ`;
                toast('ë°ì´í„° ë¡œë“œ ì™„ë£Œ âœ…');
            })
            .catch(error => {
                console.error('ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                listContainer.innerHTML = '<div style="text-align:center; color: tomato; padding: 40px;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: data.json íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.</div>';
            });

        // 2. ê²€ìƒ‰ ì´ë²¤íŠ¸
        document.getElementById('searchInput').addEventListener('input', function() {
            const keyword = this.value.trim();
            renderTree(keyword);
        });

        // 3. ì¬ê·€ì  íŠ¸ë¦¬ ìƒì„± í•¨ìˆ˜ (ì´ì „ ë¡œì§ ìœ ì§€ + ë””ìì¸ ì ìš©)
        function buildTreeHTML(items, keyword) {
            let html = '';
            let hasMatchInLevel = false;

            items.forEach(item => {
                const lowerKeyword = keyword ? keyword.toLowerCase() : '';
                const isTitleMatch = item.title.toLowerCase().includes(lowerKeyword);
                const isContentMatch = item.content && item.content.toLowerCase().includes(lowerKeyword);
                
                let childrenResult = { html: '', hasMatch: false };
                if (item.children) {
                    childrenResult = buildTreeHTML(item.children, keyword);
                }

                if (keyword === '' || isTitleMatch || isContentMatch || childrenResult.hasMatch) {
                    hasMatchInLevel = true;
                    
                    let displayTitle = keyword ? highlightText(item.title, keyword) : item.title;
                    const isOpen = (keyword !== '' && (childrenResult.hasMatch || isTitleMatch || isContentMatch)) || isAllExpanded ? 'open' : '';

                    html += `<details ${isOpen}>`;
                    html += `<summary>${displayTitle}</summary>`;
                    
                    if (item.content) {
                        let displayContent;
                        // [ë³€ê²½] í´ë˜ìŠ¤ëª… ìˆ˜ì •: flow-chart-container -> flowchart-container
                        if (item.content.includes('<div class="flowchart-container">')) {
                            displayContent = item.content;
                            if (keyword) {
                                // [ë³€ê²½] í´ë˜ìŠ¤ëª… ìˆ˜ì •
                                displayContent = highlightTextInFlowContainer(displayContent, keyword, '.flowchart-container');
                            }
                        }
                        // í™”ì‚´í‘œ(â†’)ê°€ í¬í•¨ëœ ì½˜í…ì¸ ë¥¼ íƒ€ì„ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ë³€í™˜ (flow-containerê°€ ì—†ëŠ” ê²½ìš°ë§Œ)
                        else if (item.content.includes('â†’')) {
                            const steps = item.content.split('â†’').map(step => step.trim()).filter(step => step);
                            let listHtml = '<ol class="timeline">';
                            steps.forEach((step, index) => {
                                const highlightedStep = keyword ? highlightText(step, keyword) : step;
                                listHtml += `<li class="timeline-item">
                                                <span class="timeline-number">${index + 1}</span>
                                                <span class="timeline-text">${highlightedStep}</span>
                                             </li>`;
                            });
                            listHtml += '</ol>';
                            displayContent = listHtml;
                        } else {
                            displayContent = keyword ? highlightText(item.content, keyword) : item.content;
                        }
                        html += `<div class="content-box">${displayContent}</div>`;
                    }
                    
                    if (item.children) {
                        html += `<div class="sub-list">${childrenResult.html}</div>`;
                    }
                    html += `</details>`;
                }
            });
            return { html, hasMatch: hasMatchInLevel };
        }

        function renderTree(keyword = '') {
            const result = buildTreeHTML(docData, keyword);
            listContainer.innerHTML = result.html;
            noResult.style.display = (result.html === '') ? 'block' : 'none';
        }

        function highlightText(text, keyword) {
            const regex = new RegExp(`(${keyword})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // íŠ¹ì • ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ í…ìŠ¤íŠ¸ì™€ ì™¸ë¶€ì˜ í…ìŠ¤íŠ¸ë¥¼ êµ¬ë¶„í•˜ì—¬ í•˜ì´ë¼ì´íŠ¸ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
        function highlightTextInFlowContainer(htmlContent, keyword, containerClass) {
            // ì»¨í…Œì´ë„ˆ ë‹«ëŠ” íƒœê·¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
            const closingTag = '</div>';
            const containerIndex = htmlContent.indexOf(containerClass);
            const closeIndex = htmlContent.indexOf(closingTag, containerIndex) + closingTag.length;

            if (containerIndex === -1 || closeIndex === closingTag.length - 1) {
                return highlightText(htmlContent, keyword); // ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ì¼ë°˜ ì²˜ë¦¬
            }

            const flowContainerPart = htmlContent.substring(0, closeIndex);
            const restOfContent = htmlContent.substring(closeIndex); 

            // 1. flow-chart-container ë‚´ë¶€ í…ìŠ¤íŠ¸ì— í•˜ì´ë¼ì´íŠ¸ ì ìš©
            let tempDiv = document.createElement('div');
            tempDiv.innerHTML = flowContainerPart;
            tempDiv.querySelectorAll('.flow-step').forEach(element => {
                // flow-step ë‚´ë¶€ì˜ í…ìŠ¤íŠ¸ë§Œ í•˜ì´ë¼ì´íŠ¸
                element.innerHTML = highlightText(element.innerHTML, keyword);
            });
            let highlightedHtml = tempDiv.innerHTML;

            // 2. ë‚˜ë¨¸ì§€ í…ìŠ¤íŠ¸ì— í•˜ì´ë¼ì´íŠ¸ ì ìš©
            highlightedHtml += highlightText(restOfContent, keyword);

            return highlightedHtml;
        }


        function countItems(items) {
            let count = 0;
            items.forEach(item => {
                count++;
                if(item.children) count += countItems(item.children);
            });
            return count;
        }

        // 4. í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¨ìˆ˜ (ì§€ë„ ì•±ì—ì„œ ê°€ì ¸ì˜´)
        const toast = (m, ms=1500) => { 
            const t = document.getElementById('toast'); 
            t.textContent = m; 
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), ms); 
        };

        // 5. ìš°í•˜ë‹¨ ë²„íŠ¼ ê¸°ëŠ¥ êµ¬í˜„
        
        // (1) ë§¨ ìœ„ë¡œ ì´ë™
        document.getElementById('topBtn').addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // (2) ëª¨ë‘ í¼ì¹˜ê¸°/ì ‘ê¸°
        document.getElementById('toggleAllBtn').addEventListener('click', () => {
            isAllExpanded = !isAllExpanded;
            // ê²€ìƒ‰ì–´ê°€ ìˆëŠ” ìƒíƒœë¼ë©´ ê²€ìƒ‰ì–´ë¥¼ ìœ ì§€í•˜ë©´ì„œ ì¬ë Œë”ë§
            const currentKeyword = document.getElementById('searchInput').value.trim();
            renderTree(currentKeyword);
            
            const msg = isAllExpanded ? 'ëª¨ë‘ í¼ì³¤ìŠµë‹ˆë‹¤ ğŸ“–' : 'ëª¨ë‘ ì ‘ì—ˆìŠµë‹ˆë‹¤ ğŸ“•';
            toast(msg);
        });

    </script>
</body>
</html>